<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Resgate & Extrato ‚Ä¢ Mercatto</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0b0b0b;
  --card:#141414;
  --gold:#d4af37;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
body{background:var(--bg);color:#fff;padding:20px}
.hidden{display:none}

.card{
  max-width:960px;
  margin:20px auto;
  background:var(--card);
  border:1px solid var(--gold);
  border-radius:16px;
  padding:24px;
}

input,button{
  width:100%;
  padding:14px;
  margin-bottom:12px;
  background:#111;
  border:1px solid var(--gold);
  color:#fff;
  border-radius:12px;

  /* üîí */
  autocomplete:off;
  autocorrect:off;
  autocapitalize:off;
  spellcheck:false;
}

button{
  background:var(--gold);
  color:#000;
  font-weight:800;
  cursor:pointer;
}

.box{
  background:#181818;
  border-left:4px solid var(--gold);
  padding:14px;
  border-radius:12px;
  margin-top:12px;
}

@media print{
  body{background:#fff;color:#000}
  .no-print{display:none}
  .via{
    width:80mm;
    font-family:monospace;
    font-size:12px;
    page-break-after:always;
  }
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginCard" class="card">
  <h2>Acesso Operador</h2>
  <input id="loginUser" placeholder="Usu√°rio">
  <input id="loginPass" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">
<div class="card">

<h1>Consulta & Resgate</h1>

<input id="busca" placeholder="CPF ou C√≥digo">
<button onclick="consultar()">Consultar</button>

<div id="resumo" class="hidden"></div>

</div>
</div>

<script>
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

let operador=null;
let consultaAtual=null;
let evtSource=null;

/* LOGIN */
async function login(){
  const {data}=await sb.from("usuarios")
    .select("usuario")
    .eq("usuario",loginUser.value)
    .eq("senha",loginPass.value);

  if(!data.length){alert("Acesso inv√°lido");return;}

  operador=data[0].usuario;
  loginUser.value="";
  loginPass.value="";
  loginCard.classList.add("hidden");
  sistema.classList.remove("hidden");
}

/* CONSULTA */
async function consultar(){
  resumo.innerHTML="";
  resumo.classList.add("hidden");

  const q=busca.value.replace(/\D/g,"");
  consultaAtual=q;

  const {data}=await sb.from("vouchers")
    .select("*")
    .or(`cpf.eq.${q},codigo.eq.${q}`)
    .order("data_emissao",{ascending:true});

  if(!data.length){
    resumo.innerHTML="<div class='box'>Nada encontrado</div>";
    resumo.classList.remove("hidden");
    return;
  }

  renderResumo(data);
  iniciarSSE(q);
}

/* RENDER */
function renderResumo(vouchers){
  const saldo=vouchers.reduce((s,v)=>s+Number(v.saldo),0);

  resumo.innerHTML=`
    <div class="box">
      <h2>Saldo Total</h2>
      <h1>R$ ${saldo.toLocaleString("pt-BR",{minimumFractionDigits:2})}</h1>
    </div>

    ${vouchers.map(v=>`
      <div class="box">
        C√≥digo: ${v.codigo}<br>
        Saldo: R$ ${Number(v.saldo).toLocaleString("pt-BR",{minimumFractionDigits:2})}
      </div>
    `).join("")}
  `;

  resumo.classList.remove("hidden");
}

/* SSE */
function iniciarSSE(chave){
  if(evtSource) evtSource.close();

  evtSource=new EventSource(`/api/sse-resgates?chave=${chave}`);

  evtSource.onmessage=e=>{
    if(e.data==="update" && consultaAtual===chave){
      consultar();
    }
  };
}

/* IMPRESS√ÉO */
function imprimirTermica(v,valor){
  const html=`
  <div class="via">
    <center><b>MERCATTO DEL√çCIA</b><br>VIA CLIENTE</center><br>
    C√≥digo:${v.codigo}<br>
    Valor:R$ ${valor.toLocaleString("pt-BR",{minimumFractionDigits:2})}<br>
    Operador:${operador}<br>
    ${new Date().toLocaleString("pt-BR")}
  </div>

  <div class="via">
    <center><b>MERCATTO DEL√çCIA</b><br>VIA RESTAURANTE</center><br>
    C√≥digo:${v.codigo}<br>
    Valor:R$ ${valor.toLocaleString("pt-BR",{minimumFractionDigits:2})}<br>
    Operador:${operador}<br>
    ${new Date().toLocaleString("pt-BR")}
  </div>
  `;
  const w=window.open("");
  w.document.write(`<body>${html}</body>`);
  w.document.close();
  w.onload=()=>{w.print();w.close();}
}
</script>

</body>
</html>

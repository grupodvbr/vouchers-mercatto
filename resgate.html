<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Resgate de Voucher • Mercatto Delícia</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#000;
  --card:#111;
  --gold:#d4af37;
  --gold2:#b48a2b;
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
body{background:#000;color:#fff;padding:24px}
.hidden{display:none}

/* CARD */
.card{
  max-width:960px;
  margin:auto;
  background:linear-gradient(180deg,#111,#0d0d0d);
  border:1px solid var(--gold2);
  border-radius:var(--radius);
  padding:26px;
}

/* INPUTS */
input,button{
  width:100%;
  padding:14px;
  margin-bottom:12px;
  background:#1a1a1a;
  border:1px solid var(--gold2);
  color:#fff;
  border-radius:10px;
  font-size:15px;
  autocomplete:off;
  autocorrect:off;
  autocapitalize:off;
  spellcheck:false;
}
button{
  background:linear-gradient(135deg,#b48a2b,#d4af37);
  color:#000;
  font-weight:800;
  cursor:pointer;
}

/* RESULTADOS */
.box{
  background:#121212;
  padding:14px;
  border-left:4px solid var(--gold);
  margin-top:14px;
  border-radius:10px;
}
.badge{
  display:inline-block;
  font-size:12px;
  padding:4px 10px;
  border-radius:20px;
  font-weight:800;
}
.ATIVO{background:#1f7a4a}
.PARCIAL{background:#9a6b00}
.RESGATADO{background:#8a1f1f}

/* IMPRESSÃO TÉRMICA */
@media print{
  @page{size:80mm auto;margin:0}
  html,body{
    width:80mm;margin:0;padding:0;
    background:#fff!important;color:#000!important;
    font-family:monospace!important;font-size:12px;
  }
  body *{visibility:hidden}
  .print-area,.print-area *{visibility:visible}
  .print-area{position:absolute;left:0;top:0;width:80mm}
  .via{padding:6mm 4mm;page-break-after:always}
  .titulo{text-align:center;font-weight:bold;margin-bottom:6px}
  .sep{border-top:1px dashed #000;margin:6px 0}
  .assinatura{margin-top:16px;border-top:1px solid #000;padding-top:4px;text-align:center}
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginCard" class="card">
  <h2 style="color:#d4af37">Acesso Operador</h2>
  <input id="loginUser" placeholder="Usuário">
  <input id="loginPass" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">
<div class="card">

<h2 style="color:#d4af37">Resgate de Voucher</h2>

<input id="busca" placeholder="CPF ou Código do Voucher">
<button onclick="consultar()">Consultar</button>

<div id="resultado"></div>

</div>
</div>

<div id="printArea" class="print-area hidden"></div>

<script>
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

let operador=null;
let vouchers=[];

/* LOGIN */
async function login(){
  const {data}=await sb.from("usuarios")
    .select("usuario")
    .eq("usuario",loginUser.value)
    .eq("senha",loginPass.value);
  if(!data.length){alert("Acesso inválido");return;}
  operador=data[0].usuario;
  loginCard.classList.add("hidden");
  sistema.classList.remove("hidden");
}

/* CONSULTA */
async function consultar(){
  resultado.innerHTML="";
  vouchers=[];
  const q=busca.value.replace(/\D/g,"");

  const {data}=await sb.from("vouchers")
    .select("*")
    .or(`codigo.eq.${q},cpf.eq.${q}`)
    .order("data_emissao",{ascending:true});

  if(!data.length){
    resultado.innerHTML="<div class='box'>Nada encontrado</div>";
    return;
  }

  vouchers=data;
  const saldoTotal=vouchers.reduce((s,v)=>s+Number(v.saldo),0);

  resultado.innerHTML=`
    <div class="box">
      <b>CPF:</b> ${vouchers[0].cpf}<br>
      <b>Saldo Total:</b> R$ ${saldoTotal.toLocaleString("pt-BR",{minimumFractionDigits:2})}
    </div>

    ${vouchers.map(v=>`
      <div class="box">
        <b>Código:</b> ${v.codigo}<br>
        Saldo: R$ ${Number(v.saldo).toLocaleString("pt-BR",{minimumFractionDigits:2})}<br>
        <span class="badge ${v.status}">${v.status}</span><br><br>
        ${v.saldo>0?`<button onclick="resgatar('${v.codigo}')">Resgatar</button>`:""}
      </div>
    `).join("")}
  `;
}

/* RESGATE */
async function resgatar(codigo){
  const v=vouchers.find(x=>x.codigo===codigo);
  if(!v||v.saldo<=0)return;

  let valor=prompt(`Saldo disponível: R$ ${v.saldo.toLocaleString("pt-BR",{minimumFractionDigits:2})}`);
  if(!valor)return;

  valor=parseFloat(valor.replace(".","").replace(",","."));
  if(valor<=0||valor>v.saldo){alert("Valor inválido");return;}

  const novoSaldo=v.saldo-valor;
  const status=novoSaldo===0?"RESGATADO":"PARCIAL";

  await sb.from("vouchers").update({
    saldo:novoSaldo,
    valor_resgatado:(v.valor_resgatado||0)+valor,
    status
  }).eq("codigo",codigo);

  await sb.from("vouchers_movimentos").insert([{
    codigo_voucher:codigo,
    tipo:"RESGATE",
    valor:-valor,
    operador,
    descricao:"Resgate de voucher"
  }]);

  imprimirTermica(v,valor);
  consultar();
}

/* IMPRESSÃO */
function imprimirTermica(v,valor){
  const agora=new Date().toLocaleString("pt-BR");
  const cpfMasc=v.cpf.substring(0,3)+"***";

  printArea.innerHTML=`
    <div class="via">
      <div class="titulo">MERCATTO DELÍCIA</div>
      <div class="titulo">VIA DO CLIENTE</div>
      <div class="sep"></div>
      CPF: ${v.cpf}<br>
      Código: ${v.codigo}<br>
      Valor: R$ ${valor.toLocaleString("pt-BR",{minimumFractionDigits:2})}<br>
      Data: ${agora}
    </div>

    <div class="via">
      <div class="titulo">MERCATTO DELÍCIA</div>
      <div class="titulo">VIA DO RESTAURANTE</div>
      <div class="sep"></div>
      CPF: ${cpfMasc}<br>
      Valor: R$ ${valor.toLocaleString("pt-BR",{minimumFractionDigits:2})}<br>
      <div class="assinatura">Assinatura do Cliente</div>
    </div>
  `;
  printArea.classList.remove("hidden");
  window.print();
  setTimeout(()=>printArea.classList.add("hidden"),500);
}
</script>

</body>
</html>

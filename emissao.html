<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher Mercatto ‚Ä¢ Emiss√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
:root{
  --gold:#d4af37;
  --bg:#000;
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:Inter;
}

body{
  background:#000;
  color:#fff;
  padding:20px;
}

input,select,button{
  width:100%;
  padding:14px;
  margin-bottom:12px;
  background:#111;
  color:#fff;
  border:1px solid var(--gold);
  border-radius:10px;

  /* üîí SEGURAN√áA */
  autocomplete:off;
  autocorrect:off;
  autocapitalize:off;
  spellcheck:false;
}

button{
  background:linear-gradient(135deg,#b48a2b,#d4af37);
  color:#000;
  font-weight:900;
  cursor:pointer;
}

.hidden{display:none}

/* ================= IMPRESS√ÉO T√âRMICA ================= */
@media print{
  body{background:#fff;color:#000}
  .no-print{display:none}
  .via{
    width:80mm;
    font-family:monospace;
    font-size:12px;
    page-break-after:always;
  }
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginCard">
  <h2>Acesso Operador</h2>
  <input id="loginUser" placeholder="Usu√°rio">
  <input id="loginPass" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">

  <h2>Emiss√£o de Voucher</h2>

  <input id="cliente" placeholder="Nome do Cliente">
  <input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
  <input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
  <input id="valor" placeholder="Valor" oninput="maskValor(this)">
  
  <select id="formaPagamento">
    <option value="" disabled selected>Forma de Pagamento</option>
    <option>PIX</option>
    <option>DINHEIRO</option>
    <option>CART√ÉO CR√âDITO</option>
    <option>CART√ÉO D√âBITO</option>
  </select>

  <button onclick="emitir()">Emitir e Imprimir</button>

</div>

<script>
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

let operador=null;

/* LOGIN ‚Äî NADA √â GUARDADO */
async function login(){
  const {data}=await sb
    .from("usuarios")
    .select("usuario")
    .eq("usuario",loginUser.value)
    .eq("senha",loginPass.value);

  if(!data.length){ alert("Acesso inv√°lido"); return; }

  operador=data[0].usuario;
  loginCard.classList.add("hidden");
  sistema.classList.remove("hidden");

  loginUser.value="";
  loginPass.value="";
}

/* EMISS√ÉO */
async function emitir(){
  const nome=cliente.value.trim();
  const cpfv=cpf.value.replace(/\D/g,"");
  const tel=telefone.value;
  const valorNum=parseFloat(valor.dataset.raw||0);
  const forma=formaPagamento.value;

  if(!nome||!cpfv||!valorNum||!forma){
    alert("Preencha todos os campos");
    return;
  }

  const codigo=Math.floor(100000000+Math.random()*900000000);
  const validade=new Date();
  validade.setDate(validade.getDate()+60);

  await sb.from("vouchers").insert([{
    codigo,
    cliente:nome,
    cpf:cpfv,
    telefone:tel,
    valor:valorNum,
    saldo:valorNum,
    forma_pagamento:forma,
    usuario_emissao:operador,
    status:"ATIVO"
  }]);

  imprimirTermica(nome,cpfv,codigo,valorNum,forma,operador,validade);
}

/* IMPRESS√ÉO T√âRMICA ‚Äî 2 VIAS + CORTE */
function imprimirTermica(nome,cpf,codigo,valor,forma,emissor,validade){
  const html=`
  <div class="via">
    <center><b>MERCATTO DEL√çCIA</b><br>VIA DO CLIENTE</center><br>
    Cliente:${nome}<br>
    CPF:${cpf}<br>
    C√≥digo:${codigo}<br>
    Valor:R$ ${valor.toLocaleString("pt-BR",{minimumFractionDigits:2})}<br>
    Pagamento:${forma}<br>
    Emissor:${emissor}<br>
    Validade:${validade.toLocaleDateString("pt-BR")}
  </div>

  <div class="via">
    <center><b>MERCATTO DEL√çCIA</b><br>VIA RESTAURANTE</center><br>
    Cliente:${nome}<br>
    CPF:${cpf}<br>
    C√≥digo:${codigo}<br>
    Valor:R$ ${valor.toLocaleString("pt-BR",{minimumFractionDigits:2})}<br>
    Pagamento:${forma}<br>
    Emissor:${emissor}<br>
    Validade:${validade.toLocaleDateString("pt-BR")}
  </div>
  `;

  const w=window.open("","_blank");
  w.document.write(`<html><body>${html}</body></html>`);
  w.document.close();
  w.onload=()=>{w.print();w.close();}
}

/* M√ÅSCARAS */
function maskCPF(e){
  e.value=e.value.replace(/\D/g,"")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}

function maskPhone(e){
  e.value=e.value.replace(/\D/g,"")
    .replace(/(\d{2})(\d)/,"($1) $2")
    .replace(/(\d{5})(\d)/,"$1-$2");
}

function maskValor(e){
  let v=e.value.replace(/\D/g,"");
  let num=(v/100)||0;
  e.dataset.raw=num;
  e.value=num.toLocaleString("pt-BR",{minimumFractionDigits:2});
}
</script>

</body>
</html>

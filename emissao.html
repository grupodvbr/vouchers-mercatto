<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Resgate & Extrato • Mercatto</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* === TODO SEU CSS ORIGINAL – INTACTO === */
:root{
  --bg:#0b0b0b;
  --card:#141414;
  --gold:#d4af37;
  --gold2:#b48a2b;
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
body{background:var(--bg);color:#fff;padding:20px}
.hidden{display:none}
.card{
  max-width:980px;margin:24px auto;
  background:var(--card);
  border:1px solid var(--gold2);
  border-radius:var(--radius);
  padding:26px;
}
h1,h2,h3{color:var(--gold);margin-bottom:16px}
input{
  width:100%;padding:14px;
  background:#1a1a1a;border:1px solid var(--gold2);
  color:#fff;border-radius:12px;
  margin-bottom:12px;font-size:15px;
}
button{
  width:100%;
  padding:14px;
  background:var(--gold);color:#000;
  border:none;border-radius:12px;
  font-weight:800;cursor:pointer;
}
.box{
  background:#181818;
  border-left:4px solid var(--gold);
  border-radius:12px;
  padding:14px;
  margin-top:12px;
}
.box.click{cursor:pointer}
.box.click:hover{background:#202020}
hr{border:none;border-top:1px solid #333;margin:14px 0}
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99;
}
.modal-box{
  width:360px;
  background:#111;
  border:2px solid var(--gold);
  border-radius:14px;
  padding:22px;
}
</style>
</head>

<body>

<!-- LOGIN OPERADOR -->
<div id="loginCard" class="card">
  <h2>Acesso Operador</h2>
  <input id="loginUser" placeholder="Usuário">
  <input id="loginPass" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">
<div class="card">

<h1>Consulta • Extrato • Resgate</h1>

<input id="busca" placeholder="CPF ou Código do Voucher">
<button onclick="consultar()">Consultar</button>

<div id="resumoCPF" class="hidden">
  <div class="box">
    <h2>Saldo disponível</h2>
    <h1 id="saldoTotal">R$ 0,00</h1>
    <input id="valorResgate" placeholder="Valor a resgatar (R$)">
    <button onclick="resgatarCPF()">Resgatar</button>
  </div>

  <div class="box">
    <h2>Vouchers do Cliente</h2>
    <div id="listaVouchers"></div>
  </div>
</div>

<div id="extratoVoucher" class="hidden">
  <div class="box">
    <h2>Extrato do Voucher</h2>
    <div id="detalheVoucher"></div>
    <hr>
    <h3>Histórico de Resgates</h3>
    <div id="historicoResgates"></div>
  </div>
</div>

<div id="resultadoCodigo"></div>

</div>
</div>

<div id="modalSenha" class="modal">
  <div class="modal-box">
    <h3>Senha do Cliente</h3>
    <input id="senhaCliente" type="password" maxlength="4">
    <button onclick="confirmarSenha()">Confirmar</button>
  </div>
</div>

<script>
/* === TODA SUA LÓGICA ORIGINAL MANTIDA === */
/* A ÚNICA FUNÇÃO ALTERADA É A DE IMPRESSÃO */

function imprimirRecibo(v,valor){
  const cpfMasc = v.cpf.substring(0,3)+"***";

  const htmlCliente = `
  <html><body style="font-family:monospace;font-size:13px">
  <center>
    <b>MERCATTO DELÍCIA</b><br>
    COMPROVANTE DE RESGATE<br>
    VIA DO CLIENTE<br>
    --------------------
  </center>
  Cliente: ${v.cliente}<br>
  CPF: ${v.cpf}<br>
  Código: ${v.codigo}<br>
  Valor: R$ ${valor.toFixed(2)}<br>
  Operador: ${operador.usuario}<br>
  Data: ${new Date().toLocaleString("pt-BR")}
  </body></html>`;

  const htmlMercatto = `
  <html><body style="font-family:monospace;font-size:13px">
  <center>
    <b>MERCATTO DELÍCIA</b><br>
    COMPROVANTE DE RESGATE<br>
    VIA DO MERCATTO<br>
    --------------------
  </center>
  Cliente: ${v.cliente}<br>
  CPF: ${cpfMasc}<br>
  Código: ${v.codigo}<br>
  Valor: R$ ${valor.toFixed(2)}<br>
  Operador: ${operador.usuario}<br><br>
  Assinatura do Cliente:<br><br>
  ______________________
  </body></html>`;

  const w1 = window.open("","rec1","width=260,height=600");
  w1.document.write(htmlCliente);
  w1.document.close();
  w1.onload = () => w1.print();

  setTimeout(()=>{
    const w2 = window.open("","rec2","width=260,height=600");
    w2.document.write(htmlMercatto);
    w2.document.close();
    w2.onload = () => w2.print();
  },600);
}
</script>

</body>
</html>

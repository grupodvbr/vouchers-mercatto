<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"> 
<title>Voucher Mercatto • Emissão</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --gold:#d4af37;
  --gold2:#b48a2b;
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
body{background:#000;color:#fff;padding:24px}
.hidden{display:none}

.card{
  max-width:1100px;
  margin:auto;
  background:#111;
  border:1px solid var(--gold2);
  border-radius:var(--radius);
  padding:26px;
}

input,select{
  width:100%;
  padding:14px;
  margin-bottom:14px;
  background:#1a1a1a;
  border:1px solid var(--gold2);
  border-radius:12px;
  color:#fff;
}

button{
  padding:14px 22px;
  border-radius:12px;
  border:none;
  background:var(--gold);
  color:#000;
  font-weight:800;
  cursor:pointer;
}

/* VOUCHER VISUAL */
#voucherPNG{
  width:700px;
  height:300px;
  display:none;
  margin-top:22px;
  border-radius:16px;
  overflow:hidden;
  border:3px solid var(--gold);
  background:linear-gradient(to right,#000 0%,#0a0a0a 45%,#111 45%,#fdf6e3 100%);
  position:relative;
}
</style>
</head>

<body>

<div class="card">
<h2 style="color:var(--gold)">Emissão de Voucher</h2>

<input id="cliente" placeholder="Nome do Cliente">
<input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
<input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
<input id="valor" placeholder="Valor" oninput="maskValor(this)">

<select id="formaPagamento">
  <option value="" disabled selected>Forma de Pagamento</option>
  <option>PIX</option>
  <option>DINHEIRO</option>
  <option>CARTÃO CRÉDITO</option>
  <option>CARTÃO DÉBITO</option>
</select>

<button onclick="emitir()">Emitir Voucher</button>

<!-- VOUCHER BONITO -->
<div id="voucherPNG">

  <!-- LADO ESQUERDO -->
  <div style="position:absolute;left:0;width:45%;height:100%;padding:25px;color:#fff">
    <h1 style="font-size:42px">GIFT</h1>
    <h2 style="color:var(--gold)">VOUCHER</h2>
    <p id="vNome"></p>
    <p id="vForma"></p>
  </div>

  <!-- DIVISÓRIA -->
  <div style="position:absolute;left:44%;width:90px;height:100%;
    background:linear-gradient(135deg,#b48a2b,#d4af37,#f7e7b0);
    clip-path:polygon(0 0,100% 0,70% 100%,0% 100%)">
  </div>

  <!-- LADO DIREITO -->
  <div style="position:absolute;left:50%;width:50%;height:100%;padding:35px;color:#5a4d29">
    <h1 style="font-size:70px;font-family:'Great Vibes'">
      R$ <span id="vValor"></span>
    </h1>
    <svg id="barcode"></svg>
  </div>
</div>

<br>
<button id="btnPDF" class="hidden" onclick="baixarPDF()">Baixar PDF</button>
<button id="btnWhats" class="hidden" onclick="enviarWhats()" style="background:#25d366;color:#fff">
  WhatsApp
</button>

</div>

<script>
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

let voucherAtual={};

/* GERAR CÓDIGO */
async function gerarCodigo(){
  while(true){
    let c=Math.floor(100000000+Math.random()*900000000).toString();
    let {data}=await sb.from("vouchers").select("id").eq("codigo",c);
    if(!data.length) return c;
  }
}

/* EMITIR */
async function emitir(){
  let nome=cliente.value.trim();
  let cpfv=cpf.value.replace(/\D/g,"");
  let tel=telefone.value;
  let val=(parseInt(valor.value.replace(/\D/g,""))/100).toFixed(2);
  let forma=formaPagamento.value;

  if(!nome||!cpfv||!val||!forma){
    alert("Preencha tudo"); return;
  }

  let codigo=await gerarCodigo();

  await sb.from("vouchers").insert([{
    codigo,cliente:nome,cpf:cpfv,telefone:tel,
    valor:val,saldo:val,forma_pagamento:forma,
    data_emissao:new Date().toISOString(),
    status:"ATIVO"
  }]);

  gerarVoucher(nome,val,forma,codigo);
  imprimirRecibos(nome,cpfv,codigo,val,forma);
}

/* VOUCHER */
function gerarVoucher(nome,val,forma,codigo){
  voucherAtual={nome,val,forma,codigo};

  vNome.innerHTML="<b>Cliente:</b> "+nome;
  vForma.innerHTML="<b>Pagamento:</b> "+forma;
  vValor.innerText=val;

  JsBarcode("#barcode",codigo,{width:2,height:42});

  voucherPNG.style.display="block";
  btnPDF.classList.remove("hidden");
  btnWhats.classList.remove("hidden");
}

/* RECIBOS */
function imprimirRecibos(nome,cpf,codigo,valor,forma){
  let cpfMasc=cpf.substring(0,3)+"***";

  let viaCliente=`
  <b>MERCATTO DELÍCIA</b><br>VIA DO CLIENTE<br>
  Cliente: ${nome}<br>
  CPF: ${cpf}<br>
  Código: ${codigo}<br>
  Valor: R$ ${valor}<br>
  Pagamento: ${forma}<br>
  ${new Date().toLocaleString("pt-BR")}
  `;

  let viaRest=`
  <b>MERCATTO DELÍCIA</b><br>VIA DO RESTAURANTE<br>
  Cliente: ${nome}<br>
  CPF: ${cpfMasc}<br>
  Código: ${codigo}<br>
  Valor: R$ ${valor}<br>
  ${new Date().toLocaleString("pt-BR")}
  `;

  let w=window.open("","","width=260,height=700");
  w.document.write(`
    <div style="font-family:monospace">${viaCliente}</div>
    <div style="page-break-after:always"></div>
    <div style="font-family:monospace">${viaRest}</div>
    <script>window.onload=()=>{window.print();window.close();}<\/script>
  `);
}

/* PDF */
function baixarPDF(){
  html2canvas(voucherPNG,{scale:3}).then(c=>{
    let a=document.createElement("a");
    a.download="voucher.pdf";
    a.href=c.toDataURL();
    a.click();
  });
}

/* WHATS */
function enviarWhats(){
  let msg=
    `Voucher Mercatto%0ACliente: ${voucherAtual.nome}%0AValor: R$ ${voucherAtual.val}`;
  window.open(`https://wa.me/?text=${msg}`,"_blank");
}

/* MÁSCARAS */
function maskCPF(e){e.value=e.value.replace(/\D/g,"").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2")}
function maskPhone(e){e.value=e.value.replace(/\D/g,"").replace(/(\d{2})(\d)/,"($1) $2").replace(/(\d{5})(\d)/,"$1-$2")}
function maskValor(e){let v=e.value.replace(/\D/g,"");e.value="R$ "+(v/100).toFixed(2).replace(".",",")}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Emiss√£o de Voucher ‚Ä¢ Mercatto Del√≠cia</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --bg:#000;
  --card:#111;
  --gold:#d4af37;
  --gold2:#b48a2b;
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
body{
  background:radial-gradient(circle at top,#111,#000);
  color:#fff;
  padding:24px;
}
.hidden{display:none}

/* CARD */
.card{
  max-width:1100px;
  margin:auto;
  background:linear-gradient(180deg,#111,#0d0d0d);
  border:1px solid var(--gold2);
  border-radius:var(--radius);
  padding:26px;
  box-shadow:0 20px 40px rgba(0,0,0,.6);
}

input,select{
  width:100%;
  padding:14px;
  margin-bottom:14px;
  background:#1a1a1a;
  border:1px solid var(--gold2);
  border-radius:12px;
  color:#fff;
  font-size:15px;
  autocomplete:off;
  autocorrect:off;
  autocapitalize:off;
  spellcheck:false;
}

button{border:none;cursor:pointer}

/* LOGIN */
#loginCard{max-width:420px;margin:120px auto}

/* GRID */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}

/* VOUCHER VISUAL */
#voucherPNG{
  width:720px;height:300px;
  display:none;
  margin:30px auto 10px;
  border-radius:18px;
  overflow:hidden;
  border:3px solid var(--gold);
  background:linear-gradient(to right,#000 0%,#0a0a0a 45%,#111 45%,#fdf6e3 100%);
  position:relative;
}
.v-left{position:absolute;left:0;width:45%;height:100%;padding:26px}
.v-cut{
  position:absolute;left:44%;width:90px;height:100%;
  background:linear-gradient(135deg,#b48a2b,#d4af37,#f7e7b0);
  clip-path:polygon(0 0,100% 0,70% 100%,0 100%);
}
.v-right{position:absolute;left:50%;width:50%;height:100%;padding:36px;color:#5a4d29}
.small{position:absolute;bottom:10px;left:20px;right:20px;font-size:10px;color:#ddd}

/* BOT√ïES */
.actions{display:flex;gap:14px;justify-content:center;margin-top:22px}
.btn{
  min-width:180px;
  padding:10px 18px;
  border-radius:12px;
  font-size:14px;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:center;
}
.btn-pdf{background:linear-gradient(135deg,#b48a2b,#e5c86f);color:#000}
.btn-whats{background:linear-gradient(135deg,#1ebd5a,#2de073);color:#fff}

/* IMPRESS√ÉO T√âRMICA */
@media print{
  @page{size:80mm auto;margin:0}
  html,body{
    width:80mm;margin:0;padding:0;
    background:#fff!important;color:#000!important;
    font-family:monospace!important;font-size:12px;
  }
  body *{visibility:hidden}
  .print-area,.print-area *{visibility:visible}
  .print-area{position:absolute;left:0;top:0;width:80mm}
  .via{padding:6mm 4mm;page-break-after:always}
  .titulo{text-align:center;font-weight:bold;margin-bottom:6px}
  .sep{border-top:1px dashed #000;margin:6px 0}
  .assinatura{margin-top:16px;border-top:1px solid #000;padding-top:4px;text-align:center}
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginCard" class="card">
  <h2 style="color:var(--gold)">Acesso Operador</h2>
  <input id="loginUser" placeholder="Usu√°rio">
  <input id="loginPass" type="password" placeholder="Senha">
  <button class="btn btn-pdf" style="width:100%" onclick="login()">Entrar</button>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">
<div class="card">

<h2 style="color:var(--gold)">Emiss√£o de Voucher</h2>

<div class="grid">
  <div>
    <input id="cliente" placeholder="Nome do Cliente">
    <input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
  </div>
  <div>
    <input id="valor" placeholder="Valor" oninput="maskValor(this)">
  </div>
</div>

<button class="btn btn-pdf" style="width:100%" onclick="emitir()">Emitir Voucher</button>

<!-- VOUCHER -->
<div id="voucherPNG">
  <div class="v-left">
    <h1 style="font-size:42px">GIFT</h1>
    <h2 style="color:var(--gold)">VOUCHER</h2>
    <p id="vNome"></p>
    <p id="vValidade"></p>
  </div>
  <div class="v-cut"></div>
  <div class="v-right">
    <h1 style="font-size:72px;font-family:'Great Vibes'">
      R$ <span id="vValor"></span>
    </h1>
    <svg id="barcode"></svg>
  </div>
  <div class="small" id="vTextoLegal"></div>
</div>

<div class="actions hidden" id="acoes">
  <button class="btn btn-pdf" onclick="baixarPDF()">üìÑ Baixar PDF</button>
  <button class="btn btn-whats" onclick="enviarWhats()">üí¨ WhatsApp</button>
</div>

</div>
</div>

<div id="printArea" class="print-area hidden"></div>

<script>
const sb=supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

let operador=null;
let voucherAtual={};

/* LOGIN */
async function login(){
  const {data}=await sb.from("usuarios")
    .select("usuario")
    .eq("usuario",loginUser.value)
    .eq("senha",loginPass.value);
  if(!data.length){alert("Acesso inv√°lido");return;}
  operador=data[0].usuario;
  loginCard.classList.add("hidden");
  sistema.classList.remove("hidden");
}

/* GERAR C√ìDIGO */
async function gerarCodigo(){
  while(true){
    const c=Math.floor(100000000+Math.random()*900000000).toString();
    const {data}=await sb.from("vouchers").select("id").eq("codigo",c);
    if(!data.length)return c;
  }
}

/* EMITIR */
async function emitir(){
  const nome=cliente.value.trim();
  const cpfv=cpf.value.replace(/\D/g,"");
  const valor=Number(valor.dataset.raw||0);
  if(!nome||!cpfv||!valor){alert("Dados inv√°lidos");return;}

  const codigo=await gerarCodigo();
  const d=new Date();
  const validade=new Date(d);validade.setDate(validade.getDate()+60);

  await sb.from("vouchers").insert([{
    codigo,cliente:nome,cpf:cpfv,
    valor, saldo:valor,
    status:"ATIVO",
    data_emissao:d.toISOString(),
    data_validade:validade.toISOString()
  }]);

  await sb.from("vouchers_movimentos").insert([{
    codigo_voucher:codigo,
    tipo:"EMISSAO",
    valor:valor,
    operador,
    descricao:"Emiss√£o de voucher"
  }]);

  gerarVoucher(nome,valor,codigo,validade);
  imprimirTermica(nome,cpfv,codigo,valor,validade);
}

/* VOUCHER VISUAL */
function gerarVoucher(nome,val,codigo,validade){
  voucherAtual={nome,val};
  vNome.innerHTML="<b>Cliente:</b> "+nome;
  vValidade.innerHTML="<b>V√°lido at√©:</b> "+validade.toLocaleDateString("pt-BR");
  vValor.innerText=val.toLocaleString("pt-BR",{minimumFractionDigits:2});
  vTextoLegal.innerText=`V√°lido at√© ${validade.toLocaleDateString("pt-BR")}`;
  JsBarcode("#barcode",codigo,{width:2,height:42});
  voucherPNG.style.display="block";
  acoes.classList.remove("hidden");
}

/* IMPRESS√ÉO */
function imprimirTermica(nome,cpf,codigo,valor,validade){
  const agora=new Date().toLocaleString("pt-BR");
  const cpfMasc=cpf.substring(0,3)+"***";

  printArea.innerHTML=`
    <div class="via">
      <div class="titulo">MERCATTO DEL√çCIA</div>
      <div class="titulo">VIA DO CLIENTE</div>
      <div class="sep"></div>
      Cliente: ${nome}<br>
      CPF: ${cpf}<br>
      C√≥digo: ${codigo}<br>
      Valor: R$ ${valor.toLocaleString("pt-BR",{minimumFractionDigits:2})}<br>
      Validade: ${validade.toLocaleDateString("pt-BR")}<br>
      <div class="sep"></div>
      Data: ${agora}
    </div>

    <div class="via">
      <div class="titulo">MERCATTO DEL√çCIA</div>
      <div class="titulo">VIA DO RESTAURANTE</div>
      <div class="sep"></div>
      Cliente: ${nome}<br>
      CPF: ${cpfMasc}<br>
      Valor: R$ ${valor.toLocaleString("pt-BR",{minimumFractionDigits:2})}<br>
      Validade: ${validade.toLocaleDateString("pt-BR")}<br>
      <div class="assinatura">Assinatura do Cliente</div>
    </div>
  `;
  printArea.classList.remove("hidden");
  window.print();
  setTimeout(()=>printArea.classList.add("hidden"),500);
}

/* PDF */
function baixarPDF(){
  html2canvas(voucherPNG,{scale:3}).then(c=>{
    const a=document.createElement("a");
    a.download="voucher.pdf";
    a.href=c.toDataURL();
    a.click();
  });
}

/* WHATS */
function enviarWhats(){
  window.open(`https://wa.me/?text=${encodeURIComponent(
    `Voucher Mercatto\nCliente:${voucherAtual.nome}\nValor:R$ ${voucherAtual.val.toLocaleString("pt-BR",{minimumFractionDigits:2})}`
  )}`,"_blank");
}

/* M√ÅSCARAS */
function maskCPF(e){
  e.value=e.value.replace(/\D/g,"")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}
function maskValor(e){
  const v=e.value.replace(/\D/g,"");
  const num=(v/100)||0;
  e.dataset.raw=num;
  e.value=num.toLocaleString("pt-BR",{minimumFractionDigits:2});
}
</script>

</body>
</html>

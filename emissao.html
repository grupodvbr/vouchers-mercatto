<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"> 
<title>Voucher Mercatto ‚Ä¢ Emiss√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- FONTES -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<!-- LIBS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --preto:#1a1a1a;
  --preto2:#101010;
  --gold:#f1c40f;
  --gold2:#e67e22;
  --radius:16px;
  --shadow:0 0 25px rgba(0,0,0,.6);
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
body{background:#000;color:#fff;padding:24px}
.hidden{display:none}

/* LOGIN */
#loginCard{
  width:400px;margin:110px auto;padding:28px;
  background:rgba(20,20,20,.85);
  border-radius:var(--radius);
  border:2px solid var(--gold2);
  box-shadow:var(--shadow);
}
#loginCard img{width:160px;display:block;margin:auto;margin-bottom:15px}
#loginCard input{
  width:100%;padding:14px;margin-bottom:14px;
  background:#161616;border:1px solid #6e5a1a;
  color:#fff;border-radius:12px
}
#loginCard button{
  width:100%;padding:14px;border-radius:14px;
  background:var(--gold);border:none;
  font-size:17px;font-weight:700;color:#000
}

/* SISTEMA */
.container{
  max-width:1100px;
  margin:auto;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:28px;
}
.card{
  background:rgba(15,15,15,.88);
  padding:26px;
  border-radius:var(--radius);
  border:1px solid var(--gold2);
  box-shadow:var(--shadow)
}
.card h2{color:var(--gold);margin-bottom:18px}

input,select{
  width:100%;padding:13px;margin-bottom:13px;
  border:1px solid var(--gold2);
  background:#1a1a1a;color:#fff;border-radius:12px
}
button{
  padding:13px 22px;border-radius:12px;
  background:var(--gold);color:#000;border:none;
  font-weight:700;cursor:pointer
}

/* LOADER */
#overlayLoad{
  position:fixed;inset:0;
  display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,.75);
  color:var(--gold);font-size:26px;z-index:999
}

/* =======================
   VOUCHER PREMIUM
======================= */
#voucherPNG{
  width:700px;height:300px;
  display:none;margin-top:18px;
  border-radius:16px;
  overflow:hidden;
  border:3px solid var(--gold);
  box-shadow:0 0 25px rgba(212,175,55,.45);
  position:relative;
  background:linear-gradient(to right,#000 0%,#0a0a0a 45%,#111 45%,#fdf6e3 100%);
}
</style>
</head>

<body>

<div id="overlayLoad">Processando...</div>

<!-- LOGIN -->
<div id="loginCard">
  <img src="logo.png">
  <input id="loginUser" placeholder="Usu√°rio">
  <input id="loginPass" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <p id="loginMsg" style="text-align:center;color:#ff6666;margin-top:10px;"></p>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">
<h1 style="color:var(--gold);margin-bottom:22px">
  Emiss√£o de Voucher
  <button onclick="logout()" style="float:right;background:#b02626;color:#fff">Sair</button>
</h1>

<div class="container">

<div class="card">
<h2>Emitir Voucher</h2>

<input id="cliente" placeholder="Nome do Cliente">
<input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
<input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
<input id="valor" placeholder="Valor" oninput="maskValor(this)">

<select id="formaPagamento">
  <option value="" disabled selected>Forma de Pagamento</option>
  <option>PIX</option>
  <option>DINHEIRO</option>
  <option>CART√ÉO CR√âDITO</option>
  <option>CART√ÉO D√âBITO</option>
</select>

<button onclick="emitir()">Emitir Voucher</button>

<div id="voucherPNG">

<!-- LADO ESCURO -->
<div style="position:absolute;left:0;width:45%;height:100%;padding:25px;color:white;display:flex;flex-direction:column;justify-content:center">
<h1 style="font-size:42px;font-weight:800;letter-spacing:2px">GIFT</h1>
<h2 style="font-size:34px;color:#d4af37;margin-top:-10px;letter-spacing:3px">VOUCHER</h2>
<p id="v_nome"></p>
<p id="v_codigo"></p>
<p id="v_pagamento"></p>
<p id="v_valor" style="font-weight:700;color:#d4af37"></p>
</div>

<!-- CURVA -->
<div style="position:absolute;left:44%;width:90px;height:100%;background:linear-gradient(135deg,#b48a2b,#d4af37,#f7e7b0);clip-path:polygon(0 0,100% 0,70% 100%,0% 100%)"></div>

<!-- LADO CLARO -->
<div style="position:absolute;left:50%;width:50%;height:100%;padding:35px;color:#5a4d29">
<h1 style="font-size:70px;font-family:'Great Vibes';font-weight:300">
R$ <span id="valorGrande"></span>
</h1>
<svg id="barcode"></svg>
<p id="codigoNumerico" style="text-align:center;font-weight:700"></p>
</div>

</div>

<button id="btnPNG" class="hidden" onclick="baixarPNG()">Baixar PNG</button>
<button id="btnWhats" class="hidden" onclick="enviarWhats()" style="background:#25d366;color:#fff">WhatsApp</button>

</div>
</div>
</div>

<script>
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

function show(){overlayLoad.style.display="flex"}
function hide(){overlayLoad.style.display="none"}

/* LOGIN */
async function login(){
  const { data, error } = await sb
    .from("usuarios")
    .select("*")
    .eq("usuario",loginUser.value)
    .eq("senha",loginPass.value);

  if(error || !data.length){
    loginMsg.innerText="Usu√°rio ou senha inv√°lidos";
    return;
  }

  localStorage.setItem("user",loginUser.value);
  loginCard.classList.add("hidden");
  sistema.classList.remove("hidden");
}

function logout(){
  localStorage.clear();
  location.reload();
}

/* GERAR C√ìDIGO √öNICO (GARANTIDO) */
async function gerarCodigoUnico(){
  while(true){
    let codigo = Math.floor(100000000 + Math.random()*900000000).toString();

    const { data, error } = await sb
      .from("vouchers")
      .select("id")
      .eq("codigo",codigo)
      .limit(1);

    if(error) throw error;
    if(!data.length) return codigo; // √∫nico
  }
}

/* EMISS√ÉO */
async function emitir(){
  show();

  try{
    let nome = cliente.value.trim();
    let cpfLimpo = cpf.value.replace(/\D/g,"");
    let telefoneVal = telefone.value.trim();
    let valorNum = (parseInt(valor.value.replace(/\D/g,""))/100).toFixed(2);
    let formaPag = formaPagamento.value;

    if(!nome || !cpfLimpo || !valorNum || !formaPag){
      hide();
      alert("Preencha todos os campos obrigat√≥rios");
      return;
    }

    // üîê gera c√≥digo √∫nico real
    let codigo = await gerarCodigoUnico();

    // üî• INSERT REAL
    const { error } = await sb.from("vouchers").insert([{
      codigo,
      cliente: nome,
      cpf: cpfLimpo,
      telefone: telefoneVal,
      valor: valorNum,
      saldo: valorNum,
      forma_pagamento: formaPag,
      data_emissao: new Date().toISOString(),
      usuario_emissao: localStorage.getItem("user"),
      status: "ATIVO"
    }]);

    if(error){
      hide();
      alert("ERRO AO SALVAR:\n" + error.message);
      return;
    }

    // ‚úÖ S√ì CHEGA AQUI SE SALVOU
    v_nome.innerHTML = "<b>Cliente:</b> " + nome;
    v_codigo.innerHTML = "<b>C√≥digo:</b> " + codigo;
    v_pagamento.innerHTML = "<b>Pagamento:</b> " + formaPag;
    v_valor.innerHTML = "<b>Valor:</b> R$ " + valorNum;
    valorGrande.innerText = valorNum;
    codigoNumerico.innerText = codigo;

    JsBarcode("#barcode", codigo, {
      format:"CODE128",
      width:2,
      height:42,
      displayValue:false
    });

    voucherPNG.style.display="block";
    btnPNG.classList.remove("hidden");
    btnWhats.classList.remove("hidden");

    window.voucherAtual = {
      codigo,
      nome,
      valor: valorNum,
      tel: telefoneVal
    };

  }catch(err){
    alert("Erro inesperado:\n" + err.message);
  }finally{
    hide();
  }
}

/* PNG */
function baixarPNG(){
  html2canvas(voucherPNG,{scale:3}).then(c=>{
    let a=document.createElement("a");
    a.download="voucher.png";
    a.href=c.toDataURL();
    a.click();
  });
}

/* WHATS */
function enviarWhats(){
  let tel = voucherAtual.tel.replace(/\D/g,"");
  let msg =
    `Voucher Mercatto%0A`+
    `C√≥digo: ${voucherAtual.codigo}%0A`+
    `Cliente: ${voucherAtual.nome}%0A`+
    `Valor: R$ ${voucherAtual.valor}`;
  window.open(`https://wa.me/55${tel}?text=${msg}`);
}

/* M√ÅSCARAS */
function maskCPF(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}
function maskPhone(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{2})(\d)/,"($1) $2")
    .replace(/(\d{5})(\d)/,"$1-$2");
}
function maskValor(el){
  let v = el.value.replace(/\D/g,"");
  el.value = "R$ " + (v/100).toFixed(2).replace(".",",");
}
</script>


</body>
</html>

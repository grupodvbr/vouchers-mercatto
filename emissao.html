<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"> 
<title>Voucher Mercatto • Emissão</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --bg:#070707;
  --card:#111;
  --line:#1f1f1f;
  --gold:#d4af37;
  --gold2:#b48a2b;
  --radius:18px;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
body{background:radial-gradient(circle at top,#0b0b0b,#000);color:#fff;padding:28px}
.hidden{display:none}

.card{
  max-width:1100px;
  margin:auto;
  background:linear-gradient(180deg,#111,#0d0d0d);
  border:1px solid var(--gold2);
  border-radius:var(--radius);
  padding:28px;
  box-shadow:0 20px 40px rgba(0,0,0,.6);
}

.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:1px solid var(--line);
  padding-bottom:18px;
  margin-bottom:24px;
}
.header h2{
  color:var(--gold);
  font-weight:800;
  letter-spacing:.4px;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:22px;
}

.section{
  background:#0f0f0f;
  border:1px solid var(--line);
  border-radius:14px;
  padding:20px;
}

.section h3{
  color:var(--gold);
  margin-bottom:14px;
  font-size:15px;
  text-transform:uppercase;
  letter-spacing:.8px;
}

input,select{
  width:100%;
  padding:14px;
  margin-bottom:14px;
  background:#151515;
  border:1px solid var(--gold2);
  border-radius:12px;
  color:#fff;
  font-size:15px;
}

button{
  width:100%;
  padding:16px;
  border-radius:14px;
  border:none;
  background:linear-gradient(135deg,var(--gold2),var(--gold));
  color:#000;
  font-weight:900;
  cursor:pointer;
  font-size:16px;
  letter-spacing:.5px;
  box-shadow:0 10px 22px rgba(212,175,55,.25);
}
button:hover{filter:brightness(1.05)}

.actions{
  margin-top:22px;
}

/* LOGIN */
#loginCard{
  max-width:420px;
  margin:100px auto;
}

/* VOUCHER */
#voucherPNG{
  width:720px;height:300px;
  display:none;
  margin:34px auto 0;
  border-radius:18px;
  overflow:hidden;
  border:3px solid var(--gold);
  background:linear-gradient(to right,#000 0%,#0a0a0a 45%,#111 45%,#fdf6e3 100%);
  position:relative;
  box-shadow:0 14px 40px rgba(0,0,0,.6);
}

.v-left{
  position:absolute;
  left:0;width:45%;height:100%;
  padding:26px;color:#fff;
}
.v-left h1{font-size:44px}
.v-left h2{color:var(--gold)}

.v-cut{
  position:absolute;
  left:44%;width:90px;height:100%;
  background:linear-gradient(135deg,#b48a2b,#d4af37,#f7e7b0);
  clip-path:polygon(0 0,100% 0,70% 100%,0 100%);
}

.v-right{
  position:absolute;
  left:50%;width:50%;height:100%;
  padding:36px;color:#5a4d29;
}

.small{
  position:absolute;
  bottom:10px;
  left:20px;
  right:20px;
  font-size:10px;
  color:#ddd;
  opacity:.85;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginCard" class="card">
  <div class="header">
    <h2>Acesso Operador</h2>
  </div>
  <input id="loginUser" placeholder="Usuário">
  <input id="loginPass" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">
<div class="card">

<div class="header">
  <h2>Emissão de Voucher</h2>
</div>

<div class="grid">

  <div class="section">
    <h3>Dados do Cliente</h3>
    <input id="cliente" placeholder="Nome do Cliente">
    <input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
    <input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
  </div>

  <div class="section">
    <h3>Pagamento & Valor</h3>
    <input id="valor" placeholder="Valor" oninput="maskValor(this)">
    <select id="formaPagamento">
      <option value="" disabled selected>Forma de Pagamento</option>
      <option>PIX</option>
      <option>DINHEIRO</option>
      <option>CARTÃO CRÉDITO</option>
      <option>CARTÃO DÉBITO</option>
    </select>
  </div>

</div>

<div class="actions">
  <button onclick="emitir()">Emitir Voucher</button>
</div>

<!-- VOUCHER VISUAL -->
<div id="voucherPNG">
  <div class="v-left">
    <h1>GIFT</h1>
    <h2>VOUCHER</h2>
    <p id="vNome"></p>
    <p id="vForma"></p>
    <p id="vEmissor"></p>
    <p id="vValidade"></p>
  </div>

  <div class="v-cut"></div>

  <div class="v-right">
    <h1 style="font-size:72px;font-family:'Great Vibes'">
      R$ <span id="vValor"></span>
    </h1>
    <svg id="barcode"></svg>
  </div>

  <div class="small" id="vTextoLegal"></div>
</div>

</div>
</div>

<script>
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

const QR_BASE_URL = "https://grupodvbr.github.io/vouchers-mercatto/carteira.html";
let operador=null;

/* LOGIN */
async function login(){
  let {data}=await sb.from("usuarios")
    .select("*")
    .eq("usuario",loginUser.value)
    .eq("senha",loginPass.value);

  if(!data.length){ alert("Usuário ou senha inválidos"); return; }

  operador=data[0];
  loginCard.classList.add("hidden");
  sistema.classList.remove("hidden");
}

/* GERAR CÓDIGO */
async function gerarCodigo(){
  while(true){
    let c = Math.floor(100000000 + Math.random()*900000000).toString();
    let {data} = await sb.from("vouchers").select("id").eq("codigo",c);
    if(!data.length) return c;
  }
}

/* EMITIR */
async function emitir(){
  let nome = cliente.value.trim();
  let cpfv = cpf.value.replace(/\D/g,"");
  let tel  = telefone.value;
  let val  = (parseInt(valor.value.replace(/\D/g,""))/100).toFixed(2);
  let forma = formaPagamento.value;

  if(!nome || !cpfv || !val || !forma){
    alert("Preencha todos os campos");
    return;
  }

  let codigo = await gerarCodigo();
  let dataEmissao = new Date();
  let validade = new Date();
  validade.setDate(validade.getDate()+60);

  await sb.from("vouchers").insert([{
    codigo, cliente:nome, cpf:cpfv, telefone:tel,
    valor:val, saldo:val, forma_pagamento:forma,
    usuario_emissao:operador.usuario,
    data_emissao:dataEmissao.toISOString(),
    data_validade:validade.toISOString(),
    status:"ATIVO"
  }]);

  gerarVoucher(nome,val,forma,codigo,validade,operador.usuario);
  imprimirRecibos(nome,cpfv,codigo,val,forma,operador.usuario);
}

/* VOUCHER */
function gerarVoucher(nome,val,forma,codigo,validade,emissor){
  vNome.innerHTML="<b>Cliente:</b> "+nome;
  vForma.innerHTML="<b>Pagamento:</b> "+forma;
  vEmissor.innerHTML="<b>Emissor:</b> "+emissor;
  vValidade.innerHTML="<b>Válido até:</b> "+validade.toLocaleDateString("pt-BR");
  vValor.innerText=val;

  vTextoLegal.innerText =
    `Válido até ${validade.toLocaleDateString("pt-BR")} • Prazo máximo de 60 dias após emissão.`;

  JsBarcode("#barcode",codigo,{width:2,height:42});
  voucherPNG.style.display="block";
}

/* IMPRESSÃO */
function imprimirRecibos(nome,cpf,codigo,valor,forma,emissor){
  const cpfMasc = cpf.substring(0,3)+"***";
  const qrUrl = `${QR_BASE_URL}?cpf=${cpf}`;

  const viaCliente = `
  <html><body style="font-family:monospace;font-size:13px">
  <center><b>MERCATTO DELÍCIA</b><br>COMPROVANTE DE EMISSÃO<br>VIA DO CLIENTE<br>--------------------</center>
  Cliente: ${nome}<br>CPF: ${cpf}<br>Código: ${codigo}<br>
  Valor: R$ ${valor}<br>Pagamento: ${forma}<br>Emissor: ${emissor}<br><br>
  <center>
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=${encodeURIComponent(qrUrl)}"><br><br>
    COMO CONSULTAR SEU SALDO:<br>
    1. Escaneie o QR Code<br>
    2. Informe seu CPF<br>
    3. Digite sua senha
  </center>
  <script>window.onload=()=>{window.print();window.close()}</script>
  </body></html>`;

  const viaMercatto = `
  <html><body style="font-family:monospace;font-size:13px">
  <center><b>MERCATTO DELÍCIA</b><br>COMPROVANTE DE EMISSÃO<br>VIA DO MERCATTO<br>--------------------</center>
  Cliente: ${nome}<br>CPF: ${cpfMasc}<br>Código: ${codigo}<br>
  Valor: R$ ${valor}<br>Emissor: ${emissor}<br><br>
  --------------------<br>
  Assinatura do Cliente:<br><br>
  ____________________________
  <script>window.onload=()=>{window.print();window.close()}</script>
  </body></html>`;

  let w1 = window.open("","","width=260,height=600");
  w1.document.write(viaCliente); w1.document.close();

  setTimeout(()=>{
    let w2 = window.open("","","width=260,height=600");
    w2.document.write(viaMercatto); w2.document.close();
  },700);
}

/* MÁSCARAS */
function maskCPF(e){e.value=e.value.replace(/\D/g,"").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2")}
function maskPhone(e){e.value=e.value.replace(/\D/g,"").replace(/(\d{2})(\d)/,"($1) $2").replace(/(\d{5})(\d)/,"$1-$2")}
function maskValor(e){let v=e.value.replace(/\D/g,"");e.value="R$ "+(v/100).toFixed(2).replace(".",",")}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"> 
<title>Voucher Mercatto • Emissão</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --preto:#1a1a1a;
  --gold:#f1c40f;
  --gold2:#e67e22;
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
body{background:#000;color:#fff;padding:24px}
.hidden{display:none}

/* LOGIN */
#loginCard{
  width:400px;margin:110px auto;padding:28px;
  background:rgba(20,20,20,.85);
  border-radius:var(--radius);
  border:2px solid var(--gold2);
}
#loginCard input{
  width:100%;padding:14px;margin-bottom:14px;
  background:#161616;border:1px solid #6e5a1a;
  color:#fff;border-radius:12px
}
#loginCard button{
  width:100%;padding:14px;border-radius:14px;
  background:var(--gold);border:none;
  font-weight:700;color:#000
}

/* SISTEMA */
.container{
  max-width:1100px;
  margin:auto;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:28px;
}
.card{
  background:rgba(15,15,15,.88);
  padding:26px;
  border-radius:var(--radius);
  border:1px solid var(--gold2);
}
.card h2{color:var(--gold);margin-bottom:18px}

input,select{
  width:100%;padding:13px;margin-bottom:13px;
  border:1px solid var(--gold2);
  background:#1a1a1a;color:#fff;border-radius:12px
}
button{
  padding:13px 22px;border-radius:12px;
  background:var(--gold);color:#000;border:none;
  font-weight:700;cursor:pointer
}

/* VOUCHER */
#voucherPNG{
  width:700px;height:300px;
  display:none;margin-top:18px;
  border-radius:16px;
  overflow:hidden;
  border:3px solid var(--gold);
  background:linear-gradient(to right,#000 0%,#0a0a0a 45%,#111 45%,#fdf6e3 100%);
  position:relative;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginCard">
  <input id="loginUser" placeholder="Usuário">
  <input id="loginPass" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <p id="loginMsg" style="color:#ff6666;text-align:center"></p>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">

<h1 style="color:var(--gold);margin-bottom:22px">
  Emissão de Voucher
  <button onclick="logout()" style="float:right;background:#b02626;color:#fff">Sair</button>
</h1>

<div class="container">

<div class="card">
<h2>Emitir Voucher</h2>

<input id="cliente" placeholder="Nome do Cliente">
<input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
<input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
<input id="valor" placeholder="Valor" oninput="maskValor(this)">

<select id="formaPagamento">
  <option value="" disabled selected>Forma de Pagamento</option>
  <option>PIX</option>
  <option>DINHEIRO</option>
  <option>CARTÃO CRÉDITO</option>
  <option>CARTÃO DÉBITO</option>
</select>

<button onclick="emitir()">Emitir Voucher</button>

<div id="voucherPNG">
  <!-- visual do voucher mantido -->
</div>

</div>
</div>
</div>

<script>
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

/* LOGIN */
async function login(){
  const { data } = await sb.from("usuarios")
    .select("*").eq("usuario",loginUser.value).eq("senha",loginPass.value);
  if(!data.length){loginMsg.innerText="Inválido";return}
  localStorage.setItem("user",loginUser.value);
  loginCard.classList.add("hidden");
  sistema.classList.remove("hidden");
}
function logout(){localStorage.clear();location.reload()}

/* CÓDIGO ÚNICO */
async function gerarCodigoUnico(){
  while(true){
    let c=Math.floor(100000000+Math.random()*900000000).toString();
    const { data } = await sb.from("vouchers").select("id").eq("codigo",c).limit(1);
    if(!data.length) return c;
  }
}

/* EMISSÃO */
async function emitir(){
  let nome=cliente.value.trim();
  let cpfv=cpf.value.replace(/\D/g,"");
  let tel=telefone.value.trim();
  let val=(parseInt(valor.value.replace(/\D/g,""))/100).toFixed(2);
  let forma=formaPagamento.value;

  if(!nome||!cpfv||!val||!forma){
    alert("Preencha todos os campos");
    return;
  }

  let codigo=await gerarCodigoUnico();

  await sb.from("vouchers").insert([{
    codigo,cliente:nome,cpf:cpfv,telefone:tel,
    valor:val,saldo:val,forma_pagamento:forma,
    data_emissao:new Date().toISOString(),
    usuario_emissao:localStorage.getItem("user"),
    status:"ATIVO"
  }]);

  imprimirRecibo(nome,cpfv,codigo,val,forma);
}

/* RECIBO — AJUSTADO */
function imprimirRecibo(nome,cpf,codigo,valor,forma){
  let cpfMasc = cpf.substring(0,3)+"***";

  const viaCliente = `
  <div style="width:240px;font-family:monospace;font-size:13px">
    <center><b>MERCATTO DELÍCIA</b><br>VIA DO CLIENTE<br>--------------------</center>
    Cliente: ${nome}<br>
    Valor: R$ ${valor}<br>
    Pagamento: ${forma}<br>
    Data: ${new Date().toLocaleString("pt-BR")}<br>
    --------------------
  </div>`;

  const viaRest = `
  <div style="width:240px;font-family:monospace;font-size:13px">
    <center><b>MERCATTO DELÍCIA</b><br>VIA DO RESTAURANTE<br>--------------------</center>
    Cliente: ${nome}<br>
    CPF: ${cpfMasc}<br>
    Código: ${codigo}<br>
    Valor: R$ ${valor}<br>
    Operador: ${localStorage.getItem("user")}<br>
    Data: ${new Date().toLocaleString("pt-BR")}<br>
    --------------------
  </div>`;

  let w=window.open("","","width=260,height=700");
  w.document.write(`
    ${viaCliente}
    <div style="page-break-after:always"></div>
    ${viaRest}
    <script>
      window.onload=()=>{window.print();window.close();}
    <\/script>
  `);
}

/* MÁSCARAS */
function maskCPF(el){el.value=el.value.replace(/\D/g,"").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2")}
function maskPhone(el){el.value=el.value.replace(/\D/g,"").replace(/(\d{2})(\d)/,"($1) $2").replace(/(\d{5})(\d)/,"$1-$2")}
function maskValor(el){let v=el.value.replace(/\D/g,"");el.value="R$ "+(v/100).toFixed(2).replace(".",",")}
</script>

</body>
</html>

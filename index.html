<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher ‚Ä¢ Emiss√£o & Consulta</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
/* ==============================
   VISUAL PREMIUM GRUPO DV
============================== */
:root{
  --p:#0b1e39;
  --p2:#102742;
  --blue:#1e3a8a;
  --blue-light:#3b82f6;
  --bg:#eef2f7;
  --card:#fff;
  --border:#d9e0ea;
  --radius:14px;
  --shadow:0 4px 14px rgba(0,0,0,0.08);
}

*{
  margin:0; padding:0; box-sizing:border-box;
  font-family:"Inter";
}

body{
  background:var(--bg);
  padding:25px;
}

/* ==============================
   T√çTULO
============================== */
h1{
  font-size:26px;
  color:var(--p);
  margin-bottom:20px;
  font-weight:800;
}

/* ==============================
   LAYOUT
============================== */
.container{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:25px;
}

/* ==============================
   CARD AZUL (IGUAL AO DAS COTA√á√ïES)
============================== */
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:22px;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}

.card-blue{
  background:#dce7ff;
  border-left:6px solid #1e3a8a;
}

/* ==============================
   CAMPOS
============================== */
input,select{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:15px;
  margin-bottom:12px;
}

button{
  padding:12px 22px;
  background:var(--p);
  border:none;
  color:white;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  transition:.2s;
}

button:hover{
  background:var(--p2);
}

/* ==============================
   RESULTADO DA CONSULTA
============================== */
.result-card{
  margin-top:15px;
  padding:18px;
  background:#eef3ff;
  border-left:6px solid #1e3a8a;
  border-radius:12px;
}

/* ==============================
   PNG DO VOUCHER
============================== */
#voucherPNG{
  width:320px;
  padding:20px;
  background:white;
  border-radius:15px;
  border:2px solid #1e3a8a;
  display:none;
}

</style>
</head>
<body>

<h1>üéü Sistema de Vouchers ‚Äì Emiss√£o & Consulta</h1>

<div class="container">

  <!-- =============================
       EMISS√ÉO DO VOUCHER
  ============================== -->
  <div class="card">
    <h2 style="color:var(--p)">Emitir Voucher</h2>

    <input id="cliente" placeholder="Nome do Cliente">
    <input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
    <input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
    <input id="valor" placeholder="Valor do Voucher">

    <button onclick="emitirVoucher()">Emitir Voucher</button>

    <!-- Gerar PNG -->
    <div id="voucherPNG">
      <h3 style="text-align:center;color:#1e3a8a;">VOUCHER</h3>
      <p id="vouch_nome"></p>
      <p id="vouch_codigo"></p>
      <p id="vouch_valor"></p>
      <svg id="barcode"></svg>
    </div>

    <button id="btnDownload" style="margin-top:12px;display:none;" onclick="baixarPNG()">Baixar PNG</button>
  </div>

  <!-- =============================
       CONSULTA DO VOUCHER
  ============================== -->
  <div class="card card-blue">
    <h2 style="color:var(--p)">Consultar Voucher</h2>

    <input id="consultaCodigo" placeholder="Digite o c√≥digo" oninput="limparConsulta()">
    <button onclick="consultarVoucher()">Consultar</button>

    <div id="consultaResultado"></div>
  </div>

</div>

<script>
/* ===========================================
   CONEX√ÉO SUPABASE
=========================================== */
const sb = supabase.createClient(
  "SUPABASE_URL_AQUI",
  "SUPABASE_PUBLIC_KEY_AQUI"
);

/* ===========================================
   M√ÅSCARAS
=========================================== */
function maskCPF(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}

function maskPhone(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{2})(\d)/,"($1) $2")
    .replace(/(\d{5})(\d)/,"$1-$2");
}

/* ===========================================
   GERAR C√ìDIGO ALEAT√ìRIO
=========================================== */
function gerarCodigo(){
  return Math.floor(100000000 + Math.random()*900000000).toString();
}

/* ===========================================
   EMITIR VOUCHER
=========================================== */
async function emitirVoucher(){

  let cliente = document.getElementById("cliente").value.trim();
  let cpf = document.getElementById("cpf").value.trim();
  let telefone = document.getElementById("telefone").value.trim();
  let valor = document.getElementById("valor").value.trim();

  if(!cliente || !cpf || !valor){ alert("Preencha os campos obrigat√≥rios!"); return; }

  let codigo = gerarCodigo();
  let agora = new Date().toISOString();

  let { error } = await sb.from("vouchers").insert([
    {
      codigo,
      cliente,
      cpf,
      telefone,
      valor,
      data_emissao: agora,
      status:"ATIVO"
    }
  ]);

  if(error){ alert("Erro ao emitir voucher"); return; }

  renderVoucherPNG(cliente, valor, codigo);
}

/* ===========================================
   GERAR PNG DO VOUCHER
=========================================== */
function renderVoucherPNG(nome, valor, codigo){

  document.getElementById("vouch_nome").innerHTML = "<b>Cliente:</b> " + nome;
  document.getElementById("vouch_valor").innerHTML = "<b>Valor:</b> R$ " + valor;
  document.getElementById("vouch_codigo").innerHTML = "<b>C√≥digo:</b> " + codigo;

  JsBarcode("#barcode", codigo, { format:"CODE128", width:2, height:40 });

  document.getElementById("voucherPNG").style.display = "block";
  document.getElementById("btnDownload").style.display = "block";
}

function baixarPNG(){
  html2canvas(document.querySelector("#voucherPNG")).then(canvas=>{
    let link = document.createElement("a");
    link.download = "voucher.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  });
}

/* ===========================================
   CONSULTAR VOUCHER
=========================================== */
async function consultarVoucher(){

  let codigo = document.getElementById("consultaCodigo").value.trim();
  if(!codigo) return;

  let div = document.getElementById("consultaResultado");

  let { data } = await sb
    .from("vouchers")
    .select("*")
    .eq("codigo", codigo)
    .limit(1);

  if(!data || data.length === 0){
    div.innerHTML = `<div class='result-card'>‚ùå Voucher n√£o encontrado.</div>`;
    return;
  }

  let v = data[0];

  if(v.status === "RESGATADO"){
    div.innerHTML = `<div class='result-card'>‚ö†Ô∏è Voucher j√° resgatado!</div>`;
    return;
  }

  div.innerHTML = `
    <div class="result-card">
      <b>Cliente:</b> ${v.cliente}<br>
      <b>Valor:</b> R$ ${v.valor}<br>
      <b>Data:</b> ${v.data_emissao}<br>
      <b>Status:</b> ${v.status}<br><br>
      <button onclick="resgatarVoucher('${v.codigo}')">Finalizar / Resgatar</button>
    </div>
  `;
}

function limparConsulta(){
  document.getElementById("consultaResultado").innerHTML = "";
}

/* ===========================================
   RESGATAR VOUCHER
=========================================== */
async function resgatarVoucher(codigo){

  await sb.from("vouchers")
    .update({ status:"RESGATADO" })
    .eq("codigo", codigo);

  document.getElementById("consultaResultado").innerHTML =
    `<div class='result-card'>‚úî Voucher resgatado com sucesso!</div>`;
}

</script>
</body>
</html>

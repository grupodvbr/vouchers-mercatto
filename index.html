<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher • Emissão & Consulta</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --p:#0b1e39;
  --p2:#102742;
  --blue:#1e3a8a;
  --green:#25d366;
  --bg:#eef2f7;
  --card:#fff;
  --border:#d9e0ea;
  --radius:14px;
  --shadow:0 4px 14px rgba(0,0,0,0.08);
}

*{margin:0;padding:0;box-sizing:border-box;font-family:"Inter";}
body{background:var(--bg);padding:25px;}

.hidden{display:none;}
button{cursor:pointer;transition:.2s;}

.btn{
  padding:12px 24px;
  border:none;
  border-radius:12px;
  background:var(--blue);
  color:white;
  font-weight:700;
  box-shadow:0 3px 8px rgba(0,0,0,0.15);
}
.btn:hover{background:var(--p2);}

.btn-danger{
  background:#c62828;
}
.btn-danger:hover{background:#9b1f1f;}

.btn-green{
  background:var(--green);
}
.btn-green:hover{background:#1da851;}

input{
  padding:12px;
  border-radius:10px;
  width:100%;
  border:1px solid var(--border);
  margin-bottom:12px;
  font-size:15px;
}

#loginCard{
  width:380px;margin:auto;margin-top:80px;padding:25px;
  background:white;border-radius:14px;box-shadow:var(--shadow);border:1px solid var(--border);
}
#loginCard img{width:130px;display:block;margin:auto;margin-bottom:15px;}

.container{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:30px;
}

.card{
  background:white;
  border-radius:var(--radius);
  padding:25px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
}

.card-blue{
  background:#eaf1ff;
  border-left:6px solid var(--blue);
}

/* Voucher PNG */
#voucherPNG{
  width:330px;
  padding:20px;
  margin-top:20px;
  background:white;
  border-radius:15px;
  border:2px solid var(--blue);
  display:none;
}
#voucherPNG img{width:120px;display:block;margin:auto;margin-bottom:10px;}

/* POPUP */
.popup{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.45);
  display:none;
  justify-content:center;
  align-items:center;
  padding:20px;
}
.popup-box{
  background:white;
  width:420px;
  border-radius:14px;
  padding:25px;
  border:2px solid var(--blue);
  box-shadow:var(--shadow);
}

/* Overlay carregando */
#overlayLoad{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,0.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:99999;
  text-align:center;
  font-size:22px;
  color:var(--p);
}
#overlayLoad img{width:120px;margin-bottom:20px;}
</style>
</head>
<body>

<!-- ============================== -->
<!-- OVERLAY CARREGANDO            -->
<!-- ============================== -->
<div id="overlayLoad">
  <div>
    <img src="logo.png">
    <br>
    <b>Processando...</b>
  </div>
</div>

<!-- ============================== -->
<!-- LOGIN                          -->
<!-- ============================== -->
<div id="loginCard">
  <img src="logo.png">

  <h2 style="text-align:center;color:var(--p)">Login do Sistema</h2>

  <input id="loginUser" placeholder="Usuário">
  <input id="loginPass" type="password" placeholder="Senha">

  <button class="btn" onclick="login()">Entrar</button>
  <p id="loginMsg" style="color:red;text-align:center;margin-top:8px;"></p>
</div>

<!-- ============================== -->
<!-- SISTEMA PRINCIPAL             -->
<!-- ============================== -->
<div id="sistema" class="hidden">

  <h1 style="margin-bottom:15px;">
    <img src="logo.png" style="height:40px;vertical-align:middle;margin-right:10px;">
    Sistema de Vouchers

    <button onclick="logout()" class="btn btn-danger" style="float:right;width:auto;">
      Sair
    </button>
  </h1>

  <div class="container">

    <!-- EMISSÃO -->
    <div class="card">
      <h2 style="color:var(--p)">Emitir Voucher</h2>

      <input id="cliente" placeholder="Nome do Cliente">
      <input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
      <input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
      <input id="valor" placeholder="Valor do Voucher" oninput="maskValor(this)">

      <button class="btn" onclick="emitir()">Emitir Voucher</button>

      <div id="voucherPNG">
        <img src="logo.png">
        <h3 style="text-align:center;color:var(--blue);">VOUCHER OFICIAL</h3>
        <p id="vouch_nome"></p>
        <p id="vouch_codigo"></p>
        <p id="vouch_valor"></p>
        <svg id="barcode"></svg>
      </div>

      <button id="btnDownload" class="btn hidden" onclick="baixarPNG()">Baixar PNG</button>
      <button id="btnWhats" class="btn btn-green hidden" onclick="enviarWhats()">Enviar WhatsApp</button>
    </div>

    <!-- CONSULTA -->
    <div class="card card-blue">
      <h2 style="color:var(--p)">Consultar Voucher</h2>

      <input id="consultaCodigo" placeholder="Código" onkeydown="enterConsulta(event)">
      <button class="btn" onclick="consultar()">Consultar</button>

      <div id="consultaResultado"></div>
    </div>

  </div>
</div>

<!-- ============================== -->
<!-- POPUP DETALHES RESGATADO      -->
<!-- ============================== -->
<div id="popupDetalhes" class="popup">
  <div class="popup-box">
    <h3 style="color:var(--blue)">Detalhes do Voucher</h3>
    <div id="popupContent"></div>
    <br>
    <button class="btn btn-danger" onclick="fecharPopup()">Fechar</button>
  </div>
</div>

<!-- ============================== -->
<!-- IMPRESSÃO                     -->
<!-- ============================== -->
<div id="printArea" class="hidden">
  <h3 style="text-align:center">Comprovante de Resgate</h3>
  <div id="printContent"></div>

  <p>Data/Hora: <span id="printData"></span></p>
  <p>Atendido por: <span id="printUser"></span></p>

  <br><br>
  ___________________________________<br>
  Assinatura do Cliente
</div>


<script>
/* ----------------------------------------------------------
   CONFIG SUPABASE  (CREDENCIAIS AQUI)
----------------------------------------------------------- */
const SUPABASE_URL = "https://ckkqcxbzfkjzicvoeehw.supabase.co";
const SUPABASE_KEY = "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ----------------------------------------------------------
   OVERLAY
----------------------------------------------------------- */
function showLoad(){ overlayLoad.style.display = "flex"; }
function hideLoad(){ overlayLoad.style.display = "none"; }

/* ----------------------------------------------------------
   LOGIN
----------------------------------------------------------- */
async function login(){
  showLoad();

  let user = loginUser.value.trim();
  let pass = loginPass.value.trim();

  if(!user || !pass){
    loginMsg.innerText = "Preencha usuário e senha.";
    hideLoad();
    return;
  }

  const { data } = await sb
    .from("usuarios")
    .select("*")
    .eq("usuario", user)
    .eq("senha", pass)
    .limit(1);

  if(!data || data.length === 0){
    loginMsg.innerText = "Usuário ou senha inválidos.";
    registrarLog("LOGIN_INVALIDO", user);
    hideLoad();
    return;
  }

  localStorage.setItem("sessionUser", user);
  registrarLog("LOGIN_SUCESSO", user);

  loginCard.style.display = "none";
  sistema.classList.remove("hidden");

  hideLoad();
}

/* sempre derruba sessão ao recarregar */
window.onload = () => {
  hideLoad();
  localStorage.removeItem("sessionUser");
  sistema.classList.add("hidden");
};

/* ----------------------------------------------------------
   LOGS
----------------------------------------------------------- */
async function registrarLog(tipo, detalhes){
  await sb.from("logs_sistema").insert([{
    tipo,
    detalhes,
    usuario: localStorage.getItem("sessionUser") || "DESCONHECIDO"
  }]);
}

/* ----------------------------------------------------------
   MÁSCARAS
----------------------------------------------------------- */
function maskCPF(el){
  el.value = el.value.replace(/\D/g,"")
  .replace(/(\d{3})(\d)/,"$1.$2")
  .replace(/(\d{3})(\d)/,"$1.$2")
  .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}

function maskPhone(el){
  el.value = el.value.replace(/\D/g,"")
  .replace(/(\d{2})(\d)/,"($1) $2")
  .replace(/(\d{5})(\d)/,"$1-$2");
}

function maskValor(el){
  let v = el.value.replace(/\D/g,"");
  v = (Number(v) / 100).toFixed(2) + "";
  v = v.replace(".", ",");
  el.value = "R$ " + v;
}

/* ----------------------------------------------------------
   EMITIR
----------------------------------------------------------- */
function gerarCodigo(){
  return Math.floor(100000000 + Math.random()*900000000).toString();
}

let voucherAtual = null;

async function emitir(){
  showLoad();

  let nome = cliente.value.trim();
  let cpfVal = cpf.value.trim();
  let tel = telefone.value.trim();
  let val = valor.value.trim();

  if(!nome || !cpfVal || !val){
    alert("Preencha todos os campos.");
    hideLoad();
    return;
  }

  let codigo = gerarCodigo();
  let agora = new Date().toISOString();

  await sb.from("vouchers").insert([{
    codigo,
    cliente: nome,
    cpf: cpfVal,
    telefone: tel,
    valor: val.replace("R$ ",""),
    data_emissao: agora,
    status: "ATIVO"
  }]);

  registrarLog("EMISSAO", codigo);

  voucherAtual = { codigo, nome, val, tel };

  gerarVoucherPNG(voucherAtual);

  hideLoad();
}

/* ----------------------------------------------------------
   GERAR PNG
----------------------------------------------------------- */
function gerarVoucherPNG(v){
  vouch_nome.innerHTML = "<b>Cliente:</b> " + v.nome;
  vouch_valor.innerHTML = "<b>Valor:</b> " + valor.value;
  vouch_codigo.innerHTML = "<b>Código:</b> " + v.codigo;

  JsBarcode("#barcode", v.codigo, { format:"CODE128", width:2, height:40 });

  voucherPNG.style.display = "block";
  btnDownload.classList.remove("hidden");
  btnWhats.classList.remove("hidden");
}

function baixarPNG(){
  html2canvas(voucherPNG).then(canvas=>{
    let link = document.createElement("a");
    link.download = "voucher.png";
    link.href = canvas.toDataURL();
    link.click();
  });
}

function enviarWhats(){
  if(!voucherAtual || !voucherAtual.tel) return;

  let tel = voucherAtual.tel.replace(/\D/g,"");

  let msg =
    `Seu Voucher foi gerado!\n`+
    `Código: ${voucherAtual.codigo}\n`+
    `Cliente: ${voucherAtual.nome}\n`+
    `Valor: ${valor.value}`;

  window.open(`https://wa.me/55${tel}?text=${encodeURIComponent(msg)}`, "_blank");
}

/* ----------------------------------------------------------
   CONSULTAR
----------------------------------------------------------- */
function enterConsulta(e){ if(e.key==="Enter") consultar(); }

async function consultar(){
  showLoad();

  let cod = consultaCodigo.value.trim();
  if(!cod){ hideLoad(); return; }

  const { data } = await sb.from("vouchers")
    .select("*")
    .eq("codigo", cod)
    .limit(1);

  hideLoad();

  if(!data || data.length===0){
    consultaResultado.innerHTML = `<div class="result-card">❌ Voucher não encontrado.</div>`;
    registrarLog("CONSULTA_FALHA", cod);
    return;
  }

  let v = data[0];

  if(v.status === "RESGATADO"){
    abrirPopupResgatado(v);
    return;
  }

  consultaResultado.innerHTML = `
    <div class="result-card">
      <b>Cliente:</b> ${v.cliente}<br>
      <b>Valor:</b> R$ ${v.valor}<br>
      <b>Emissão:</b> ${formatarData(v.data_emissao)}<br><br>

      <button class="btn btn-green" onclick="resgatar('${v.codigo}')">Finalizar / Resgatar</button>
    </div>
  `;
}

/* ----------------------------------------------------------
   POPUP RESGATADO
----------------------------------------------------------- */
function abrirPopupResgatado(v){
  popupContent.innerHTML = `
    <p><b>Cliente:</b> ${v.cliente}</p>
    <p><b>Valor:</b> R$ ${v.valor}</p>
    <p><b>Emitido:</b> ${formatarData(v.data_emissao)}</p>
    <p><b>Resgatado:</b> ${formatarData(v.data_resgate)}</p>
    <p><b>Responsável:</b> ${v.usuario_resgate}</p>
  `;
  popupDetalhes.style.display = "flex";
}
function fecharPopup(){ popupDetalhes.style.display = "none"; }

/* ----------------------------------------------------------
   RESGATAR
----------------------------------------------------------- */
async function resgatar(codigo){
  showLoad();

  let user = localStorage.getItem("sessionUser");
  let agora = new Date().toISOString();

  await sb.from("vouchers")
    .update({
      status:"RESGATADO",
      data_resgate:agora,
      usuario_resgate:user
    })
    .eq("codigo", codigo);

  registrarLog("RESGATE", codigo);

  gerarComprovante(codigo);
  imprimirComprovante();

  hideLoad();

  consultaResultado.innerHTML =
    `<div class="result-card">✔ Resgatado com sucesso!</div>`;
}

/* ----------------------------------------------------------
   COMPROVANTE
----------------------------------------------------------- */
async function gerarComprovante(codigo){
  const { data } = await sb
      .from("vouchers")
      .select("*")
      .eq("codigo", codigo)
      .limit(1);

  let v = data[0];

  printContent.innerHTML = `
    Cliente: ${v.cliente}<br>
    Valor: R$ ${v.valor}<br>
    Código: ${v.codigo}<br>
  `;

  printData.innerText = formatarData(v.data_resgate);
  printUser.innerText = v.usuario_resgate;
}

function imprimirComprovante(){
  let janela = window.open("", "", "width=260,height=600");
  janela.document.write(printArea.innerHTML);
  janela.print();
  janela.close();
}

/* ----------------------------------------------------------
   UTIL
----------------------------------------------------------- */
function formatarData(dt){
  let d = new Date(dt);
  return d.toLocaleString("pt-BR");
}

</script>
</body>
</html>

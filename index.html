<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher Mercatto ‚Ä¢ Sistema Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- FONTES -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<!-- BIBLIOTECAS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>

<style>
/* ============================================================
   üé® PALETA PREMIUM BLACK & GOLD
============================================================ */
:root{
  --preto:#000;
  --gold:#d4af37;
  --gold2:#a88928;
  --white:#ffffffee;
  --card:#0f0f0f;
  --radius:14px;
  --shadow:0 0 20px rgba(0,0,0,0.5);
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:"Inter";
  -webkit-user-select:none;
  user-select:none;
}

/* Remove autofill */
input:-webkit-autofill{
  box-shadow:0 0 0 30px #111 inset !important;
  -webkit-text-fill-color:white !important;
}

/* ============================================================
   üì∏ BACKGROUND DESFOCADO
============================================================ */
#bgBlur{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:url('logo.png') center/cover no-repeat;
  filter:blur(6px) brightness(45%);
  z-index:-1;
}

/* ============================================================
   LOGIN
============================================================ */
#loginCard{
  width:380px;
  margin:60px auto;
  background:rgba(0,0,0,0.70);
  padding:25px;
  border-radius:var(--radius);
  border:2px solid var(--gold);
  box-shadow:var(--shadow);
  backdrop-filter:blur(8px);
}

#loginCard h2{
  text-align:center;
  color:var(--gold);
  margin-bottom:15px;
}

#loginCard input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  background:#0d0d0d;
  border:1px solid var(--gold2);
  color:white;
  border-radius:8px;
  outline:none;
  font-size:15px;
}

#loginCard button{
  width:100%;
  padding:12px;
  background:var(--gold);
  border:none;
  color:black;
  font-weight:700;
  border-radius:10px;
  cursor:pointer;
}

/* ============================================================
   SISTEMA
============================================================ */
.hidden{ display:none; }

#sistema{
  width:100%;
  max-width:1100px;
  margin:auto;
  padding:5px;
}

.card{
  background:rgba(0,0,0,0.75);
  padding:22px;
  border-radius:var(--radius);
  border:1px solid var(--gold2);
  backdrop-filter:blur(8px);
  box-shadow:var(--shadow);
}

.card h2{
  color:var(--gold);
  margin-bottom:12px;
}

input{
  width:100%;
  padding:11px;
  margin-bottom:10px;
  border-radius:8px;
  background:#111;
  border:1px solid var(--gold2);
  color:white;
  outline:none;
  font-size:14px;
}

button{
  padding:12px 22px;
  background:var(--gold);
  color:black;
  border:none;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}
button:hover{
  background:white;
  color:black;
}

/* ============================================================
   VOUCHER (TAMANHO CART√ÉO DE CR√âDITO)
============================================================ */

#voucherPNG{
  width:300px;
  height:480px;
  padding:16px;
  margin-top:15px;
  background:black;
  display:none;
  border-radius:18px;
  border:3px solid var(--gold);
  box-shadow:0 0 25px rgba(212,175,55,0.4);
  color:white;
}

#voucherPNG h3{
  font-family:'Great Vibes';
  font-size:36px;
  color:var(--gold);
  text-align:center;
  margin-bottom:10px;
}

.vLine{
  margin-top:10px;
  font-size:15px;
  color:white;
}

#barcode{
  margin-top:25px;
  width:100%;
}

/* Bot√µes */
#btnArea{
  display:flex;
  justify-content:center;
  gap:15px;
  margin-top:18px;
}

/* Consulta */
.result-card{
  margin-top:10px;
  padding:15px;
  border-left:3px solid var(--gold);
  background:#000000aa;
  border-radius:8px;
  color:white;
}

/* POPUP */
.popup{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  display:none;
  justify-content:center;
  align-items:center;
  background:rgba(0,0,0,0.75);
}

.popup-box{
  background:#111;
  padding:25px;
  width:420px;
  border:2px solid var(--gold);
  border-radius:14px;
  color:white;
}

#overlayLoad{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.7);
  display:none;
  justify-content:center;
  align-items:center;
  color:var(--gold);
  font-size:26px;
  z-index:99999;
}
</style>
</head>

<body>

<div id="bgBlur"></div>
<div id="overlayLoad">Processando...</div>

<!-- LOGIN -->
<div id="loginCard">
  <h2>Emiss√£o de Voucher</h2>
  <input autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" id="loginUser" placeholder="Usu√°rio">
  <input autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" id="loginPass" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <p id="loginMsg" style="color:#ff4444;margin-top:8px;text-align:center;"></p>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">

  <h1 style="color:var(--gold);margin-bottom:25px;">
    Voucher Mercatto ‚Äî Painel Premium
    <button onclick="logout()" style="float:right;background:#b02626;color:white;">Sair</button>
  </h1>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">

    <!-- EMISS√ÉO -->
    <div class="card">
      <h2>Emitir Voucher</h2>

      <input autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" id="cliente" placeholder="Nome do Cliente">
      <input autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" id="cpf" placeholder="CPF" oninput="maskCPF(this)">
      <input autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
      <input autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" id="valor" placeholder="Valor" oninput="maskValor(this)">

      <button onclick="emitir()">Emitir Voucher</button>

      <div id="voucherPNG">
        <h3>Voucher Mercatto</h3>

        <p class="vLine" id="vouch_nome"></p>
        <p class="vLine" id="vouch_valor"></p>
        <p class="vLine" id="vouch_codigo"></p>

        <svg id="barcode"></svg>
      </div>

      <div id="btnArea" class="hidden">
        <button onclick="baixarPDF()">Baixar PDF</button>
        <button onclick="enviarWhats()" style="background:#25d366;color:white;">WhatsApp</button>
      </div>

    </div>

    <!-- CONSULTA -->
    <div class="card">
      <h2>Consultar Voucher</h2>

      <input autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" id="consultaCodigo" placeholder="C√≥digo" onkeydown="enterConsulta(event)">
      <button onclick="consultar()">Consultar</button>

      <div id="consultaResultado"></div>
    </div>

  </div>
</div>

<!-- POPUP -->
<div id="popupDetalhes" class="popup">
  <div class="popup-box">
    <h3 style="color:var(--gold);margin-bottom:12px;">Detalhes do Voucher</h3>
    <div id="popupContent"></div>
    <button onclick="fecharPopup()" style="margin-top:15px;">Fechar</button>
  </div>
</div>

<script>
/* ============================================================
   SUPABASE
============================================================ */
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

/* Loader */
function showLoad(){ overlayLoad.style.display="flex"; }
function hideLoad(){ overlayLoad.style.display="none"; }

/* ============================================================
   LOGIN
============================================================ */
async function login(){
  showLoad();

  const { data } = await sb.from("usuarios")
    .select("*")
    .eq("usuario", loginUser.value.trim())
    .eq("senha", loginPass.value.trim());

  hideLoad();

  if(!data || data.length===0){
    loginMsg.innerText="Usu√°rio ou senha inv√°lidos";
    return;
  }

  localStorage.setItem("sessionUser", loginUser.value.trim());
  loginCard.style.display="none";
  sistema.classList.remove("hidden");
}

function logout(){
  localStorage.clear();
  location.reload();
}

/* ============================================================
   M√ÅSCARAS
============================================================ */
function maskCPF(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}

function maskPhone(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{2})(\d)/,"($1) $2")
    .replace(/(\d{5})(\d)/,"$1-$2");
}

function maskValor(el){
  let v = el.value.replace(/\D/g,"");
  v = (v/100).toFixed(2).replace(".",",");
  el.value = "R$ " + v;
}

/* ============================================================
   EMITIR
============================================================ */
let voucherAtual = null;

async function emitir(){
  showLoad();

  let nome = cliente.value.trim();
  let val  = valor.value.replace("R$ ","");

  if(!nome || !val){
    hideLoad();
    alert("Preencha os campos obrigat√≥rios!");
    return;
  }

  let codigo = String(Math.floor(100000000 + Math.random()*900000000));

  const { error } = await sb.from("vouchers").insert([{
    codigo,
    cliente:nome,
    cpf:cpf.value.trim(),
    telefone:telefone.value.trim(),
    valor:val,
    data_emissao:new Date().toISOString(),
    status:"ATIVO"
  }]);

  hideLoad();

  if(error){
    alert("‚ùå ERRO: Voucher n√£o registrado.");
    return;
  }

  voucherAtual = { nome, val, codigo, tel:telefone.value.trim() };
  gerarVoucher(voucherAtual);
}

/* ============================================================
   GERAR VOUCHER
============================================================ */
function gerarVoucher(v){
  vouch_nome.innerHTML = `<b>Cliente:</b> ${v.nome}`;
  vouch_valor.innerHTML = `<b>Valor:</b> R$ ${v.val}`;
  vouch_codigo.innerHTML = `<b>C√≥digo:</b> ${v.codigo}`;

  JsBarcode("#barcode", v.codigo, {
    format:"CODE128",
    width:2,
    height:45,
    background:"black",
    lineColor:"#d4af37"
  });

  voucherPNG.style.display="block";
  btnArea.classList.remove("hidden");
}

/* ============================================================
   PDF TAMANHO REAL CART√ÉO
============================================================ */
function baixarPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    orientation:"portrait",
    unit:"mm",
    format:[85.6,53.98]
  });

  html2canvas(voucherPNG).then(canvas=>{
    const img = canvas.toDataURL("image/png");
    pdf.addImage(img,"PNG",0,0,53.98,85.6);
    pdf.save("voucher.pdf");
  });
}

/* ============================================================
   WHATSAPP
============================================================ */
function enviarWhats(){
  let tel = voucherAtual.tel.replace(/\D/g,"");
  let msg = encodeURIComponent(
    `Voucher Mercatto\nCliente: ${voucherAtual.nome}\nValor: R$ ${voucherAtual.val}\nC√≥digo: ${voucherAtual.codigo}`
  );
  window.open(`https://wa.me/55${tel}?text=${msg}`,"_blank");
}

/* ============================================================
   CONSULTAR
============================================================ */
function enterConsulta(e){ if(e.key==="Enter") consultar(); }

async function consultar(){
  showLoad();
  const { data } = await sb.from("vouchers")
    .select("*")
    .eq("codigo", consultaCodigo.value.trim());
  hideLoad();

  if(!data || data.length===0){
    consultaResultado.innerHTML = `<div class="result-card">‚ùå N√£o encontrado</div>`;
    return;
  }

  let v = data[0];

  if(v.status==="RESGATADO"){
    abrirPopup(v);
    return;
  }

  consultaResultado.innerHTML = `
    <div class="result-card">
      <b>Cliente:</b> ${v.cliente}<br>
      <b>Valor:</b> R$ ${v.valor}<br><br>
      <button onclick="resgatar('${v.codigo}')">Resgatar</button>
    </div>
  `;
}

/* ============================================================
   POPUP DETALHES
============================================================ */
function abrirPopup(v){
  popupContent.innerHTML = `
    <p><b>Cliente:</b> ${v.cliente}</p>
    <p><b>Valor:</b> R$ ${v.valor}</p>
    <p><b>Emitido:</b> ${new Date(v.data_emissao).toLocaleString("pt-BR")}</p>
    <p><b>Resgatado:</b> ${new Date(v.data_resgate).toLocaleString("pt-BR")}</p>
    <p><b>Respons√°vel:</b> ${v.usuario_resgate}</p>
  `;
  popupDetalhes.style.display="flex";
}

function fecharPopup(){
  popupDetalhes.style.display="none";
}

/* ============================================================
   RESGATAR
============================================================ */
async function resgatar(codigo){
  showLoad();

  let user = localStorage.getItem("sessionUser");

  await sb.from("vouchers").update({
    status:"RESGATADO",
    data_resgate:new Date().toISOString(),
    usuario_resgate:user
  }).eq("codigo",codigo);

  hideLoad();
  consultar();
}
</script>

</body>
</html>

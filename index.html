<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher Mercatto ‚Ä¢ Sistema Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- FONTES -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<!-- BIBLIOTECAS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
/* ============================================================
   üé® PALETA PREMIUM BLACK & GOLD
============================================================ */
:root{
  --preto:#000000;
  --gold:#d4af37;
  --gold2:#b08a2e;
  --card-bg:#0c0c0cdd;
  --radius:14px;
}

body{
  margin:0;
  background:url('background.jpg') center/cover no-repeat fixed;
  backdrop-filter:blur(3px);
  color:white;
  font-family:"Inter";
  overflow:hidden;
}

/* ============================================================
   LAYOUT PRINCIPAL
============================================================ */
#mainContainer{
  padding:20px;
}

.cardsRow{
  display:flex;
  justify-content:space-between;
  gap:20px;
}

.card{
  flex:1;
  background:var(--card-bg);
  border:1px solid var(--gold2);
  border-radius:var(--radius);
  padding:20px;
  height:300px;
}

.card h2{
  margin-top:0;
  color:var(--gold);
}

/* Inputs */
input{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  background:#111;
  border:1px solid var(--gold2);
  color:white;
  border-radius:8px;
  font-size:14px;
}
input::placeholder{color:#999;}
input:-webkit-autofill{
  background:#111 !important;
  -webkit-text-fill-color:white !important;
}

/* Bot√µes */
button{
  padding:10px 18px;
  border:none;
  border-radius:8px;
  font-weight:700;
  cursor:pointer;
}
.btnGold{background:var(--gold);color:black;}
.btnGold:hover{background:white;}

.btnWhats{background:#25d366;color:white;}
.btnWhats:hover{opacity:0.9;}

#voucherArea{
  margin-top:18px;
  text-align:center;
}

/* ============================================================
   VOUCHER HORIZONTAL CART√ÉO 500√ó260
============================================================ */
#voucherCard{
  width:500px;
  height:260px;
  background:black;
  border-radius:16px;
  border:3px solid var(--gold);
  margin:auto;
  display:none;
  position:relative;
  overflow:hidden;
  padding:20px;
  text-align:left;
}

#voucherCard::before{
  /* LOGO APAGADA NO FUNDO */
  content:"";
  position:absolute;
  top:0;left:0;
  width:100%;height:100%;
  background:url("logo.png") center/70% no-repeat;
  opacity:0.09;
  filter:contrast(70%);
}

#voucherTitle{
  font-family:'Great Vibes';
  font-size:36px;
  color:var(--gold);
  text-align:center;
  margin-bottom:10px;
  position:relative;
  z-index:5;
}

.vLine{
  font-size:16px;
  margin-bottom:8px;
  position:relative;
  z-index:5;
}

#barcode{
  width:100%;
  margin-top:10px;
  position:relative;
  z-index:5;
}

#voucherButtons{
  display:none;
  justify-content:center;
  gap:15px;
  margin-top:10px;
}

/* Loader */
#overlayLoad{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:#000000aa;
  display:none;justify-content:center;align-items:center;
  color:var(--gold);font-size:28px;z-index:999;
}
</style>
</head>

<body>

<div id="overlayLoad">Processando...</div>

<div id="mainContainer">

<h1 style="color:var(--gold);margin-bottom:15px;">
  Voucher Mercatto ‚Äî Painel Premium
  <button onclick="logout()" style="float:right;background:#b02626;color:white;padding:10px 20px;border-radius:10px;">Sair</button>
</h1>

<div class="cardsRow">

  <!-- ========================= EMITIR ========================= -->
  <div class="card">
    <h2>Emitir Voucher</h2>

    <input autocomplete="off" id="cliente" placeholder="Nome do Cliente">
    <input autocomplete="off" id="cpf" placeholder="CPF" oninput="maskCPF(this)">
    <input autocomplete="off" id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
    <input autocomplete="off" id="valor" placeholder="Valor" oninput="maskValor(this)">

    <button class="btnGold" onclick="emitir()">Emitir Voucher</button>
  </div>

  <!-- ========================= CONSULTAR ========================= -->
  <div class="card">
    <h2>Consultar Voucher</h2>

    <input autocomplete="off" id="consultaCodigo" placeholder="C√≥digo" onkeydown="enterConsulta(event)">
    <button class="btnGold" onclick="consultar()">Consultar</button>

    <div id="consultaResultado" style="margin-top:15px;color:white;"></div>
  </div>

</div>

<!-- ========================= √ÅREA DO VOUCHER ================ -->
<div id="voucherArea">

  <div id="voucherCard">
      <div id="voucherTitle">Voucher Mercatto</div>

      <div class="vLine" id="vouch_nome"></div>
      <div class="vLine" id="vouch_valor"></div>
      <div class="vLine" id="vouch_codigo"></div>

      <svg id="barcode"></svg>
  </div>

  <div id="voucherButtons">
      <button class="btnGold" onclick="baixarPDF()">Baixar PDF</button>
      <button class="btnWhats" onclick="enviarWhats()">WhatsApp</button>
  </div>

</div>

<script>
/* ============================================================
   SUPABASE CONFIG
============================================================ */
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

/* Loader */
function showLoad(){ overlayLoad.style.display="flex"; }
function hideLoad(){ overlayLoad.style.display="none"; }

/* ============================================================
   M√ÅSCARAS
============================================================ */
function maskCPF(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}

function maskPhone(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{2})(\d)/,"($1) $2")
    .replace(/(\d{5})(\d)/,"$1-$2");
}

function maskValor(el){
  let v = el.value.replace(/\D/g,"");
  v = (v/100).toFixed(2).replace(".",",");
  el.value = v.replace(/\B(?=(\d{3})+(?!\d))/g, "."); 
  el.value = "R$ " + el.value;
}

/* ============================================================
   GERAR C√ìDIGO √öNICO CONSULTANDO SUPABASE
============================================================ */
async function gerarCodigoUnico(){
  let codigo = "";
  let existe = true;

  while(existe){
    codigo = String(Math.floor(100000000 + Math.random()*900000000));
    let { data } = await sb.from("vouchers").select("codigo").eq("codigo",codigo);
    if(!data || data.length === 0){ existe = false; }
  }
  return codigo;
}

/* ============================================================
   EMITIR VOUCHER
============================================================ */
let voucherAtual = null;

async function emitir(){
  showLoad();

  let nome = cliente.value.trim();
  let cpfv = cpf.value.trim();
  let tel = telefone.value.trim();
  let val = valor.value.replace("R$ ","");

  if(!nome || !val){ hideLoad(); alert("Preencha os campos obrigat√≥rios."); return; }

  let codigo = await gerarCodigoUnico();

  const { error } = await sb.from("vouchers").insert([{
    codigo,
    cliente:nome,
    cpf:cpfv,
    telefone:tel,
    valor:val,
    data_emissao:new Date().toISOString(),
    status:"ATIVO"
  }]);

  hideLoad();

  if(error){ alert("Erro ao registrar no banco."); return; }

  voucherAtual = { nome, val, codigo, tel };
  gerarVoucher();
}

/* ============================================================
   EXIBIR VOUCHER NA TELA
============================================================ */
function gerarVoucher(){
  vouch_nome.innerHTML = "<b>Cliente:</b> " + voucherAtual.nome;
  vouch_valor.innerHTML = "<b>Valor:</b> R$ " + voucherAtual.val;
  vouch_codigo.innerHTML = "<b>C√≥digo:</b> " + voucherAtual.codigo;

  JsBarcode("#barcode", voucherAtual.codigo, {
    format:"CODE128", width:2, height:50,
    lineColor:"#d4af37", background:"black"
  });

  voucherCard.style.display="block";
  voucherButtons.style.display="flex";
}

/* ============================================================
   PDF HORIZONTAL 500√ó260
============================================================ */
function baixarPDF(){
  html2canvas(voucherCard).then(canvas=>{
    const img = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf;

    const pdf = new jsPDF({
      orientation:"landscape",
      unit:"px",
      format:[500,260]
    });

    pdf.addImage(img,"PNG",0,0,500,260);
    pdf.save("voucher.pdf");
  });
}

/* ============================================================
   WHATSAPP COM MENSAGEM PERSONALIZADA
============================================================ */
function enviarWhats(){
  let tel = voucherAtual.tel.replace(/\D/g,"");
  let msg = 
`*Obrigado pela sua compra!*
Aqui est√° seu voucher Mercatto:

‚Ä¢ *Cliente:* ${voucherAtual.nome}
‚Ä¢ *Valor:* R$ ${voucherAtual.val}
‚Ä¢ *C√≥digo:* ${voucherAtual.codigo}

Apresente este voucher na loja para utiliza√ß√£o.`;

  window.open(`https://wa.me/55${tel}?text=${encodeURI(msg)}`,"_blank");
}

/* ============================================================
   CONSULTAR VOUCHER
============================================================ */
function enterConsulta(e){ if(e.key==="Enter") consultar(); }

async function consultar(){
  showLoad();
  let cod = consultaCodigo.value.trim();

  const { data } = await sb.from("vouchers").select("*").eq("codigo",cod);
  hideLoad();

  if(!data || data.length===0){
    consultaResultado.innerHTML="<span style='color:red'>‚ùå N√£o encontrado</span>";
    return;
  }

  let v = data[0];

  consultaResultado.innerHTML = `
    <b>Cliente:</b> ${v.cliente}<br>
    <b>Valor:</b> R$ ${v.valor}<br>
    <b>Status:</b> ${v.status}
  `;
}

/* ============================================================
   LOGOUT
============================================================ */
function logout(){ location.reload(); }
</script>

</body>
</html>

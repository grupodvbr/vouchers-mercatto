<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher Mercatto • Sistema Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- FONTES -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<!-- BIBLIOTECAS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
:root{
  --preto:#000;
  --gold:#d4af37;
  --gold2:#a88928;
  --card:#0e0e0e;
}

/* Fundo */
#bgBlur{
  position:fixed;
  inset:0;
  background:url('logo.png') center/cover no-repeat;
  filter:blur(6px) brightness(45%);
  z-index:-1;
}

/* Geral */
body{
  margin:0;
  font-family:"Inter";
  overflow:hidden; /* sem rolagem! */
}

/* ---------------- LOGIN ---------------- */
#loginCard{
  width:380px;
  margin:90px auto;
  background:rgba(0,0,0,0.78);
  padding:25px;
  border-radius:14px;
  border:2px solid var(--gold);
  text-align:center;
}

#loginCard input{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  background:#141414;
  border:1px solid var(--gold2);
  color:white;
  outline:none;
}

#loginCard button{
  width:100%;
  margin-top:15px;
  padding:12px;
  background:var(--gold);
  border:none;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}

/* ---------------- SISTEMA ---------------- */
.hidden{ display:none; }

#sistema{
  padding:15px 25px;
  height:100vh;
  overflow:hidden;
}

.grid{
  display:flex;
  gap:25px;
  height:calc(100% - 80px);
}

/* Card */
.card{
  background:rgba(0,0,0,0.75);
  padding:20px;
  border-radius:12px;
  border:1px solid var(--gold2);
  flex:1;
  display:flex;
  flex-direction:column;
}

/* Inputs */
.card input{
  padding:10px;
  margin-bottom:8px;
  border-radius:8px;
  background:#151515;
  border:1px solid var(--gold2);
  color:white;
  outline:none;
}

/* Botões */
button{
  background:var(--gold);
  border:none;
  padding:10px 20px;
  border-radius:10px;
  cursor:pointer;
  font-weight:700;
}
button:hover{ background:white; }

/* ---------------- VOUCHER CARTÃO ---------------- */

#voucherWrapper{
  margin-top:10px;
  display:flex;
  justify-content:center;
}

#voucherCard{
  width:410px;  /* Horizontal */
  height:260px;
  background:black;
  border-radius:18px;
  border:3px solid var(--gold);
  padding:15px 25px;
  position:relative;
  display:none;
  overflow:hidden;
}

/* Logo apagada dentro do cartão */
#voucherCard::before{
  content:"";
  position:absolute;
  inset:0;
  background:url('logo.png') center/60% no-repeat;
  opacity:0.12;
  z-index:0;
}

.vLine{
  color:white;
  font-size:16px;
  margin:4px 0;
  z-index:2;
  position:relative;
}

#voucherTitle{
  font-family:'Great Vibes';
  font-size:38px;
  color:var(--gold);
  text-align:center;
  margin-bottom:8px;
  position:relative;
  z-index:2;
}

#barcode{
  margin-top:12px;
  width:90%;
  margin-left:5%;
  z-index:2;
  position:relative;
}

/* Botões */
.vButtons{
  display:flex;
  justify-content:center;
  gap:15px;
  margin-top:15px;
}

/* Consulta */
#consultaResultado{
  margin-top:10px;
  padding:12px;
  background:#00000088;
  border-left:3px solid var(--gold);
  border-radius:8px;
  color:white;
}

#overlayLoad{
  position:fixed;
  inset:0;
  background:#0008;
  color:var(--gold);
  font-size:26px;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
</style>
</head>

<body>

<div id="bgBlur"></div>
<div id="overlayLoad">Processando...</div>

<!-- ---------------- LOGIN ---------------- -->
<div id="loginCard">
  <h2 style="color:var(--gold)">Acesso Restrito</h2>
  <input autocomplete="off" id="loginUser" placeholder="Usuário">
  <input autocomplete="off" type="password" id="loginPass" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <p id="loginMsg" style="color:#ff4444"></p>
</div>

<!-- ---------------- SISTEMA ---------------- -->
<div id="sistema" class="hidden">

  <h1 style="color:var(--gold);margin-bottom:10px;">
    Voucher Mercatto — Painel Premium
    <button onclick="logout()" style="background:#b02626;color:white;float:right;">Sair</button>
  </h1>

  <div class="grid">

    <!-- ---- EMITIR ---- -->
    <div class="card">
      <h2 style="color:var(--gold)">Emitir Voucher</h2>

      <input autocomplete="off" id="cliente" placeholder="Nome do Cliente">
      <input autocomplete="off" id="cpf" placeholder="CPF" oninput="maskCPF(this)">
      <input autocomplete="off" id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
      <input autocomplete="off" id="valor" placeholder="Valor" oninput="maskValor(this)">

      <button onclick="emitir()">Emitir Voucher</button>

      <!-- Cartão -->
      <div id="voucherWrapper">
        <div id="voucherCard">
          <div id="voucherTitle">Voucher Mercatto</div>

          <div class="vLine" id="v_nome"></div>
          <div class="vLine" id="v_valor"></div>
          <div class="vLine" id="v_codigo"></div>

          <svg id="barcode"></svg>
        </div>
      </div>

      <div id="vButtons" class="vButtons" style="display:none;">
        <button onclick="baixarPDF()">Baixar PDF</button>
        <button onclick="enviarWhats()" style="background:#25d366;color:white;">WhatsApp</button>
      </div>
    </div>

    <!-- ---- CONSULTAR ---- -->
    <div class="card">
      <h2 style="color:var(--gold)">Consultar Voucher</h2>

      <input autocomplete="off" id="consultaCodigo" placeholder="Código" onkeydown="enterConsulta(event)">
      <button onclick="consultar()">Consultar</button>

      <div id="consultaResultado"></div>
    </div>

  </div>
</div>

<script>
/* ---------------- SUPABASE ---------------- */
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

/* Loader */
function showLoad(){ overlayLoad.style.display="flex"; }
function hideLoad(){ overlayLoad.style.display="none"; }

/* ---------------- LOGIN ---------------- */
async function login(){
  showLoad();
  const { data } = await sb.from("usuarios")
      .select("*")
      .eq("usuario", loginUser.value.trim())
      .eq("senha", loginPass.value.trim());
  hideLoad();

  if(!data || data.length===0){
    loginMsg.innerText = "Usuário ou senha incorretos";
    return;
  }

  loginCard.style.display="none";
  sistema.classList.remove("hidden");
}

function logout(){ location.reload(); }

/* ---------------- MÁSCARAS ---------------- */
function maskCPF(e){ e.value=e.value.replace(/\D/g,"")
 .replace(/(\d{3})(\d)/,"$1.$2")
 .replace(/(\d{3})(\d)/,"$1.$2")
 .replace(/(\d{3})(\d{1,2})$/,"$1-$2"); }

function maskPhone(e){ e.value=e.value.replace(/\D/g,"")
 .replace(/(\d{2})(\d)/,"($1) $2")
 .replace(/(\d{5})(\d)/,"$1-$2"); }

function maskValor(e){
 let v=e.value.replace(/\D/g,"");
 v=(v/100).toFixed(2).replace(".",",");
 e.value="R$ "+v;
}

/* ---------------------------------------
   GERA CÓDIGO 100% ÚNICO
---------------------------------------- */
async function gerarCodigoUnico(){
  let codigo;
  while(true){
    codigo = String(Math.floor(10000000 + Math.random()*90000000));
    const { data } = await sb.from("vouchers").select("codigo").eq("codigo", codigo);
    if(data.length === 0) return codigo;
  }
}

/* ---------------- EMITIR ---------------- */
let voucherAtual=null;

async function emitir(){
  showLoad();

  let nome = cliente.value.trim();
  let tel = telefone.value.trim();
  let val = valor.value.replace("R$ ","");

  if(!nome || !val){
    hideLoad();
    alert("Preencha nome e valor.");
    return;
  }

  let codigo = await gerarCodigoUnico();

  const { error } = await sb.from("vouchers").insert([
    {
      codigo,
      cliente:nome,
      cpf:cpf.value.trim(),
      telefone:tel,
      valor:val,
      data_emissao:new Date().toISOString(),
      status:"ATIVO"
    }
  ]);

  hideLoad();

  if(error){
    alert("Erro ao registrar voucher.");
    return;
  }

  voucherAtual = { nome, codigo, valor:val, tel };
  preencherVoucher();
}

/* ---------------- MOSTRAR CARTÃO ---------------- */
function preencherVoucher(){
  v_nome.innerHTML = `<b>Cliente:</b> ${voucherAtual.nome}`;
  v_valor.innerHTML = `<b>Valor:</b> R$ ${voucherAtual.valor}`;
  v_codigo.innerHTML = `<b>Código:</b> ${voucherAtual.codigo}`;

  JsBarcode("#barcode", voucherAtual.codigo,{
    format:"CODE128",
    lineColor:"#d4af37",
    width:2,
    height:45,
    background:"transparent"
  });

  voucherCard.style.display="block";
  vButtons.style.display="flex";
}

/* ---------------- PDF CARTÃO REAL ---------------- */
function baixarPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    orientation:"landscape",
    unit:"mm",
    format:[85.6, 53.98]
  });

  html2canvas(voucherCard,{scale:3}).then(canvas=>{
    pdf.addImage(canvas.toDataURL("image/png"),"PNG",0,0,85.6,53.98);
    pdf.save("voucher.pdf");
  });
}

/* ---------------- WhatsApp ---------------- */
function enviarWhats(){
  let phone = voucherAtual.tel.replace(/\D/g,"");
  let msg =
`Voucher Mercatto
Cliente: ${voucherAtual.nome}
Valor: R$ ${voucherAtual.valor}
Código: ${voucherAtual.codigo}`;

  window.open(`https://wa.me/55${phone}?text=${encodeURIComponent(msg)}`);
}

/* ---------------- CONSULTA ---------------- */
function enterConsulta(e){
  if(e.key==="Enter") consultar();
}

async function consultar(){
  showLoad();
  const { data } = await sb.from("vouchers")
        .select("*")
        .eq("codigo", consultaCodigo.value.trim());
  hideLoad();

  if(!data.length){
    consultaResultado.innerHTML=`<b style="color:red">Não encontrado</b>`;
    return;
  }

  const v = data[0];

  if(v.status==="RESGATADO"){
    consultaResultado.innerHTML =
      `<b>Cliente:</b> ${v.cliente}<br>
       <b>Valor:</b> R$ ${v.valor}<br>
       <b>RESGATADO</b>`;
    return;
  }

  consultaResultado.innerHTML =
    `<b>Cliente:</b> ${v.cliente}<br><b>Valor:</b> R$ ${v.valor}<br><br>
     <button onclick="resgatar('${v.codigo}')">Resgatar</button>`;
}

/* ---------------- RESGATAR ---------------- */
async function resgatar(codigo){
  showLoad();
  await sb.from("vouchers").update({
    status:"RESGATADO",
    data_resgate:new Date().toISOString(),
    usuario_resgate:localStorage.getItem("sessionUser")
  }).eq("codigo",codigo);
  hideLoad();
  consultar();
}
</script>

</body>
</html>

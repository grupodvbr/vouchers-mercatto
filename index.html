<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher ‚Ä¢ Emiss√£o & Consulta</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
/* =====================================================
   ESTILO PREMIUM GRUPO DV ‚Äî PAINEL AZUL CORPORATIVO
====================================================== */
:root{
  --p:#0b1e39;
  --p2:#102742;
  --blue:#1e3a8a;
  --blue-light:#3b82f6;
  --bg:#eef2f7;
  --card:#fff;
  --border:#d9e0ea;
  --radius:14px;
  --shadow:0 4px 14px rgba(0,0,0,0.08);
}

*{margin:0;padding:0;box-sizing:border-box;font-family:"Inter";}
body{background:var(--bg);padding:25px;}

h1{
  font-size:28px;color:var(--p);margin-bottom:25px;font-weight:800;
}

.container{
  display:grid;grid-template-columns:1fr 1fr;gap:30px;
}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:25px;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}

.card-blue{
  background:#dce7ff;
  border-left:6px solid var(--blue);
}

input, select{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:15px;
  margin-bottom:12px;
}

button{
  padding:12px 22px;
  background:var(--blue);
  border:none;
  color:white;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
  transition:.2s;
}
button:hover{background:var(--p2);}

.result-card{
  margin-top:15px;
  padding:18px;
  background:#eef3ff;
  border-left:6px solid var(--blue);
  border-radius:12px;
}

#voucherPNG{
  width:330px;
  padding:20px;
  background:white;
  border-radius:15px;
  border:2px solid var(--blue);
  display:none;
  margin-top:20px;
}

/* Comprovante de resgate */
#printArea{
  display:none;
  width:280px;
  font-size:14px;
  padding:10px;
}

</style>
</head>
<body>

<h1>üéü Sistema de Vouchers ‚Äì Emiss√£o & Consulta</h1>

<div class="container">

  <!-- ====================================================
       EMISS√ÉO
  ==================================================== -->
  <div class="card">
    <h2 style="color:var(--p)">Emitir Voucher</h2>

    <input id="cliente" placeholder="Nome do Cliente">
    <input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
    <input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
    <input id="valor" placeholder="Valor do Voucher">

    <button onclick="emitirVoucher()">Emitir Voucher</button>

    <!-- PNG -->
    <div id="voucherPNG">
      <img src="logo.png" style="width:120px;margin:auto;display:block;margin-bottom:10px;">
      <h3 style="text-align:center;color:#1e3a8a;">VOUCHER OFICIAL</h3>
      <p id="vouch_nome"></p>
      <p id="vouch_codigo"></p>
      <p id="vouch_valor"></p>
      <svg id="barcode"></svg>
    </div>

    <button id="btnDownload" style="margin-top:12px;display:none;" onclick="baixarPNG()">Salvar PNG</button>
    <button id="btnWhats" style="margin-top:12px;display:none;background:#25d366;" onclick="enviarWhatsapp()">Enviar WhatsApp</button>

  </div>

  <!-- ====================================================
       CONSULTA
  ==================================================== -->
  <div class="card card-blue">
    <h2 style="color:var(--p)">Consultar Voucher</h2>

    <input id="consultaCodigo" placeholder="Digite o c√≥digo" onkeydown="enterConsultar(event)">
    <button onclick="consultarVoucher()">Consultar</button>

    <div id="consultaResultado"></div>
  </div>

</div>

<!-- ====================================================
     √ÅREA PARA IMPRESS√ÉO DO RESGATE
==================================================== -->
<div id="printArea">
  <h3>Comprovante de Resgate</h3>
  <div id="printContent"></div>
  <p>Data: <span id="printData"></span></p>
</div>

<script>
/* ==========================================================
   SUPABASE
========================================================== */
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

/* ==========================================================
   M√ÅSCARAS
========================================================== */
function maskCPF(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}

function maskPhone(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{2})(\d)/,"($1) $2")
    .replace(/(\d{5})(\d)/,"$1-$2");
}

/* ==========================================================
   GERAR C√ìDIGO ALEAT√ìRIO
========================================================== */
function gerarCodigo(){
  return Math.floor(100000000 + Math.random()*900000000).toString();
}

/* ==========================================================
   EMITIR VOUCHER
========================================================== */
let ultimoVoucher = null;

async function emitirVoucher(){

  let cliente = cliente.value.trim();
  let cpfVal = cpf.value.trim();
  let tel = telefone.value.trim();
  let valorVal = valor.value.trim();

  if(!cliente || !cpfVal || !valorVal){
    alert("Preencha todos os campos obrigat√≥rios!");
    return;
  }

  let codigo = gerarCodigo();
  let agora = new Date().toISOString();

  let { error } = await sb.from("vouchers").insert([{
    codigo,
    cliente,
    cpf: cpfVal,
    telefone: tel,
    valor: valorVal,
    status: "ATIVO",
    data_emissao: agora
  }]);

  if(error){ alert("Erro ao emitir voucher!"); return; }

  ultimoVoucher = { cliente, valor: valorVal, codigo, telefone: tel };

  renderVoucherPNG(cliente, valorVal, codigo);
}

/* ==========================================================
   PNG DO VOUCHER
========================================================== */
function renderVoucherPNG(nome, valor, codigo){

  vouch_nome.innerHTML = "<b>Cliente:</b> " + nome;
  vouch_valor.innerHTML = "<b>Valor:</b> R$ " + valor;
  vouch_codigo.innerHTML = "<b>C√≥digo:</b> " + codigo;

  JsBarcode("#barcode", codigo, { format:"CODE128", width:2, height:40 });

  voucherPNG.style.display = "block";
  btnDownload.style.display = "block";
  btnWhats.style.display = "block";
}

function baixarPNG(){
  html2canvas(document.querySelector("#voucherPNG")).then(canvas=>{
    let link = document.createElement("a");
    link.download = "voucher.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  });
}

/* ==========================================================
   ENVIAR VIA WHATSAPP
========================================================== */
function enviarWhatsapp(){

  if(!ultimoVoucher || !ultimoVoucher.telefone){
    alert("Telefone inv√°lido!");
    return;
  }

  let tel = ultimoVoucher.telefone.replace(/\D/g,"");
  let msg = `Ol√°! Seu voucher foi gerado com sucesso.%0A%0A` +
            `C√≥digo: ${ultimoVoucher.codigo}%0ACliente: ${ultimoVoucher.cliente}%0AValor: R$ ${ultimoVoucher.valor}`;

  window.open(`https://wa.me/55${tel}?text=${msg}`, "_blank");
}

/* ==========================================================
   ENTER = CONSULTAR
========================================================== */
function enterConsultar(e){
  if(e.key === "Enter") consultarVoucher();
}

/* ==========================================================
   CONSULTAR
========================================================== */
async function consultarVoucher(){

  let codigo = consultaCodigo.value.trim();
  if(!codigo) return;

  let { data } = await sb.from("vouchers").select("*").eq("codigo", codigo).limit(1);

  if(!data || data.length === 0){
    consultaResultado.innerHTML = `<div class='result-card'>‚ùå Voucher n√£o encontrado.</div>`;
    return;
  }

  let v = data[0];

  if(v.status === "RESGATADO"){
    consultaResultado.innerHTML = `<div class='result-card'>‚ö† Voucher j√° resgatado.</div>`;
    return;
  }

  consultaResultado.innerHTML = `
    <div class="result-card">
      <b>Cliente:</b> ${v.cliente}<br>
      <b>Valor:</b> R$ ${v.valor}<br>
      <b>Emiss√£o:</b> ${v.data_emissao}<br><br>
      <button onclick="finalizarResgate('${v.codigo}','${v.cliente}',${v.valor})">
        Finalizar / Resgatar
      </button>
    </div>
  `;
}

/* ==========================================================
   RESGATAR + IMPRIMIR COMPROVANTE
========================================================== */
async function finalizarResgate(codigo, cliente, valor){

  await sb.from("vouchers").update({ status:"RESGATADO" }).eq("codigo", codigo);

  consultaResultado.innerHTML = `<div class='result-card'>‚úî Resgatado com sucesso!</div>`;

  gerarComprovante(cliente, valor, codigo);
  imprimirComprovante();
}

function gerarComprovante(cliente, valor, codigo){
  printContent.innerHTML = `
    Cliente: ${cliente}<br>
    Valor: R$ ${valor}<br>
    C√≥digo: ${codigo}<br>
  `;
  printData.innerText = new Date().toLocaleString();
}

function imprimirComprovante(){
  let conteudo = document.getElementById("printArea").innerHTML;
  let win = window.open("", "", "width=300,height=600");
  win.document.write(conteudo);
  win.print();
  win.close();
}

</script>

</body>
</html>

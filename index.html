<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher Mercatto • Sistema Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- FONTES -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<!-- BIBLIOTECAS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>

<style>
:root{
  --preto:#000;
  --gold:#d4af37;
  --gold2:#a88928;
  --white:#ffffffcc;
}

/* Fundo */
body{
  margin:0;
  background:#000;
  overflow:hidden; /* SEM ROLAGEM */
  font-family:"Inter";
}

#bgBlur{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:url('logo.png') center/cover no-repeat;
  filter:blur(7px) brightness(40%);
  z-index:-1;
}

/* LOGIN */
#loginCard{
  width:360px;
  margin:80px auto;
  background:rgba(0,0,0,0.7);
  padding:22px;
  border-radius:12px;
  border:2px solid var(--gold);
}
#loginCard input{
  width:100%;
  padding:10px;
  margin:8px 0;
  border-radius:8px;
  border:1px solid var(--gold2);
  background:#0d0d0d;
  color:white;
}
#loginCard button{
  width:100%;
  padding:12px;
  background:var(--gold);
  border:0;
  border-radius:8px;
  font-weight:700;
}

/* SISTEMA */
#sistema{
  padding:10px 20px;
}
.container{
  display:flex;
  gap:15px;
}

/* Cards */
.card{
  flex:1;
  background:rgba(0,0,0,0.65);
  padding:15px;
  border-radius:10px;
  border:1px solid var(--gold2);
}
.card h2{
  color:var(--gold);
  margin-bottom:10px;
}

input{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid var(--gold2);
  background:#101010;
  color:white;
}

/* BOTÕES */
button{
  padding:10px 16px;
  border-radius:8px;
  background:var(--gold);
  font-weight:700;
  border:0;
  cursor:pointer;
}

/* VOUCHER — CARTÃO HORIZONTAL */
#voucherPNG{
  width:420px;
  height:260px;
  border-radius:18px;
  border:3px solid var(--gold);
  background:#000;
  padding:15px;
  display:none;
  position:relative;
  overflow:hidden;
  margin-top:12px;
}

/* LOGO NO FUNDO DO CARTÃO */
#voucherPNG::before{
  content:"";
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  background:url('logo.png') center/70% no-repeat;
  opacity:0.10;
  z-index:0;
}

#voucherPNG *{
  position:relative;
  z-index:2;
}

#voucherPNG h3{
  font-family:'Great Vibes';
  color:var(--gold);
  font-size:32px;
  text-align:center;
  margin-top:5px;
}

.vLine{
  color:white;
  margin:8px 0;
}

/* BOTÕES DO CARTÃO */
#btnArea{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.result-card{
  padding:12px;
  background:#000000aa;
  border-left:3px solid var(--gold);
  color:white;
  border-radius:8px;
}

/* POPUP */
.popup{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  display:none;
  justify-content:center;
  align-items:center;
  background:rgba(0,0,0,0.65);
}
.popup-box{
  background:#111;
  padding:20px;
  border-radius:10px;
  width:350px;
  border:2px solid var(--gold);
}
.popup-box p{ color:white; }

#overlayLoad{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.7);
  display:none;
  justify-content:center;
  align-items:center;
  color:var(--gold);
  font-size:28px;
  z-index:999;
}
</style>
</head>

<body>

<div id="bgBlur"></div>
<div id="overlayLoad">Processando...</div>

<!-- LOGIN -->
<div id="loginCard">
  <h2 style="text-align:center;color:var(--gold)">Acesso Restrito</h2>
  <input autocomplete="off" id="loginUser" placeholder="Usuário">
  <input autocomplete="off" id="loginPass" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <p id="loginMsg" style="text-align:center;color:#ff4444;margin-top:10px;"></p>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">
  <h1 style="color:var(--gold)">
    Voucher Mercatto — Painel Premium
    <button onclick="logout()" style="float:right;background:#a62828;color:white">Sair</button>
  </h1>

  <div class="container">

    <!-- EMISSÃO -->
    <div class="card">
      <h2>Emitir Voucher</h2>

      <input autocomplete="off" id="cliente" placeholder="Nome">
      <input autocomplete="off" id="cpf" placeholder="CPF">
      <input autocomplete="off" id="telefone" placeholder="Telefone">
      <input autocomplete="off" id="valor" placeholder="Valor">

      <button onclick="emitir()">Emitir Voucher</button>

      <div id="voucherPNG">
        <h3>Voucher Mercatto</h3>
        <p class="vLine" id="vouch_nome"></p>
        <p class="vLine" id="vouch_valor"></p>
        <p class="vLine" id="vouch_codigo"></p>
        <svg id="barcode"></svg>
      </div>

      <div id="btnArea" class="hidden">
        <button onclick="baixarPDF()">Baixar PDF</button>
        <button onclick="enviarWhats()" style="background:#25d366;color:white">WhatsApp</button>
      </div>
    </div>

    <!-- CONSULTA -->
    <div class="card">
      <h2>Consultar Voucher</h2>

      <input autocomplete="off" id="consultaCodigo" placeholder="Código" onkeydown="if(event.key==='Enter')consultar()">
      <button onclick="consultar()">Consultar</button>

      <div id="consultaResultado"></div>
    </div>
  </div>
</div>

<!-- POPUP -->
<div id="popupDetalhes" class="popup">
  <div class="popup-box">
    <h3 style="color:var(--gold)">Detalhes do Voucher</h3>
    <div id="popupContent"></div>
    <button onclick="popupDetalhes.style.display='none'">Fechar</button>
  </div>
</div>

<script>
/* SUPABASE */
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

/* LOGIN */
async function login(){
  let u = loginUser.value.trim();
  let p = loginPass.value.trim();

  const { data } = await sb.from("usuarios").select("*")
     .eq("usuario", u).eq("senha", p);

  if(!data || data.length===0){
    loginMsg.innerText = "Usuário ou senha inválidos";
    return;
  }

  loginCard.style.display = "none";
  sistema.classList.remove("hidden");
}

/* EMITIR */
async function emitir(){
  overlayLoad.style.display="flex";

  let nome = cliente.value.trim();
  let val  = valor.value.replace("R$ ","");

  if(!nome || !val){
    overlayLoad.style.display="none";
    alert("Preencha todos os campos!");
    return;
  }

  /* GERAR CÓDIGO GARANTIDO ÚNICO */
  let codigo;
  while(true){
    let test = String(Math.floor(100000000 + Math.random()*900000000));
    const { data } = await sb.from("vouchers").select("codigo").eq("codigo", test);
    if(!data || data.length===0){
      codigo = test;
      break;
    }
  }

  await sb.from("vouchers").insert([{
    codigo,
    cliente:nome,
    cpf:cpf.value,
    telefone:telefone.value,
    valor:val,
    data_emissao:new Date().toISOString(),
    status:"ATIVO"
  }]);

  overlayLoad.style.display="none";

  voucherAtual = { nome, val, codigo, tel: telefone.value };
  gerarVoucher(voucherAtual);
}

function gerarVoucher(v){
  vouch_nome.innerHTML = `<b>Cliente:</b> ${v.nome}`;
  vouch_valor.innerHTML = `<b>Valor:</b> R$ ${v.val}`;
  vouch_codigo.innerHTML = `<b>Código:</b> ${v.codigo}`;

  JsBarcode("#barcode", v.codigo, {
    format:"CODE128",
    width:2,
    height:40,
    lineColor:"#d4af37",
    background:"transparent"
  });

  voucherPNG.style.display="block";
  btnArea.classList.remove("hidden");
}

/* PDF EM CARTÃO REAL */
function baixarPDF(){
  const { jsPDF } = window.jspdf;

  const largura = 85.6;   /* mm */
  const altura  = 53.98;  /* mm */

  const pdf = new jsPDF({
    orientation:"landscape",
    unit:"mm",
    format:[altura, largura]
  });

  html2canvas(voucherPNG,{scale:3,backgroundColor:null}).then(canvas=>{
    const img = canvas.toDataURL("image/png");
    pdf.addImage(img, "PNG", 0, 0, largura, altura);
    pdf.save("voucher-mercatto.pdf");
  });
}

/* WhatsApp */
function enviarWhats(){
  let tel = voucherAtual.tel.replace(/\D/g,"");
  let msg = `Voucher Mercatto%0ACliente: ${voucherAtual.nome}%0AValor: R$ ${voucherAtual.val}%0ACódigo: ${voucherAtual.codigo}`;
  window.open(`https://wa.me/55${tel}?text=${msg}`, "_blank");
}

/* CONSULTAR */
async function consultar(){
  const { data } = await sb.from("vouchers").select("*")
       .eq("codigo", consultaCodigo.value.trim());

  if(!data || data.length===0){
    consultaResultado.innerHTML = `<div class=result-card>❌ Não encontrado</div>`;
    return;
  }

  let v = data[0];

  if(v.status==="RESGATADO"){
    popupContent.innerHTML = `
      <p><b>Cliente:</b> ${v.cliente}</p>
      <p><b>Valor:</b> R$ ${v.valor}</p>
      <p><b>Emitido:</b> ${new Date(v.data_emissao).toLocaleString("pt-BR")}</p>
      <p><b>Resgatado:</b> ${new Date(v.data_resgate).toLocaleString("pt-BR")}</p>
      <p><b>Responsável:</b> ${v.usuario_resgate}</p>
    `;
    popupDetalhes.style.display="flex";
    return;
  }

  consultaResultado.innerHTML = `
    <div class="result-card">
      <b>Cliente:</b> ${v.cliente}<br>
      <b>Valor:</b> R$ ${v.valor}<br><br>
      <button onclick="resgatar('${v.codigo}')">Resgatar</button>
    </div>
  `;
}

/* RESGATAR */
async function resgatar(codigo){
  let user = loginUser.value.trim();
  await sb.from("vouchers").update({
    status:"RESGATADO",
    data_resgate:new Date().toISOString(),
    usuario_resgate:user
  }).eq("codigo", codigo);

  consultar();
}
</script>

</body>
</html>

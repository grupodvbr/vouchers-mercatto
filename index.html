<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher Mercatto • Sistema Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --preto:#000;
  --gold:#d4af37;
  --gold2:#b08a2e;
  --white:#fff;
  --card:#111;
  --radius:14px;
}

body{
  background:#111;
  margin:0;
  font-family:"Inter";
  color:white;
}

.hidden{display:none}

.container{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:25px;
  padding:25px;
}

/* LOGIN */
#loginCard{
  width:380px;
  margin:120px auto;
  padding:25px;
  border-radius:14px;
  background:#0f0f0f;
  border:2px solid var(--gold2);
}
#loginCard img{
  width:150px;
  display:block;
  margin:0 auto 15px;
}
#loginCard input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  background:#1a1a1a;
  border:1px solid var(--gold2);
  border-radius:10px;
  color:white;
}
#loginCard button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:var(--gold);
  color:black;
  font-weight:700;
}

/* CARDS */
.card{
  background:#0f0f0f;
  border:1px solid var(--gold2);
  border-radius:14px;
  padding:20px;
}

.card h2{
  margin-top:0;
  color:var(--gold);
}

/* Inputs */
input, select{
  width:100%;
  padding:12px;
  border-radius:10px;
  background:#1a1a1a;
  border:1px solid var(--gold2);
  margin-bottom:12px;
  color:white;
}

/* BOTÕES */
button{
  padding:12px 20px;
  border:none;
  border-radius:10px;
  background:var(--gold);
  color:black;
  font-weight:700;
  cursor:pointer;
}

/* ÁREA DO VOUCHER */
#voucherPreview{
  margin-top:20px;
}

/* CARTÃO MODELO B */
.voucherCard{
  width:430px;
  height:260px;
  background:#000;
  display:flex;
  border-radius:14px;
  overflow:hidden;
  border:2px solid var(--gold);
  box-shadow:0 0 20px rgba(212,175,55,0.35);
}

/* FAIXA DOURADA CENTRAL */
.voucherLeft{
  width:160px;
  background:linear-gradient(#d4af37,#b08a2e);
  display:flex;
  justify-content:center;
  align-items:center;
  padding:10px;
}

.voucherLeft img{
  width:120px;
}

.voucherRight{
  flex:1;
  padding:18px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

/* CÓDIGO DE BARRAS */
#cardBarcode{
  width:100%;
  height:55px;
}

/* CONSULTA RESULTADO */
.result-card{
  margin-top:15px;
}

/* LOADER */
#overlayLoad{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  color:var(--gold);
  display:none;
  justify-content:center;
  align-items:center;
  font-size:26px;
  z-index:999;
}

/* POPUP DETALHES */
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  display:none;
  justify-content:center;
  align-items:center;
}
.popup-box{
  width:420px;
  padding:25px;
  background:#111;
  border-radius:14px;
  border:2px solid var(--gold);
}
.popup-box button{
  margin-top:20px;
  width:100%;
}
</style>
</head>

<body>

<div id="overlayLoad">Processando...</div>

<!-- LOGIN -->
<div id="loginCard">
  <img src="logo.png">
  <h2 style="text-align:center;color:var(--gold)">Acesso Restrito</h2>
  <input id="loginUser" placeholder="Usuário">
  <input id="loginPass" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <p id="loginMsg" style="text-align:center;color:#ff4444;margin-top:10px;"></p>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">

  <h1 style="color:var(--gold);text-align:center;margin-top:20px;">
    Voucher Mercatto — Sistema Premium
    <button onclick="logout()" style="float:right;background:#b42b2b;color:white;">Sair</button>
  </h1>

  <div class="container">

    <!-- EMITIR -->
    <div class="card">
      <h2>Emitir Voucher</h2>

      <input id="cliente" placeholder="Nome do Cliente">
      <input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
      <input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
      <input id="valor" placeholder="Valor" oninput="maskValor(this)">
      <select id="formaPagamento">
        <option value="">Forma de Pagamento</option>
        <option value="CRÉDITO">CRÉDITO</option>
        <option value="DÉBITO">DÉBITO</option>
        <option value="PIX">PIX</option>
        <option value="DINHEIRO">DINHEIRO</option>
      </select>

      <button onclick="emitir()">Emitir Voucher</button>

      <div id="voucherPreview"></div>

      <button id="btnDownload" class="hidden" onclick="baixarPNG()">Baixar</button>
      <button id="btnWhats" class="hidden" onclick="enviarWhats()" style="background:#25d366;color:white">WhatsApp</button>
    </div>

    <!-- CONSULTAR -->
    <div class="card">
      <h2>Consultar Voucher</h2>

      <input id="consultaCodigo" placeholder="Código" onkeydown="enterConsulta(event)">
      <button onclick="consultar()">Consultar</button>

      <div id="consultaResultado"></div>
    </div>

  </div>
</div>

<!-- POPUP DETALHES -->
<div id="popupDetalhes" class="popup">
  <div class="popup-box">
    <h3 style="color:var(--gold)">Detalhes do Voucher</h3>
    <div id="popupContent"></div>
    <button onclick="fecharPopup()">Fechar</button>
  </div>
</div>

<!-- ÁREA DE IMPRESSÃO -->
<div id="printArea" class="hidden">
  <div id="printContent"></div>
</div>

<script>

/* ========================= SUPABASE ========================== */
const SUPABASE_URL = "https://ckkqcxbzfkjzicvoeehw.supabase.co";
const SUPABASE_KEY = "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function showLoad(){ overlayLoad.style.display="flex"; }
function hideLoad(){ overlayLoad.style.display="none"; }

/* ========================= LOGIN ========================== */
async function login(){
  showLoad();
  const { data } = await sb.from("usuarios")
    .select("*")
    .eq("usuario", loginUser.value.trim())
    .eq("senha", loginPass.value.trim());
  hideLoad();

  if(!data || data.length===0){
    loginMsg.innerText="Usuário ou senha inválidos";
    return;
  }

  localStorage.setItem("sessionUser", loginUser.value.trim());
  loginCard.classList.add("hidden");
  sistema.classList.remove("hidden");
}

window.onload = ()=>{
  loginCard.classList.remove("hidden");
  sistema.classList.add("hidden");
};

function logout(){
  localStorage.removeItem("sessionUser");
  location.reload();
}

/* ========================= MÁSCARAS ========================== */
function maskCPF(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}
function maskPhone(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{2})(\d)/,"($1) $2")
    .replace(/(\d{5})(\d)/,"$1-$2");
}
function maskValor(el){
  let v = el.value.replace(/\D/g,"");
  v = (v/100).toFixed(2).replace(".",",");
  el.value = "R$ "+v;
}

/* ============ CÓDIGO ÚNICO QUE NUNCA REPETE ============== */
async function gerarCodigoUnico(){
  while(true){
    let c = String(Math.floor(100000000 + Math.random()*900000000));
    let { data } = await sb.from("vouchers").select("codigo").eq("codigo",c);
    if(!data || data.length===0) return c;
  }
}

/* ======================= EMITIR ============================ */
let voucherAtual=null;

async function emitir(){
  showLoad();

  let nome = cliente.value.trim();
  let cpfv = cpf.value.trim();
  let tel = telefone.value.trim();
  let val = valor.value.replace("R$ ","");
  let forma = formaPagamento.value;

  if(!nome || !val || !forma){
    hideLoad();
    alert("Preencha todos os campos!");
    return;
  }

  let codigo = await gerarCodigoUnico();
  let operador = localStorage.getItem("sessionUser");

  const { error } = await sb.from("vouchers").insert([{
    codigo,
    cliente:nome,
    cpf:cpfv,
    telefone:tel,
    valor:val,
    forma_pagamento:forma,
    empresa:"MERCATTO DELÍCIA",
    data_emissao:new Date().toISOString(),
    usuario_emissao:operador,
    status:"ATIVO"
  }]);

  hideLoad();

  if(error){
    alert("⚠ Erro ao registrar");
    return;
  }

  voucherAtual = { nome, tel, val, codigo };

  renderVoucher("#voucherPreview", voucherAtual);

  btnDownload.classList.remove("hidden");
  btnWhats.classList.remove("hidden");
}

/* ================== CARTÃO MODELO B ====================== */
function renderVoucher(container, v){
  document.querySelector(container).innerHTML=`
    <div id="voucherCard" class="voucherCard">
      <div class="voucherLeft">
        <img src="logo.png">
      </div>

      <div class="voucherRight">
        <div>
          <div style="font-size:18px;font-weight:700">${v.nome}</div>
          <div style="margin-top:5px">R$ ${formatarValor(v.val)}</div>
          <div>${formatarTelefone(v.tel)}</div>
        </div>

        <div style="text-align:center">
          <svg id="cardBarcode"></svg>
          <div style="margin-top:5px">${v.codigo}</div>
        </div>
      </div>
    </div>
  `;

  JsBarcode("#cardBarcode", v.codigo, {
    format:"CODE128",
    width:2,
    height:50,
    lineColor:"#d4af37",
    background:"#000"
  });
}

/* =================== CONSULTAR ====================== */
function enterConsulta(e){ if(e.key==="Enter") consultar(); }

async function consultar(){
  showLoad();
  let cod = consultaCodigo.value.trim();
  let { data } = await sb.from("vouchers").select("*").eq("codigo",cod);
  hideLoad();

  if(!data || data.length===0){
    consultaResultado.innerHTML=`<div class="result-card">❌ Não encontrado</div>`;
    return;
  }

  let v=data[0];

  renderVoucher("#consultaResultado", {
    nome:v.cliente,
    tel:v.telefone,
    val:v.valor,
    codigo:v.codigo
  });

  btnDownload.classList.remove("hidden");
  btnWhats.classList.remove("hidden");
}

/* ========= FORMATAÇÕES ========= */
function formatarValor(v){
  return Number(v).toLocaleString("pt-BR",{minimumFractionDigits:2});
}
function formatarTelefone(t){
  return t;
}

/* =================== BAIXAR ====================== */
function baixarPNG(){
  html2canvas(document.querySelector("#voucherCard")).then(canvas=>{
    let a=document.createElement("a");
    a.download="voucher.png";
    a.href=canvas.toDataURL();
    a.click();
  });
}

/* =================== WHATSAPP ====================== */
function enviarWhats(){
  let tel = voucherAtual.tel.replace(/\D/g,"");
  let msg = `Voucher Mercatto%0ACliente: ${voucherAtual.nome}%0AValor: ${formatarValor(voucherAtual.val)}%0ACódigo: ${voucherAtual.codigo}`;
  window.open(`https://wa.me/55${tel}?text=${msg}`,"_blank");
}

/* ========= POPUP RESGATADO ========= */
function fecharPopup(){ popupDetalhes.style.display="none"; }

/* ================= IMPRESSÃO TÉRMICA ================ */

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher • Emissão & Consulta</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="env.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --p:#0b1e39;
  --p2:#102742;
  --blue:#1e3a8a;
  --blue-light:#3b82f6;
  --bg:#eef2f7;
  --card:#fff;
  --border:#d9e0ea;
  --radius:14px;
  --shadow:0 4px 14px rgba(0,0,0,0.08);
}

*{margin:0;padding:0;box-sizing:border-box;font-family:"Inter";}
body{background:var(--bg);padding:25px;}

.hidden{display:none;}

#loginCard{
  width:380px;margin:auto;margin-top:80px;padding:25px;
  background:white;border-radius:14px;box-shadow:var(--shadow);border:1px solid var(--border);
}
#loginCard img{width:130px;display:block;margin:auto;margin-bottom:15px;}
#loginCard input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);margin-bottom:12px;}
#loginCard button{
  width:100%;padding:12px;background:var(--blue);
  border:none;color:white;font-weight:700;border-radius:12px;cursor:pointer;
}
#loginMsg{text-align:center;color:red;margin-top:8px;}

h1{font-size:28px;color:var(--p);margin-bottom:25px;font-weight:800;}

.container{display:grid;grid-template-columns:1fr 1fr;gap:30px;}

.card{
  background:var(--card);padding:25px;border-radius:var(--radius);
  border:1px solid var(--border);box-shadow:var(--shadow);
}
.card-blue{background:#dce7ff;border-left:6px solid var(--blue);}

input,button{font-size:15px;}
input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);margin-bottom:12px;}
button:hover{background:var(--p2);}

.result-card{
  margin-top:15px;padding:18px;background:#eef3ff;
  border-left:6px solid var(--blue);border-radius:12px;
}

#voucherPNG{
  width:330px;padding:20px;background:white;border-radius:15px;
  border:2px solid var(--blue);display:none;margin-top:20px;
}
#voucherPNG img{width:120px;margin:auto;display:block;margin-bottom:10px;}

.popup{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;
}
.popup-box{
  width:480px;background:white;border-radius:12px;padding:25px;
  box-shadow:var(--shadow);border:2px solid var(--blue);
}
.popup h3{margin-bottom:15px;color:var(--blue);}

#printArea{display:none;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginCard">
  <img src="logo.png">
  <h2 style="text-align:center;color:var(--p)">Login do Sistema</h2>

  <input id="loginUser" placeholder="Usuário" autocomplete="off">
  <input id="loginPass" type="password" placeholder="Senha">

  <button onclick="login()">Entrar</button>
  <p id="loginMsg"></p>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">
  <h1>
    <img src="logo.png" style="height:40px;vertical-align:middle;margin-right:10px;">
    Sistema de Vouchers
    <button onclick="logout()" style="float:right;width:auto;background:#c62828">Sair</button>
  </h1>

  <div class="container">

    <!-- EMISSÃO -->
    <div class="card">
      <h2 style="color:var(--p)">Emitir Voucher</h2>

      <input id="cliente" placeholder="Nome do Cliente">
      <input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
      <input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
      <input id="valor" placeholder="Valor do Voucher" oninput="maskValor(this)">

      <button onclick="emitir()">Emitir Voucher</button>

      <div id="voucherPNG">
        <img src="logo.png">
        <h3 style="text-align:center;color:#1e3a8a;">VOUCHER OFICIAL</h3>
        <p id="vouch_nome"></p>
        <p id="vouch_codigo"></p>
        <p id="vouch_valor"></p>
        <svg id="barcode"></svg>
      </div>

      <button id="btnDownload" class="hidden" onclick="baixarPNG()">Baixar PNG</button>
      <button id="btnWhats" class="hidden" style="background:#25d366;margin-top:10px;" onclick="enviarWhats()">Enviar WhatsApp</button>
    </div>

    <!-- CONSULTA -->
    <div class="card card-blue">
      <h2 style="color:var(--p)">Consultar Voucher</h2>

      <input id="consultaCodigo" placeholder="Código" onkeydown="enterConsulta(event)">
      <button onclick="consultar()">Consultar</button>

      <div id="consultaResultado"></div>
    </div>

  </div>
</div>

<!-- POPUP PREMIUM -->
<div id="popupDetalhes" class="popup">
  <div class="popup-box">
    <h3>Detalhes do Voucher</h3>
    <div id="popupContent"></div>
    <br>
    <button onclick="fecharPopup()">Fechar</button>
  </div>
</div>

<!-- IMPRESSÃO -->
<div id="printArea">
  <h3 style="text-align:center">Comprovante de Resgate</h3>
  <div id="printContent"></div>
  <p>Data/Hora: <span id="printData"></span></p>
  <p>Responsável: <span id="printUser"></span></p>
  <br><br>
  ___________________________________<br>
  Assinatura do Cliente
</div>

<!-- =========================================
     FIM DA PARTE 1
========================================= -->
<script>
// ===============================================
// CONFIGURAÇÃO SUPABASE (credenciais no front)
// ===============================================

// COLOQUE SUA URL DO SUPABASE AQUI
const SUPABASE_URL = "https://ckkqcxbzfkjzicvoeehw.supabase.co";

// COLOQUE SUA ANON KEY AQUI
const SUPABASE_KEY = "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


// ===============================================
// LOGIN
// ===============================================
async function login(){
    let user = loginUser.value.trim();
    let pass = loginPass.value.trim();

    if(!user || !pass){
        loginMsg.innerText = "Preencha usuário e senha.";
        return;
    }

    const { data, error } = await sb
        .from("usuarios")
        .select("*")
        .eq("usuario", user)
        .eq("senha", pass)
        .limit(1);

    if(!data || data.length === 0){
        loginMsg.innerText = "Usuário ou senha inválidos.";
        registrarLog("LOGIN_INVALIDO", `Tentativa: ${user}`);
        return;
    }

    localStorage.setItem("sessionUser", user);
    registrarLog("LOGIN_SUCESSO", `Usuário logado: ${user}`);

    loginCard.style.display = "none";
    sistema.classList.remove("hidden");
}

function logout(){
    registrarLog("LOGOUT", "Usuário saiu");
    localStorage.removeItem("sessionUser");
    location.reload();
}

window.onload = () => {
    let s = localStorage.getItem("sessionUser");
    if(s){
        loginCard.style.display = "none";
        sistema.classList.remove("hidden");
    }
};

// ===============================================
// LOGS
// ===============================================
async function registrarLog(tipo, detalhes){
    let usuario = localStorage.getItem("sessionUser") || "DESCONHECIDO";
    await sb.from("logs_sistema").insert([{ tipo, detalhes, usuario }]);
}

// ===============================================
// MÁSCARAS
// ===============================================
function maskCPF(el){
    el.value = el.value.replace(/\D/g,"")
        .replace(/(\d{3})(\d)/,"$1.$2")
        .replace(/(\d{3})(\d)/,"$1.$2")
        .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}

function maskPhone(el){
    el.value = el.value.replace(/\D/g,"")
        .replace(/(\d{2})(\d)/,"($1) $2")
        .replace(/(\d{5})(\d)/,"$1-$2");
}

function maskValor(el){
    let v = el.value.replace(/\D/g,"");
    v = (Number(v) / 100).toFixed(2) + "";
    v = v.replace(".", ",");
    el.value = "R$ " + v;
}

// ===============================================
// GERAR CÓDIGO
// ===============================================
function gerarCodigo(){
    return Math.floor(100000000 + Math.random() * 900000000).toString();
}

// ===============================================
// EMITIR VOUCHER
// ===============================================
let voucherAtual = null;

async function emitir(){
    let nome = cliente.value.trim();
    let cpfVal = cpf.value.trim();
    let tel = telefone.value.trim();
    let val = valor.value.trim();

    if(!nome || !cpfVal || !val){
        alert("Preencha todos os campos.");
        return;
    }

    let codigo = gerarCodigo();
    let agora = new Date().toISOString();

    const { error } = await sb.from("vouchers").insert([{
        codigo,
        cliente: nome,
        cpf: cpfVal,
        telefone: tel,
        valor: val.replace("R$ ",""),
        data_emissao: agora,
        status: "ATIVO"
    }]);

    if(error){
        alert("Erro ao emitir!");
        return;
    }

    registrarLog("EMISSAO", `Código: ${codigo} Cliente: ${nome}`);

    voucherAtual = { codigo, nome, val, tel };

    gerarVoucherPNG(voucherAtual);
}

// ===============================================
// PNG DO VOUCHER
// ===============================================
function gerarVoucherPNG(v){
    vouch_nome.innerHTML = "<b>Cliente:</b> " + v.nome;
    vouch_valor.innerHTML = "<b>Valor:</b> " + valor.value;
    vouch_codigo.innerHTML = "<b>Código:</b> " + v.codigo;

    JsBarcode("#barcode", v.codigo, { format:"CODE128", width:2, height:40 });

    voucherPNG.style.display = "block";
    btnDownload.classList.remove("hidden");
    btnWhats.classList.remove("hidden");

    registrarLog("GEROU_PNG", `Voucher ${v.codigo}`);
}

function baixarPNG(){
    registrarLog("DOWNLOAD_PNG", `Voucher ${voucherAtual.codigo}`);
    html2canvas(voucherPNG).then(canvas=>{
        let link = document.createElement("a");
        link.download = "voucher.png";
        link.href = canvas.toDataURL();
        link.click();
    });
}

function enviarWhats(){
    if(!voucherAtual || !voucherAtual.tel){
        alert("Telefone inválido");
        return;
    }

    let tel = voucherAtual.tel.replace(/\D/g,"");

    let msg =
      `Seu Voucher foi gerado!\n` +
      `Código: ${voucherAtual.codigo}\n` +
      `Cliente: ${voucherAtual.nome}\n` +
      `Valor: ${valor.value}`;

    registrarLog("WHATSAPP", `Enviado para ${tel}`);

    window.open(`https://wa.me/55${tel}?text=${encodeURIComponent(msg)}`, "_blank");
}

// ===============================================
// CONSULTAR
// ===============================================
function enterConsulta(e){
    if(e.key === "Enter") consultar();
}

async function consultar(){
    let cod = consultaCodigo.value.trim();
    if(!cod) return;

    const { data } = await sb.from("vouchers").select("*").eq("codigo", cod).limit(1);

    if(!data || data.length === 0){
        consultaResultado.innerHTML = `<div class="result-card">❌ Voucher não encontrado.</div>`;
        registrarLog("CONSULTA_FALHA", cod);
        return;
    }

    let v = data[0];

    registrarLog("CONSULTA", `Código: ${cod}`);

    if(v.status === "RESGATADO"){
        abrirPopupResgatado(v);
        return;
    }

    consultaResultado.innerHTML = `
        <div class="result-card">
            <b>Cliente:</b> ${v.cliente}<br>
            <b>Valor:</b> R$ ${v.valor}<br>
            <b>Emissão:</b> ${formatarData(v.data_emissao)}<br><br>
            <button onclick="resgatar('${v.codigo}')">Finalizar / Resgatar</button>
        </div>
    `;
}

// ===============================================
// POPUP — Voucher já resgatado
// ===============================================
function abrirPopupResgatado(v){
    popupContent.innerHTML = `
        <p><b>Cliente:</b> ${v.cliente}</p>
        <p><b>Valor:</b> R$ ${v.valor}</p>
        <p><b>Emitido em:</b> ${formatarData(v.data_emissao)}</p>
        <p><b>Resgatado em:</b> ${formatarData(v.data_resgate)}</p>
        <p><b>Responsável:</b> ${v.usuario_resgate}</p>
    `;
    popupDetalhes.style.display = "flex";
}

function fecharPopup(){
    popupDetalhes.style.display = "none";
}

// ===============================================
// RESGATAR
// ===============================================
async function resgatar(codigo){

    let user = localStorage.getItem("sessionUser");
    let agora = new Date().toISOString();

    await sb.from("vouchers")
        .update({
            status: "RESGATADO",
            data_resgate: agora,
            usuario_resgate: user
        })
        .eq("codigo", codigo);

    registrarLog("RESGATE", codigo);

    gerarComprovante(codigo);
    imprimirComprovante();

    consultaResultado.innerHTML = `<div class="result-card">✔ Resgatado com sucesso!</div>`;
}

// ===============================================
// COMPROVANTE IMPRESSO
// ===============================================
async function gerarComprovante(codigo){
    const { data } = await sb.from("vouchers").select("*").eq("codigo", codigo).limit(1);
    let v = data[0];

    printContent.innerHTML = `
        Cliente: ${v.cliente}<br>
        Valor: R$ ${v.valor}<br>
        Código: ${v.codigo}<br>
    `;
    printData.innerText = formatarData(v.data_resgate);
    printUser.innerText = v.usuario_resgate;
}

function imprimirComprovante(){
    let conteudo = printArea.innerHTML;
    let janela = window.open("", "", "width=260,height=600");
    janela.document.write(conteudo);
    janela.print();
    janela.close();
}

// ===============================================
// UTIL
// ===============================================
function formatarData(dt){
    let d = new Date(dt);
    return d.toLocaleString("pt-BR");
}

</script>
</html>

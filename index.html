<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher Mercatto • Painel Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- FONTES -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<!-- BIBLIOTECAS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
/* PALETA */
:root{
  --gold:#d4af37;
  --gold2:#a88928;
  --black:#000000;
  --card:#0a0a0aaa;
  --radius:14px;
}

body{
  margin:0;
  background:url("bg.png") center/cover no-repeat fixed;
  backdrop-filter:blur(6px);
  font-family:"Inter";
  color:white;
}

/* TÍTULO */
header{
  padding:20px;
  font-size:34px;
  font-weight:800;
  color:var(--gold);
  text-shadow:0 0 6px #000;
}

/* GRID PRINCIPAL */
#painel{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:25px;
  padding:20px;
}

/* CARD */
.card{
  background:var(--card);
  border:2px solid var(--gold2);
  border-radius:var(--radius);
  padding:25px;
  backdrop-filter:blur(6px);
  height:370px;
}

/* INPUTS */
.card input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid var(--gold2);
  background:#111;
  color:white;
  outline:none;
}
.card input::placeholder{ color:#bbbbbb99; }

/* BOTÕES */
button{
  padding:12px 20px;
  background:var(--gold);
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:700;
}
button:hover{ background:white; color:black; }

/* ÁREA DO VOUCHER */
#voucherArea{
  width:100%;
  margin-top:5px;
  text-align:center;
}

#voucherCard{
  width:500px;
  height:260px;
  margin:0 auto;
  background:black;
  border:3px solid var(--gold);
  border-radius:18px;
  display:none;
  padding:15px;
  position:relative;
  overflow:hidden;
}

#voucherCard::before{
  content:"";
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  background:url("logo.png") center/70% no-repeat;
  opacity:0.10;
}

/* TEXTO DO VOUCHER */
#voucherCard h3{
  font-family:"Great Vibes";
  font-size:40px;
  color:var(--gold);
  text-align:center;
  margin-top:0;
}

.vline{
  font-size:16px;
  margin:6px 0;
}

#barcode{
  margin-top:10px;
}

/* BOTÕES DO VOUCHER */
#voucherButtons{
  margin-top:15px;
  display:none;
  gap:15px;
  justify-content:center;
  display:flex;
}
</style>
</head>

<body>

<header>
  Voucher Mercatto — Painel Premium
  <button onclick="logout()" style="float:right;background:#b02626;color:white;">Sair</button>
</header>

<div id="painel">

  <!-- CARD EMITIR -->
  <div class="card">
    <h2 style="color:var(--gold);margin-top:0;">Emitir Voucher</h2>

    <input autocomplete="off" id="cliente" placeholder="Nome do Cliente">
    <input autocomplete="off" id="cpf" placeholder="CPF" oninput="maskCPF(this)">
    <input autocomplete="off" id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
    <input autocomplete="off" id="valor" placeholder="Valor" oninput="maskValor(this)">

    <button style="width:100%;margin-top:10px;" onclick="emitir()">Emitir Voucher</button>
  </div>

  <!-- CARD CONSULTA -->
  <div class="card">
    <h2 style="color:var(--gold);margin-top:0;">Consultar Voucher</h2>

    <input autocomplete="off" id="consultaCodigo" placeholder="Código" onkeydown="if(event.key==='Enter') consultar()">
    <button onclick="consultar()">Consultar</button>

    <div id="consultaResultado" style="margin-top:20px;"></div>
  </div>
</div>

<!-- ÁREA DO VOUCHER ABAIXO DOS CARDS -->
<div id="voucherArea">

  <div id="voucherCard">
      <h3>Voucher Mercatto</h3>

      <p class="vline" id="vNome"></p>
      <p class="vline" id="vValor"></p>
      <p class="vline" id="vCodigo"></p>

      <svg id="barcode"></svg>
  </div>

  <div id="voucherButtons">
    <button onclick="baixarPDF()">Baixar PDF</button>
    <button onclick="enviarWhats()" style="background:#25d366;color:white;">WhatsApp</button>
  </div>

</div>

<script>
/* SUPABASE */
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

/* FORMATADOR REAL */
function formatMoney(v){
  return Number(v).toLocaleString("pt-BR",{minimumFractionDigits:2});
}

/* MASKS */
function maskCPF(el){ el.value = el.value.replace(/\D/g,"").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2"); }
function maskPhone(el){ el.value = el.value.replace(/\D/g,"").replace(/(\d{2})(\d)/,"($1) $2").replace(/(\d{5})(\d)/,"$1-$2"); }
function maskValor(el){
  let v = el.value.replace(/\D/g,"");
  v = (v/100).toFixed(2);
  el.value = formatMoney(v);
}

/* --------------------------------------------------------
   CONSULTA CÓDIGO EXISTENTE PARA GARANTIR CÓDIGO ÚNICO
---------------------------------------------------------*/
async function gerarCodigoUnico(){
  let codigo="";
  let existe=true;

  while(existe){
    codigo = String(Math.floor(100000000 + Math.random()*900000000));

    const { data } = await sb.from("vouchers").select("codigo").eq("codigo",codigo);

    if(!data || data.length===0) existe=false;
  }
  return codigo;
}

/* --------------------------------------------------------
   EMITIR VOUCHER
---------------------------------------------------------*/
let voucherAtual=null;

async function emitir(){
  let nome = cliente.value.trim();
  let valRaw = valor.value.replace(/\./g,"").replace(",",".");
  let telefone = document.getElementById("telefone").value;
  let cpf = document.getElementById("cpf").value;

  if(!nome || !valRaw){
    alert("Preencha todos os campos obrigatórios!");
    return;
  }

  let codigo = await gerarCodigoUnico();

  await sb.from("vouchers").insert([{
    codigo,
    cliente:nome,
    cpf,
    telefone,
    valor:valRaw,
    data_emissao:new Date().toISOString(),
    status:"ATIVO"
  }]);

  voucherAtual = { nome, valor:formatMoney(valRaw), codigo, telefone };
  mostrarVoucher();
}

/* --------------------------------------------------------
   MOSTRAR VOUCHER NA ÁREA INFERIOR
---------------------------------------------------------*/
function mostrarVoucher(){
  vNome.innerHTML = `<b>Cliente:</b> ${voucherAtual.nome}`;
  vValor.innerHTML = `<b>Valor:</b> R$ ${voucherAtual.valor}`;
  vCodigo.innerHTML = `<b>Código:</b> ${voucherAtual.codigo}`;

  JsBarcode("#barcode", voucherAtual.codigo,{
    format:"CODE128",
    width:2,
    height:45,
    lineColor:"#d4af37",
    background:"transparent"
  });

  voucherCard.style.display="block";
  voucherButtons.style.display="flex";
}

/* --------------------------------------------------------
   PDF – TAMANHO REAL DO CARTÃO (HORIZONTAL)
---------------------------------------------------------*/
function baixarPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation:"landscape", unit:"mm", format:[85,53] });

  html2canvas(voucherCard).then(canvas=>{
    const img = canvas.toDataURL("image/png");
    pdf.addImage(img,"PNG",0,0,85,53);
    pdf.save("voucher.pdf");
  });
}

/* --------------------------------------------------------
   WHATSAPP
---------------------------------------------------------*/
function enviarWhats(){
  let tel = voucherAtual.telefone.replace(/\D/g,"");
  let msg =
    `Olá! Obrigado pela sua compra na Mercatto!%0A`+
    `Segue o seu voucher:%0A%0A`+
    `Cliente: ${voucherAtual.nome}%0A`+
    `Valor: R$ ${voucherAtual.valor}%0A`+
    `Código: ${voucherAtual.codigo}%0A%0A`+
    `Aproveite e tenha uma excelente experiência!`;

  window.open(`https://wa.me/55${tel}?text=${msg}`,"_blank");
}

/* --------------------------------------------------------
   CONSULTA
---------------------------------------------------------*/
async function consultar(){
  let cod = consultaCodigo.value.trim();
  const { data } = await sb.from("vouchers").select("*").eq("codigo",cod);

  if(!data || data.length===0){
    consultaResultado.innerHTML = "<span style='color:red;'>❌ Não encontrado</span>";
    return;
  }

  let v = data[0];

  consultaResultado.innerHTML =
    `<b>Cliente:</b> ${v.cliente}<br>`+
    `<b>Valor:</b> R$ ${formatMoney(v.valor)}<br>`+
    `<b>Status:</b> ${v.status}`;
}

/* LOGOUT */
function logout(){ localStorage.clear(); location.reload(); }
</script>

</body>
</html>

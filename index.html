<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher Mercatto • Sistema Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{--preto:#000;--preto2:#181818;--gold:#d4af37;--gold2:#b08a2e;--white:#fff;--card:#1a1a1a;--radius:16px;}
*{margin:0;padding:0;box-sizing:border-box;font-family:"Inter";}
body{color:white;}
#bgBlur{position:fixed;inset:0;background:url('logo.jpg') center/cover no-repeat;filter:blur(7px) brightness(35%);z-index:-1;}

.card{background:var(--card);border:1px solid var(--gold2);border-radius:16px;padding:25px;margin-bottom:25px;box-shadow:0 0 20px #0009;}
input,select{width:100%;padding:12px;margin-bottom:12px;border-radius:12px;border:1px solid var(--gold2);background:#111;color:white;}
button{padding:12px 20px;border-radius:12px;background:var(--gold);border:none;font-weight:700;color:black;cursor:pointer;}
button:hover{opacity:0.9;}

#voucherEmitidoWrapper,#voucherConsultaWrapper{margin-top:15px;}

#voucherCard{
  width:360px;height:220px;background:var(--preto2);border-radius:18px;
  display:flex;overflow:hidden;border:2px solid var(--gold);box-shadow:0 0 20px #d4af3744;
}
.v-left{width:38%;background:black;display:flex;align-items:center;justify-content:center;}
.v-left img{width:90%;}
.v-mid{width:10%;background:var(--gold);}
.v-right{width:52%;padding:10px;display:flex;flex-direction:column;justify-content:center;gap:4px;font-size:14px;}

#barcode,#barcodeConsulta{margin-top:5px;}
.voucherBtns{margin-top:10px;display:flex;gap:10px;}

#loginCard{width:400px;margin:120px auto;background:#000000c0;border:1px solid var(--gold2);border-radius:16px;padding:25px;}
#loginCard input{background:#151515;}
.hidden{display:none;}
</style>
</head>

<body>
<div id="bgBlur"></div>

<!-- LOGIN -->
<div id="loginCard">
  <img src="logo.png" style="width:150px;margin:auto;display:block;">
  <h2 style="color:var(--gold);text-align:center;">Acesso Restrito</h2>
  <input id="loginUser" placeholder="Usuário">
  <input id="loginPass" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <p id="loginMsg" style="color:red;text-align:center;margin-top:8px;"></p>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden" style="padding:25px;">
  <h1 style="color:var(--gold);margin-bottom:20px;">
    Voucher Mercatto — Painel Premium
    <button onclick="logout()" style="float:right;background:#b02626;color:white;">Sair</button>
  </h1>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:25px;">

    <!-- EMISSÃO -->
    <div class="card">
      <h2 style="color:var(--gold);">Emitir Voucher</h2>

      <input id="cliente" placeholder="Nome do Cliente">
      <input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
      <input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
      <input id="valor" placeholder="Valor" oninput="maskValor(this)">

      <select id="formaPagamento">
        <option value="">Forma de Pagamento</option>
        <option>CRÉDITO</option><option>DÉBITO</option>
        <option>PIX</option><option>DINHEIRO</option>
      </select>

      <button onclick="emitir()">Emitir Voucher</button>

      <div id="voucherEmitidoWrapper"></div>
    </div>

    <!-- CONSULTA -->
    <div class="card">
      <h2 style="color:var(--gold);">Consultar Voucher</h2>
      <input id="consultaCodigo" placeholder="Código" onkeydown="if(event.key==='Enter')consultar()">
      <button onclick="consultar()">Consultar</button>

      <div id="voucherConsultaWrapper"></div>
    </div>

  </div>
</div>

<script>
const sb = supabase.createClient(
 "https://ckkqcxbzfkjzicvoeehw.supabase.co",
 "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

/* LOGIN */
window.onload=()=>{loginCard.classList.remove("hidden");sistema.classList.add("hidden");};
async function login(){
  let u=loginUser.value.trim(),p=loginPass.value.trim();
  const {data}=await sb.from("usuarios").select("*").eq("usuario",u).eq("senha",p);
  if(!data.length){loginMsg.innerText="Usuário inválido";return;}
  localStorage.setItem("sessionUser",u);
  loginCard.classList.add("hidden");sistema.classList.remove("hidden");
}
function logout(){localStorage.removeItem("sessionUser");location.reload();}

/* MÁSCARAS */
function maskCPF(e){e.value=e.value.replace(/\D/g,"").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2");}
function maskPhone(e){e.value=e.value.replace(/\D/g,"").replace(/(\d{2})(\d)/,"($1) $2").replace(/(\d{5})(\d)/,"$1-$2");}
function maskValor(e){let v=e.value.replace(/\D/g,"");v=(v/100).toFixed(2).replace(".",",");e.value="R$ "+v;}

/* GERA CÓDIGO ÚNICO */
async function gerarCodigoUnico(){
  while(true){
    let c=String(Math.floor(100000000+Math.random()*900000000));
    let {data}=await sb.from("vouchers").select("codigo").eq("codigo",c);
    if(!data.length) return c;
  }
}

/* EMITIR */
async function emitir(){
  let nome=cliente.value.trim(),cpf=window.cpf.value.trim(),
      tel=telefone.value.trim(),val=valor.value.replace("R$ ",""),
      forma=formaPagamento.value,oper=localStorage.getItem("sessionUser");

  if(!nome||!val||!forma){alert("Preencha tudo!");return;}

  let codigo=await gerarCodigoUnico();

  await sb.from("vouchers").insert([{
    codigo,cliente:nome,cpf,telefone:tel,valor:val,
    forma_pagamento:forma,empresa:"MERCATTO DELÍCIA",
    data_emissao:new Date().toISOString(),usuario_emissao:oper,status:"ATIVO"
  }]);

  gerarCartao("voucherEmitidoWrapper",{cliente:nome,valor:val,telefone:tel,codigo});
}

/* CONSULTA */
async function consultar(){
  let cod=consultaCodigo.value.trim();
  let {data}=await sb.from("vouchers").select("*").eq("codigo",cod);

  if(!data.length){
    voucherConsultaWrapper.innerHTML="<p style='color:red;margin-top:10px;'>❌ Não encontrado</p>";return;
  }
  gerarCartao("voucherConsultaWrapper",data[0]);
}

/* GERA O CARTÃO */
function gerarCartao(area,v){
  document.getElementById(area).innerHTML=`
<div id="voucherCard">
  <div class="v-left"><img src="logo.png"></div>
  <div class="v-mid"></div>
  <div class="v-right">
    <b>${v.cliente}</b>
    <span>R$ ${Number(v.valor).toLocaleString("pt-BR",{minimumFractionDigits:2})}</span>
    <span>${v.telefone||""}</span>
    <svg id="barcode-${v.codigo}"></svg>
    <span>${v.codigo}</span>
  </div>
</div>

<div class="voucherBtns">
  <button onclick="baixarPNGCartao('voucherCard','${v.codigo}')">Baixar</button>
  <button onclick="enviarWhats('${v.codigo}','${v.telefone}','${v.cliente}','${v.valor}')" style="background:#25d366;color:white;">WhatsApp</button>
</div>
  `;
  JsBarcode(`#barcode-${v.codigo}`,v.codigo,{format:"CODE128",width:1.3,height:40,lineColor:"#fff"});
}

/* BAIXAR CARTÃO */
function baixarPNGCartao(id,codigo){
  html2canvas(document.getElementById(id)).then(c=>{
    let a=document.createElement("a");
    a.download=`voucher-${codigo}.png`;
    a.href=c.toDataURL();
    a.click();
  });
}

/* WHATSAPP */
function enviarWhats(codigo,tel,nome,valor){
  tel=tel.replace(/\D/g,"");
  let msg=`Voucher Mercatto%0ACódigo: ${codigo}%0ACliente: ${nome}%0AValor: R$ ${valor}`;
  window.open(`https://wa.me/55${tel}?text=${msg}`,"_blank");
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher ‚Ä¢ Login & Sistema</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --p:#0b1e39;
  --p2:#102742;
  --blue:#1e3a8a;
  --blue-light:#3b82f6;
  --bg:#eef2f7;
  --card:#fff;
  --border:#d9e0ea;
  --radius:14px;
  --shadow:0 4px 14px rgba(0,0,0,0.08);
}

*{margin:0;padding:0;box-sizing:border-box;font-family:"Inter";}
body{background:var(--bg);padding:25px;}

.hidden{display:none;}

/* LOGIN CARD */
#loginCard{
  width:380px;
  margin:auto;
  margin-top:80px;
  padding:25px;
  background:white;
  border-radius:14px;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}

#loginCard h2{
  text-align:center;
  margin-bottom:20px;
  color:var(--p);
}

input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  margin-bottom:12px;
}

button{
  padding:12px 22px;
  background:var(--blue);
  border:none;
  color:white;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
  width:100%;
}
button:hover{background:var(--p);}

/* SISTEMA */
h1{
  font-size:28px;color:var(--p);margin-bottom:25px;font-weight:800;
}

.container{
  display:grid;grid-template-columns:1fr 1fr;gap:30px;
}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:25px;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}
.card-blue{
  background:#dce7ff;
  border-left:6px solid var(--blue);
}

.result-card{
  margin-top:15px;
  padding:18px;
  background:#eef3ff;
  border-left:6px solid var(--blue);
  border-radius:12px;
}

#voucherPNG{
  width:330px;
  padding:20px;
  background:white;
  border-radius:15px;
  border:2px solid var(--blue);
  display:none;
  margin-top:20px;
}

</style>
</head>
<body>

<!-- =======================================================
     LOGIN
======================================================= -->
<div id="loginCard">
  <h2>üîê Acesso Restrito</h2>
  <input id="loginUser" placeholder="Usu√°rio" autocomplete="off">
  <input id="loginPass" placeholder="Senha" type="password">
  <button onclick="fazerLogin()">Entrar</button>
  <p id="loginMsg" style="color:red;font-size:14px;margin-top:10px;text-align:center;"></p>
</div>

<!-- =======================================================
     SISTEMA (OCULTO AT√â LOGAR)
======================================================= -->
<div id="sistema" class="hidden">

  <h1>
    üéü Sistema de Vouchers  
    <button onclick="logout()" 
      style="float:right;width:auto;background:#c62828;margin-top:-6px;">
      Sair
    </button>
  </h1>

  <div class="container">

    <!-- EMISS√ÉO -->
    <div class="card">
      <h2 style="color:var(--p)">Emitir Voucher</h2>

      <input id="cliente" placeholder="Nome do Cliente">
      <input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
      <input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
      <input id="valor" placeholder="Valor do Voucher">

      <button onclick="emitirVoucher()">Emitir Voucher</button>

      <div id="voucherPNG">
        <img src="logo.png" style="width:120px;margin:auto;display:block;margin-bottom:10px;">
        <h3 style="text-align:center;color:#1e3a8a;">VOUCHER OFICIAL</h3>
        <p id="vouch_nome"></p>
        <p id="vouch_codigo"></p>
        <p id="vouch_valor"></p>
        <svg id="barcode"></svg>
      </div>

      <button id="btnDownload" style="display:none;margin-top:10px;" onclick="baixarPNG()">Baixar PNG</button>
      <button id="btnWhats" style="display:none;margin-top:10px;background:#25d366;" onclick="enviarWhatsapp()">Enviar WhatsApp</button>
    </div>

    <!-- CONSULTA -->
    <div class="card card-blue">
      <h2 style="color:var(--p)">Consultar Voucher</h2>

      <input id="consultaCodigo" placeholder="Digite o c√≥digo" onkeydown="enterConsultar(event)">
      <button onclick="consultarVoucher()">Consultar</button>

      <div id="consultaResultado"></div>
    </div>

  </div>
</div>

<!-- √ÅREA DE IMPRESS√ÉO -->
<div id="printArea" class="hidden">
  <h3>Comprovante de Resgate</h3>
  <div id="printContent"></div>
  <p>Data: <span id="printData"></span></p>
</div>


<script>
/* ==========================================================
   SUPABASE
========================================================== */
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

/* ==========================================================
   LOGIN & SESS√ÉO
========================================================== */
async function fazerLogin(){

  let u = loginUser.value.trim();
  let s = loginPass.value.trim();

  if(!u || !s){
    loginMsg.innerText = "Preencha usu√°rio e senha.";
    return;
  }

  const { data, error } = await sb
    .from("usuarios")
    .select("*")
    .eq("usuario", u)
    .eq("senha", s)
    .limit(1);

  if(!data || data.length === 0){
    loginMsg.innerText = "Usu√°rio ou senha inv√°lidos.";
    registrarLog("LOGIN_INVALIDO", "Tentativa com usu√°rio: " + u);
    return;
  }

  localStorage.setItem("sessionUser", u);
  registrarLog("LOGIN_SUCESSO", "Usu√°rio logado: " + u);

  loginCard.style.display = "none";
  sistema.classList.remove("hidden");
}

function logout(){
  registrarLog("LOGOUT", "Usu√°rio saiu do sistema");
  localStorage.removeItem("sessionUser");
  location.reload();
}

window.onload = ()=>{
  let s = localStorage.getItem("sessionUser");
  if(s){
    loginCard.style.display = "none";
    sistema.classList.remove("hidden");
  }
};

/* ==========================================================
   REGISTRO DE LOGS
========================================================== */
async function registrarLog(tipo, detalhes){

  await sb.from("logs_sistema").insert([{
    tipo,
    detalhes,
    usuario: localStorage.getItem("sessionUser") || "DESCONHECIDO"
  }]);
}

/* ==========================================================
   M√ÅSCARAS
========================================================== */
function maskCPF(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}
function maskPhone(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{2})(\d)/,"($1) $2")
    .replace(/(\d{5})(\d)/,"$1-$2");
}

/* ==========================================================
   GERAR C√ìDIGO ALEAT√ìRIO
========================================================== */
function gerarCodigo(){
  return Math.floor(100000000 + Math.random()*900000000).toString();
}

/* ==========================================================
   EMISS√ÉO
========================================================== */
let ultimoVoucher = null;

async function emitirVoucher(){

  let nome = cliente.value.trim();
  let cpfVal = cpf.value.trim();
  let tel = telefone.value.trim();
  let val = valor.value.trim();

  if(!nome || !cpfVal || !val){ alert("Preencha todos os campos."); return; }

  let codigo = gerarCodigo();

  let { error } = await sb.from("vouchers").insert([{
    codigo,
    cliente: nome,
    cpf: cpfVal,
    telefone: tel,
    valor: val,
    status: "ATIVO"
  }]);

  if(error){ alert("Erro ao emitir!"); return; }

  registrarLog("EMISSAO", `Voucher ${codigo} emitido para ${nome}`);

  ultimoVoucher = { nome, val, codigo, tel };

  gerarVoucherPNG(nome, val, codigo);
}

/* ==========================================================
   GERAR PNG
========================================================== */
function gerarVoucherPNG(nome, valor, codigo){

  vouch_nome.innerHTML = "<b>Cliente:</b> " + nome;
  vouch_valor.innerHTML = "<b>Valor:</b> R$ " + valor;
  vouch_codigo.innerHTML = "<b>C√≥digo:</b> " + codigo;

  JsBarcode("#barcode", codigo, { format:"CODE128", width:2, height:40 });

  voucherPNG.style.display = "block";
  btnDownload.style.display = "block";
  btnWhats.style.display = "block";

  registrarLog("GEROU_PNG", `Voucher ${codigo}`);
}

function baixarPNG(){
  registrarLog("DOWNLOAD_PNG", `Voucher baixado: ${ultimoVoucher.codigo}`);

  html2canvas(voucherPNG).then(canvas=>{
    let link = document.createElement("a");
    link.download = "voucher.png";
    link.href = canvas.toDataURL();
    link.click();
  });
}

/* ==========================================================
   WHATSAPP
========================================================== */
function enviarWhatsapp(){
  if(!ultimoVoucher || !ultimoVoucher.tel){
    alert("Telefone inv√°lido."); return;
  }

  registrarLog("WHATSAPP", `Voucher enviado para ${ultimoVoucher.tel}`);

  let tel = ultimoVoucher.tel.replace(/\D/g,"");
  let msg = `Seu voucher foi gerado!%0A` +
            `C√≥digo: ${ultimoVoucher.codigo}%0A` +
            `Cliente: ${ultimoVoucher.nome}%0AValor: R$ ${ultimoVoucher.val}`;

  window.open(`https://wa.me/55${tel}?text=${msg}`, "_blank");
}

/* ==========================================================
   CONSULTA
========================================================== */
function enterConsultar(e){
  if(e.key === "Enter") consultarVoucher();
}

async function consultarVoucher(){

  let codigo = consultaCodigo.value.trim();
  if(!codigo) return;

  let { data } = await sb.from("vouchers").select("*").eq("codigo", codigo).limit(1);

  if(!data || data.length === 0){
    consultaResultado.innerHTML = `<div class='result-card'>‚ùå Voucher n√£o encontrado.</div>`;
    registrarLog("CONSULTA_FALHA", codigo);
    return;
  }

  let v = data[0];

  if(v.status === "RESGATADO"){
    consultaResultado.innerHTML = `<div class='result-card'>‚ö† Voucher j√° resgatado.</div>`;
    return;
  }

  registrarLog("CONSULTA_SUCESSO", codigo);

  consultaResultado.innerHTML = `
    <div class="result-card">
      <b>Cliente:</b> ${v.cliente}<br>
      <b>Valor:</b> ${v.valor}<br>
      <b>Emiss√£o:</b> ${v.data_emissao}<br><br>
      <button onclick="resgatar('${v.codigo}','${v.cliente}',${v.valor})">
        Finalizar / Resgatar
      </button>
    </div>
  `;
}

/* ==========================================================
   RESGATE + IMPRESS√ÉO
========================================================== */
async function resgatar(codigo, cliente, valor){

  await sb.from("vouchers").update({status:"RESGATADO"}).eq("codigo", codigo);

  registrarLog("RESGATE", `Voucher ${codigo} - Cliente ${cliente}`);

  consultaResultado.innerHTML = `<div class='result-card'>‚úî Resgatado com sucesso!</div>`;

  gerarComprovante(cliente, valor, codigo);
  imprimirComprovante();
}

function gerarComprovante(cliente, valor, codigo){

  printContent.innerHTML = `
    Cliente: ${cliente}<br>
    Valor: R$ ${valor}<br>
    C√≥digo: ${codigo}<br>
  `;
  printData.innerText = new Date().toLocaleString();
}

function imprimirComprovante(){

  registrarLog("IMPRIMIR_RESUMO", `Impress√£o do comprovante`);

  let conteudo = printArea.innerHTML;
  let janela = window.open("", "", "width=300,height=600");

  janela.document.write(conteudo);
  janela.print();
  janela.close();
}

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher Mercatto ‚Ä¢ Sistema Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- FONTES -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<!-- LIBS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
/* ============================================================
   üé® PALETA PREMIUM BLACK & GOLD
============================================================ */
:root{
  --preto:#000;
  --preto2:#121212;
  --gold:#d4af37;
  --gold2:#b08a2e;
  --white:#ffffffdd;
  --card:#1a1a1a;
  --radius:16px;
  --shadow:0 0 25px rgba(0,0,0,0.5);
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:"Inter";
  color:var(--white);
}

/* BG */
#bgBlur{
  position:fixed;
  inset:0;
  background:url('logo.jpg') center/cover no-repeat;
  filter:blur(7px) brightness(35%);
  z-index:-1;
}

/* LOGIN */
#loginCard{
  width:400px;margin:110px auto;
  padding:28px;
  background:rgba(20,20,20,0.85);
  border-radius:var(--radius);
  border:2px solid var(--gold2);
  box-shadow:var(--shadow);
}
#loginCard img{
  width:160px;display:block;margin:auto;margin-bottom:15px;
}
#loginCard input{
  width:100%;padding:14px;margin-bottom:14px;
  background:#161616;border:1px solid #6e5a1a;
  color:white;border-radius:12px;font-size:15px;
}
#loginCard button{
  width:100%;padding:14px;border-radius:14px;
  background:var(--gold);border:none;color:black;
  font-size:17px;font-weight:700;
  cursor:pointer;
}

/* SISTEMA */
.hidden{display:none;}

.container{
  display:grid;grid-template-columns:1fr 1fr;gap:28px;
}

.card{
  background:var(--card);
  padding:26px;border-radius:var(--radius);
  border:1px solid var(--gold2);
  box-shadow:var(--shadow);
}

.card h2{
  color:var(--gold);
  margin-bottom:18px;
  font-size:22px;
  font-weight:700;
}

input, select{
  width:100%;padding:13px;margin-bottom:13px;
  border:1px solid var(--gold2);
  background:#1a1a1a;color:white;border-radius:12px;
  font-size:15px;
}

button{
  padding:13px 22px;border-radius:12px;
  background:var(--gold);color:black;font-size:15px;
  border:none;font-weight:700;cursor:pointer;
}

/* CART√ÉO - CONSULTA */
#voucherConsultaWrapper{
  margin-top:20px;
}

#voucherConsultaCard{
  width:360px;
  height:220px;
  background:var(--preto2);
  border-radius:18px;
  margin-top:8px;
  border:2px solid var(--gold);
  display:flex;
  overflow:hidden;
  box-shadow:0 0 25px rgba(212,175,55,0.35);
}

.v-left{
  width:38%;
  background:var(--preto);
  display:flex;
  align-items:center;
  justify-content:center;
}
.v-left img{
  width:90%;
}

.v-mid{
  width:10%;
  background:var(--gold);
}

.v-right{
  width:52%;
  padding:12px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  gap:4px;
  font-size:14px;
}

#barcodeConsulta{
  margin-top:6px;
}

/* BOTOÃÉES CONSULTA */
.voucherBtns{
  margin-top:12px;
  display:flex;
  gap:10px;
}

/* POPUP */
.popup{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.7);
  display:none;justify-content:center;align-items:center;
}
.popup-box{
  background:#111;padding:26px;width:420px;border-radius:14px;
  border:2px solid var(--gold);
}

/* Loader */
#overlayLoad{
  position:fixed;inset:0;
  display:none;justify-content:center;align-items:center;
  background:rgba(0,0,0,0.75);
  color:var(--gold);font-size:26px;
}
</style>
</head>

<body>

<!-- BG -->
<div id="bgBlur"></div>
<div id="overlayLoad">Processando...</div>

<!-- LOGIN -->
<div id="loginCard">
  <img src="logo.png">
  <h2 style="color:var(--gold);text-align:center;">Acesso Restrito</h2>

  <input id="loginUser" placeholder="Usu√°rio">
  <input id="loginPass" type="password" placeholder="Senha">

  <button onclick="login()">Entrar</button>
  <p id="loginMsg" style="text-align:center;color:#ff6666;margin-top:10px;"></p>
</div>

<!-- SISTEMA -->
<div id="sistema" class="hidden">
  <h1 style="color:var(--gold);margin-bottom:22px;">
    Voucher Mercatto ‚Äî Sistema Premium
    <button onclick="logout()" style="float:right;background:#b02626;color:white;">Sair</button>
  </h1>

  <div class="container">

    <!-- EMISS√ÉO -->
    <div class="card">
      <h2>Emitir Voucher</h2>

      <input id="cliente" placeholder="Nome do Cliente">
      <input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
      <input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
      <input id="valor" placeholder="Valor" oninput="maskValor(this)">
      
      <select id="formaPagamento">
        <option value="">Forma de Pagamento</option>
        <option value="CR√âDITO">Cr√©dito</option>
        <option value="D√âBITO">D√©bito</option>
        <option value="PIX">PIX</option>
        <option value="DINHEIRO">Dinheiro</option>
      </select>

      <button onclick="emitir()">Emitir Voucher</button>

      <div id="voucherPNG" style="display:none;"></div>

      <button id="btnDownload" class="hidden" onclick="baixarPNG()">Baixar PNG</button>
      <button id="btnWhats" class="hidden" onclick="enviarWhats()" style="background:#25d366;color:white;">WhatsApp</button>
    </div>

    <!-- CONSULTA -->
    <div class="card">
      <h2>Consultar Voucher</h2>
      <input id="consultaCodigo" placeholder="C√≥digo" onkeydown="enterConsulta(event)">
      <button onclick="consultar()">Consultar</button>

      <div id="voucherConsultaWrapper"></div>
    </div>

  </div>
</div>

<!-- POPUP -->
<div id="popupDetalhes" class="popup">
  <div class="popup-box">
    <h3 style="color:var(--gold);">Detalhes do Voucher</h3>
    <div id="popupContent"></div>
    <button onclick="fecharPopup()" style="margin-top:15px;background:var(--gold);color:black;">Fechar</button>
  </div>
</div>

<!-- IMPRESS√ÉO -->
<div id="printArea" class="hidden"><div id="printContent"></div></div>

<script>
/* ============================================================
   SUPABASE
============================================================ */
const sb = supabase.createClient(
  "https://ckkqcxbzfkjzicvoeehw.supabase.co",
  "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m"
);

/* LOGIN */
window.onload = ()=>{
  loginCard.classList.remove("hidden");
  sistema.classList.add("hidden");
};
async function login(){
  let u = loginUser.value.trim();
  let p = loginPass.value.trim();

  const { data } = await sb.from("usuarios").select("*")
    .eq("usuario",u).eq("senha",p);

  if(!data || data.length===0){
    loginMsg.innerText="Usu√°rio ou senha inv√°lidos";
    return;
  }

  localStorage.setItem("sessionUser",u);
  loginCard.classList.add("hidden");
  sistema.classList.remove("hidden");
}
function logout(){
  localStorage.removeItem("sessionUser");
  location.reload();
}

/* M√ÅSCARAS */
function maskCPF(el){
  el.value = el.value.replace(/\D/g,"")
  .replace(/(\d{3})(\d)/,"$1.$2")
  .replace(/(\d{3})(\d)/,"$1.$2")
  .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}
function maskPhone(el){
  el.value = el.value.replace(/\D/g,"")
  .replace(/(\d{2})(\d)/,"($1) $2")
  .replace(/(\d{5})(\d)/,"$1-$2");
}
function maskValor(el){
  let v = el.value.replace(/\D/g,"");
  v = (v/100).toFixed(2).replace(".",",");
  el.value = "R$ "+v;
}

/* C√ìDIGO √öNICO */
async function gerarCodigoUnico(){
  while(true){
    let codigo = String(Math.floor(100000000 + Math.random()*900000000));
    const { data } = await sb.from("vouchers").select("codigo").eq("codigo",codigo);
    if(!data || data.length===0) return codigo;
  }
}

/* EMITIR */
async function emitir(){
  let nome=cliente.value.trim();
  let cpfv=cpf.value.trim();
  let tel=telefone.value.trim();
  let val=valor.value.replace("R$ ","");
  let forma=formaPagamento.value;
  let operador=localStorage.getItem("sessionUser");

  if(!nome || !val || !forma){
    alert("Preencha todos os campos!");
    return;
  }

  let codigo = await gerarCodigoUnico();

  const { error } = await sb.from("vouchers").insert([{
    codigo,
    cliente:nome,
    cpf:cpfv,
    telefone:tel,
    valor:val,
    forma_pagamento:forma,
    empresa:"MERCATTO DEL√çCIA",
    data_emissao:new Date().toISOString(),
    usuario_emissao:operador,
    status:"ATIVO"
  }]);

  if(error){
    alert("Erro ao registrar!");
    return;
  }

  alert("Voucher emitido!");
}

/* CONSULTA */
function enterConsulta(e){ if(e.key==="Enter") consultar(); }

async function consultar(){
  let cod = consultaCodigo.value.trim();
  const { data } = await sb.from("vouchers").select("*").eq("codigo",cod);

  if(!data || data.length===0){
    voucherConsultaWrapper.innerHTML="<div style='margin-top:10px;color:red;'>‚ùå N√£o encontrado</div>";
    return;
  }

  gerarCartaoConsulta(data[0]);
}

/* CART√ÉO DE CONSULTA COM DOWNLOAD + WHATSAPP */
function gerarCartaoConsulta(v){
  voucherConsultaWrapper.innerHTML = `
    <div id="voucherConsultaCard">
      <div class="v-left">
        <img src="logo.png">
      </div>

      <div class="v-mid"></div>

      <div class="v-right">
        <b>${v.cliente}</b>
        <span>R$ ${Number(v.valor).toLocaleString("pt-BR",{minimumFractionDigits:2})}</span>
        <span>${v.telefone || ""}</span>

        <svg id="barcodeConsulta"></svg>
        <span>${v.codigo}</span>
      </div>
    </div>

    <div class="voucherBtns">
      <button onclick="baixarConsultaPNG('${v.codigo}')">Baixar Cart√£o</button>
      <button onclick="whatsConsulta('${v.codigo}','${v.telefone}','${v.cliente}','${v.valor}')" style="background:#25d366;color:white;">WhatsApp</button>
    </div>
  `;

  JsBarcode("#barcodeConsulta", v.codigo,{
    format:"CODE128",
    width:1.4,
    height:40,
    lineColor:"#ffffff"
  });
}

/* BAIXAR PNG DO CART√ÉO */
function baixarConsultaPNG(codigo){
  let card = document.getElementById("voucherConsultaCard");

  html2canvas(card).then(canvas=>{
    let a = document.createElement("a");
    a.download = `voucher-${codigo}.png`;
    a.href = canvas.toDataURL();
    a.click();
  });
}

/* WHATSAPP */
function whatsConsulta(codigo, telefone, nome, valor){
  let tel = telefone.replace(/\D/g,"");
  let msg = 
`Voucher Mercatto%0A
C√≥digo: ${codigo}%0A
Cliente: ${nome}%0A
Valor: R$ ${valor}`;

  window.open(`https://wa.me/55${tel}?text=${msg}`,"_blank");
}

/* POPUP */
function fecharPopup(){ popupDetalhes.style.display="none"; }
</script>

</body>
</html>

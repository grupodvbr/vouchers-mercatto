<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Voucher Mercatto ‚Ä¢ Sistema Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- FONTES -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<!-- BIBLIOTECAS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
/* ============================================================
   üé® PALETA PREMIUM BLACK & GOLD
============================================================ */
:root{
  --preto:#0a0a0a;
  --preto2:#111;
  --gold:#d4af37;
  --gold2:#b08a2e;
  --white:#ffffffdd;
  --card:#0f0f0f;
  --radius:14px;
  --shadow:0 0 25px rgba(0,0,0,0.4);
}

*{margin:0;padding:0;box-sizing:border-box;font-family:"Inter";}

body{
  background:var(--preto);
  color:white;
  padding:25px;
}

/* =========================== LOADING =========================== */
#overlayLoad{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.7);
  display:none;
  justify-content:center;align-items:center;
  color:var(--gold);
  font-size:26px;
  font-weight:700;
  z-index:9999;
}

/* =========================== LOGIN =========================== */
#loginCard{
  width:380px;
  margin:auto;margin-top:70px;
  background:var(--card);
  padding:25px;
  border-radius:var(--radius);
  border:2px solid var(--gold);
  box-shadow:var(--shadow);
}

#loginCard img{
  width:130px;display:block;margin:auto;margin-bottom:15px;
}

#loginCard input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  background:#1a1a1a;
  border:1px solid var(--gold2);
  color:white;
  border-radius:10px;
}

#loginCard button{
  width:100%;padding:12px;
  background:var(--gold);
  border:none;color:black;
  font-weight:700;
  border-radius:12px;
  cursor:pointer;
  font-size:17px;
}
#loginMsg{text-align:center;color:#ff4444;margin-top:6px;}

/* ===================== SISTEMA ====================== */
.hidden{display:none;}

h1{
  color:var(--gold);
  font-size:30px;
  font-weight:800;
  margin-bottom:20px;
}

.container{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:25px;
}

.card{
  background:var(--card);
  padding:22px;
  border-radius:var(--radius);
  border:1px solid var(--gold2);
  box-shadow:var(--shadow);
}

.card h2{
  color:var(--gold);
  margin-bottom:15px;
}

/* Campos */
input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:10px;
  border:1px solid var(--gold2);
  background:#1a1a1a;
  color:white;
}

button{
  padding:12px 22px;
  background:var(--gold);
  color:black;
  border:none;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  transition:.2s;
}
button:hover{background:var(--white);color:black;}

/* Resultado */
.result-card{
  margin-top:10px;
  padding:15px;
  border-left:4px solid var(--gold);
  background:#1c1c1c;
  border-radius:10px;
}

/* ===================== VOUCHER PRETO & DOURADO ===================== */
#voucherPNG{
  width:320px;
  padding:25px;
  background:black;
  display:none;
  border-radius:14px;
  border:2px solid var(--gold);
  box-shadow:0 0 25px rgba(212,175,55,0.3);
}

#voucherPNG h3{
  font-family:'Great Vibes', cursive;
  font-size:32px;
  color:var(--gold);
  text-align:center;
  margin-bottom:10px;
}

/* Popup */
.popup{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.7);
  display:none;justify-content:center;align-items:center;
}
.popup-box{
  background:#111;border:2px solid var(--gold);
  padding:25px;border-radius:12px;width:420px;
}
.popup-box p{margin-bottom:6px;color:white;}

/* Impress√£o */
#printArea{display:none;}
</style>
</head>
<body>

<div id="overlayLoad">Processando...</div>

<!-- ================= LOGIN ================= -->
<div id="loginCard">
  <img src="logo.png">
  <h2 style="color:var(--gold);text-align:center;">Acesso Restrito</h2>

  <input id="loginUser" placeholder="Usu√°rio">
  <input id="loginPass" type="password" placeholder="Senha">

  <button onclick="login()">Entrar</button>
  <p id="loginMsg"></p>
</div>

<!-- ================= SISTEMA ================= -->
<div id="sistema" class="hidden">

  <h1>
    Voucher Mercatto ‚Äî Painel Premium
    <button onclick="logout()" style="float:right;background:#b02626;color:white;">Sair</button>
  </h1>

  <div class="container">

    <!-- Emiss√£o -->
    <div class="card">
      <h2>Emitir Voucher</h2>

      <input id="cliente" placeholder="Nome do Cliente">
      <input id="cpf" placeholder="CPF" oninput="maskCPF(this)">
      <input id="telefone" placeholder="Telefone" oninput="maskPhone(this)">
      <input id="valor" placeholder="Valor" oninput="maskValor(this)">

      <button onclick="emitir()">Emitir Voucher</button>

      <div id="voucherPNG">
        <h3>Voucher Mercatto</h3>
        <p id="vouch_nome"></p>
        <p id="vouch_codigo"></p>
        <p id="vouch_valor"></p>
        <svg id="barcode"></svg>
      </div>

      <button id="btnDownload" class="hidden" onclick="baixarPNG()">Baixar PNG</button>
      <button id="btnWhats" class="hidden" onclick="enviarWhats()" style="background:#25d366;color:white;">WhatsApp</button>
    </div>

    <!-- Consulta -->
    <div class="card">
      <h2>Consultar Voucher</h2>

      <input id="consultaCodigo" placeholder="C√≥digo" onkeydown="enterConsulta(event)">
      <button onclick="consultar()">Consultar</button>

      <div id="consultaResultado"></div>
    </div>

  </div>
</div>

<!-- Popup -->
<div id="popupDetalhes" class="popup">
  <div class="popup-box">
    <h3 style="color:var(--gold);">Detalhes do Voucher</h3>
    <div id="popupContent"></div>
    <button onclick="fecharPopup()">Fechar</button>
  </div>
</div>

<!-- Impress√£o -->
<div id="printArea">
  <h3 style="font-family:'Great Vibes';color:black;text-align:center;font-size:28px;">Voucher Mercatto</h3>
  <div id="printContent"></div>
  <p>Data/Hora: <span id="printData"></span></p>
  <p>Respons√°vel: <span id="printUser"></span></p>
  <br><br>
  __________________________<br>
  Assinatura
</div>

<script>
/* ====================== SUPABASE ======================= */
const SUPABASE_URL = "https://ckkqcxbzfkjzicvoeehw.supabase.co";
const SUPABASE_KEY = "sb_publishable_djiQsCSrnLUm0iA_eNjjMw__7rfP11m";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ====================== LOADING ======================= */
function showLoad(){ overlayLoad.style.display="flex"; }
function hideLoad(){ overlayLoad.style.display="none"; }

/* ====================== LOGIN ======================= */
async function login(){
  showLoad();

  let u = loginUser.value.trim();
  let p = loginPass.value.trim();

  const { data, error } = await sb
    .from("usuarios")
    .select("*")
    .eq("usuario", u)
    .eq("senha", p);

  hideLoad();

  if (error){
    loginMsg.innerText = "Erro no banco. Crie pol√≠tica SELECT em usuarios.";
    return;
  }

  if (!data || data.length === 0){
    loginMsg.innerText = "Usu√°rio ou senha inv√°lidos.";
    return;
  }

  localStorage.setItem("sessionUser", u);

  loginCard.style.display = "none";
  sistema.classList.remove("hidden");
}

function logout(){
  localStorage.removeItem("sessionUser");
  location.reload();
}

window.onload = () => {
  if(localStorage.getItem("sessionUser")){
    loginCard.style.display = "none";
    sistema.classList.remove("hidden");
  }
};

/* ====================== M√ÅSCARAS ======================= */
function maskCPF(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d)/,"$1.$2")
    .replace(/(\d{3})(\d{1,2})$/,"$1-$2");
}
function maskPhone(el){
  el.value = el.value.replace(/\D/g,"")
    .replace(/(\d{2})(\d)/,"($1) $2")
    .replace(/(\d{5})(\d)/,"$1-$2");
}
function maskValor(el){
  let v = el.value.replace(/\D/g,"");
  v = (v/100).toFixed(2).replace(".",",");
  el.value = "R$ " + v;
}

/* ====================== EMITIR ======================= */
let voucherAtual = null;

async function emitir(){
  showLoad();

  let nome=cliente.value; 
  let cpfVal=cpf.value; 
  let tel=telefone.value;
  let val=valor.value.replace("R$ ","");

  let codigo = (Math.floor(100000000 + Math.random()*900000000)).toString();

  await sb.from("vouchers").insert([{
    codigo,
    cliente:nome,
    cpf:cpfVal,
    telefone:tel,
    valor:val,
    data_emissao:new Date().toISOString(),
    status:"ATIVO"
  }]);

  voucherAtual = { nome, val, codigo, tel };

  gerarVoucherPNG(voucherAtual);
  hideLoad();
}

/* ====================== PNG ======================= */
function gerarVoucherPNG(v){
  vouch_nome.innerHTML = "<b>Cliente:</b> " + v.nome;
  vouch_valor.innerHTML = "<b>Valor:</b> R$ "+v.val;
  vouch_codigo.innerHTML = "<b>C√≥digo:</b> "+v.codigo;

  JsBarcode("#barcode", v.codigo,{
    format:"CODE128",
    width:2,
    height:40,
    background:"black",
    lineColor:"#d4af37"
  });

  voucherPNG.style.display="block";
  btnDownload.classList.remove("hidden");
  btnWhats.classList.remove("hidden");
}

function baixarPNG(){
  html2canvas(voucherPNG).then(canvas=>{
    let link=document.createElement("a");
    link.download="voucher.png";
    link.href=canvas.toDataURL();
    link.click();
  });
}

function enviarWhats(){
  let tel = voucherAtual.tel.replace(/\D/g,"");
  let msg = `Voucher Mercatto%0A`+
            `C√≥digo: ${voucherAtual.codigo}%0A`+
            `Cliente: ${voucherAtual.nome}%0A`+
            `Valor: R$ ${voucherAtual.val}`;
  window.open(`https://wa.me/55${tel}?text=${msg}`,"_blank");
}

/* ====================== CONSULTAR ======================= */
function enterConsulta(e){ if(e.key==="Enter") consultar(); }

async function consultar(){
  showLoad();
  let cod = consultaCodigo.value.trim();

  const { data } = await sb.from("vouchers").select("*").eq("codigo", cod);
  hideLoad();

  if(!data || data.length===0){
    consultaResultado.innerHTML=`<div class="result-card">‚ùå N√£o encontrado</div>`;
    return;
  }

  let v=data[0];

  if(v.status==="RESGATADO"){
    abrirPopupResgatado(v);
    return;
  }

  consultaResultado.innerHTML = `
    <div class="result-card">
      <b>Cliente:</b> ${v.cliente}<br>
      <b>Valor:</b> R$ ${v.valor}<br><br>
      <button onclick="resgatar('${v.codigo}')">Resgatar</button>
    </div>
  `;
}

/* ====================== POPUP ======================= */
function abrirPopupResgatado(v){
  popupContent.innerHTML = `
    <p><b>Cliente:</b> ${v.cliente}</p>
    <p><b>Valor:</b> R$ ${v.valor}</p>
    <p><b>Emitido:</b> ${formatarData(v.data_emissao)}</p>
    <p><b>Resgatado:</b> ${formatarData(v.data_resgate)}</p>
    <p><b>Respons√°vel:</b> ${v.usuario_resgate}</p>
  `;
  popupDetalhes.style.display="flex";
}
function fecharPopup(){ popupDetalhes.style.display="none"; }

/* ====================== RESGATAR ======================= */
async function resgatar(codigo){
  showLoad();

  let user = localStorage.getItem("sessionUser");
  let agora = new Date().toISOString();

  await sb.from("vouchers").update({
    status:"RESGATADO",
    data_resgate:agora,
    usuario_resgate:user
  }).eq("codigo",codigo);

  gerarComprovante(codigo);
  imprimirComprovante();

  hideLoad();
}

/* ====================== COMPROVANTE ======================= */
async function gerarComprovante(codigo){
  const {data}=await sb.from("vouchers").select("*").eq("codigo",codigo);
  let v=data[0];

  printContent.innerHTML=`Cliente: ${v.cliente}<br>
        Valor: R$ ${v.valor}<br>
        C√≥digo: ${v.codigo}<br>`;
  printData.innerText=formatarData(v.data_resgate);
  printUser.innerText=v.usuario_resgate;
}

function imprimirComprovante(){
  let janela=window.open("", "","width=260,height=600");
  janela.document.write(printArea.innerHTML);
  janela.print();
  janela.close();
}

/* ====================== UTIL ======================= */
function formatarData(dt){
  let d=new Date(dt); return d.toLocaleString("pt-BR");
}
</script>

</body>
</html>
